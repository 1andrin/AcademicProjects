---
title: "CODE - M&A Activity and Competition Policy: Anaylsis and Implications for Sales Growth"
author: "Andrin Gehrig"
date: "7/18/2022"
output: html_document
editor_options: 
chunk_output_type: inline
---

## REQUIRED LIBRARIES

```{r LIBRARIES}

library(readxl)
library(tidyverse)
library(naniar)
library(dplyr)
library(readr)
library(reshape2)
library(fuzzyjoin)
library(usethis)
library(stringr)
library(randomForest)
library(caret)
library(zoo)
library(lfe)
library(fixest)
library(lme4)
library(rstatix)
library(data.table)
library(hablar)
library(ggplot2)
library(gridExtra)
library(cowplot)
library(scales)
library(xtable)
library(rworldmap)
library(maps)
library(rankdist)

```


## READING THE SOURCE FILES, CREATING THE SDC FIILE WITH CUSIPS

```{r GET DATA}

# REUTERS SDC
SDC <- read.csv("SDC.csv")
SDC$RankDate <- as.Date(SDC$RankDate)
SDC$DateAnnounced <- as.Date(SDC$DateAnnounced)
SDC$DateWithdrawn <- as.Date(SDC$DateWithdrawn)
SDC$DateEffective.Unconditional <- as.Date(SDC$DateEffective.Unconditional)
SDC$DateEffective <- as.Date(SDC$DateEffective)
SDC$TargetCompanyDateofFin. <- as.Date(SDC$TargetCompanyDateofFin.)
SDC$ROWINDEX.sdc <- as.integer(row.names(SDC))


##################################################################################3

cusip_tracker <- read.csv("CUSIP_NEW_OLD.csv")
cusip_tracker<- mutate(cusip_tracker, across(everything(), as.character))
cusip_tracker <- cusip_tracker[,-c(1:8)]
cusip_tracker <- cusip_tracker[,-c(2:4)]
cusip_tracker <- cusip_tracker[,-c(6:7)]
colnames(cusip_tracker) <- c("F.UNK.CUSIP","F.NEW.CUSIP", "F.OLD.CUSIP", "F.TICKER", "F.NAME")
cusip_tracker_6d <- data.frame(cusip_tracker)
cusip_tracker_6d$F.UNK.CUSIP <- substr(cusip_tracker_6d$F.UNK.CUSIP, start = 1, stop = 6)
cusip_tracker_6d$F.NEW.CUSIP <- substr(cusip_tracker_6d$F.NEW.CUSIP, start = 1, stop = 6)
cusip_tracker_6d$F.OLD.CUSIP <- substr(cusip_tracker_6d$F.OLD.CUSIP, start = 1, stop = 6)
cusip_tracker_6d_dist_newcusip <- distinct(cusip_tracker_6d, F.NEW.CUSIP, .keep_all = TRUE)
cusip_tracker_6d_dist_oldcusip <- distinct(cusip_tracker_6d, F.OLD.CUSIP, .keep_all = TRUE)

CUSIP <- read.csv("CUSIP.csv")
CUSIP <- mutate(CUSIP, across(everything(), as.character))


CUSIP_ACQ <-select(CUSIP,AcquirorName,AcquirorCUSIP,AcquirorImmediateParentCUSIP,AcquirorUltimateParentCUSIP)

CUSIP_ACQ <- left_join(CUSIP_ACQ, cusip_tracker_6d_dist_oldcusip[,-c(1,5)], 
                            by = c("AcquirorCUSIP" = "F.OLD.CUSIP"), na_matches = "never")
CUSIP_ACQ <- rename(CUSIP_ACQ, Acq.New.CUSIP = F.NEW.CUSIP, Acq.New.TICKER = F.TICKER)


CUSIP_TAR <- select(CUSIP, TargetName, TargetCUSIP, TargetImmediateParentCUSIP, TargetUltimateParentCUSIP)

CUSIP_TAR <- left_join(CUSIP_TAR, cusip_tracker_6d_dist_oldcusip[,-c(1,5)], 
                            by = c("TargetCUSIP" = "F.OLD.CUSIP"), na_matches = "never")
CUSIP_TAR <- rename(CUSIP_TAR, Tar.New.CUSIP = F.NEW.CUSIP, Tar.New.TICKER = F.TICKER)


CUSIP_FULL <- data.frame(CUSIP_ACQ, CUSIP_TAR)


SDC <- left_join(SDC, CUSIP_FULL, by = c("AcquirorName" = "AcquirorName", "TargetName" = "TargetName"),
                 na_matches = "never")

# SDC URLS

SDC_URLS <- read.csv("SDC_URLS.csv")
SDC_URLS <- SDC_URLS[,-1]

SDC <- left_join(SDC, SDC_URLS, by = c("AcquirorName" = "Name"), na_matches = "never")
SDC <- rename(SDC, AcquirorURL = url)
SDC <- left_join(SDC, SDC_URLS, by = c("TargetName" = "Name"), na_matches = "never")
SDC <- rename(SDC, TargetURL = url)

SDC <- select(SDC, AcquirorName, TargetName, DateEffective, ROWINDEX.sdc,
              AcquirorCUSIP,AcquirorImmediateParentCUSIP,AcquirorUltimateParentCUSIP,
              TargetCUSIP, TargetImmediateParentCUSIP, TargetUltimateParentCUSIP, ValueofTransaction..mil.,
              Acq.New.CUSIP, Acq.New.TICKER, Tar.New.CUSIP, Tar.New.TICKER,
              everything())

#write.csv(SDC, "SDC_FULL.csv")
#write.csv(SDC, "SDC_CUSIP_NAblank.csv")


# COMPUSTAT URLS

COMPUTSTAT_URLS <- read.csv("COMPUTSTAT_URLS.csv")
COMPUTSTAT_URLS <- COMPUTSTAT_URLS[,-1]


# SEC
MAIN <- read.csv("MAIN.csv", header = T, na.strings = c("","NA"))
MAIN$ROWINDEX.main <- row.names(MAIN)

LEFT <- read.csv("LEFT.csv", header = T, na.strings = c("","NA"))

LEFT$ROWINDEX.left <- row.names(LEFT)

STACKMAIN <- select(MAIN, -ROWINDEX.main)
STACKLEFT <- select(LEFT, -ROWINDEX.left)
FIRMS <- rbind(STACKMAIN,STACKLEFT)
FIRMS <- left_join(FIRMS, COMPUTSTAT_URLS, by = "gvkey", na_matches = "never")
FIRMS <- select(FIRMS, -conml.y)
FIRMS <- rename(FIRMS, conml = conml.x)

# CUSIP SALES

SALES <- read.csv("CUSIP_SALES.csv", sep="\t", header=T)

SALESforMatching <- select(SALES, gvkey, conm, cusip, sale, sale_D)

SALESforMatching <- distinct(SALESforMatching, gvkey, .keep_all = TRUE)

SALESforMatching <- left_join(SALESforMatching, FIRMS, by = "gvkey", na_matches = "never")

SALESforMatching <- select(SALESforMatching, -conm.y, -cusip.y)
SALESforMatching <- rename(SALESforMatching, conm = conm.x, cusip = cusip.x)


# URLMATCHES LEFT & MAIN
URLMatchesMAINLEFT <- read.csv("URLMatchesMAINLEFT.csv")
URLMatchesMAINLEFT <- select(URLMatchesMAINLEFT, -X)
URLMatchesMAINLEFT <- rename(URLMatchesMAINLEFT, conml = X0, AcquirorName = X1, MATCHES = X2)

# URLMATCHES LEFT TARGETS
URLMatchesLEFT <- read.csv("URLMatchesLEFT.csv")
URLMatchesLEFT <- select(URLMatchesLEFT, -X)
URLMatchesLEFT <- rename(URLMatchesLEFT, conmlT = X0, TargetName = X1, MATCHES = X2)

# URLMATCHES SALES
URLMatchesSALES <- read.csv("URLMatchesSALES.csv")
URLMatchesSALES <- select(URLMatchesSALES, -X)
URLMatchesSALES <- rename(URLMatchesSALES, conml = X0, AcquirorName = X1, MATCHES = X2)

```


## CREATE MODEL TO PREDICT SALES VALUES BASED ON SDC VALUES

```{r SALES PREDICTION MODEL}

set.seed(8)

SDC_TRAINING <- data.frame(SDC)

names(SDC_TRAINING) <- gsub(".", "", names(SDC_TRAINING), fixed = TRUE)

SDC_TRAINING$YEARef <- substr(SDC_TRAINING$DateEffective, start = 1, stop = 4)
  
SDC_TRAINING <- select(SDC_TRAINING, AcquirorName, AcquirorState, AcquirorNation, AcquirorPrimarySICCode,
                       TargetName, TargetState, TargetNation, TargetPrimarySICCode,
                       TargetNetSalesLTMmil, ValueofTransactionmil, XofSharesAcq, YEARef)

SDC_TRAINING$AcquirorPrimarySICCode <- as.factor(SDC_TRAINING$AcquirorPrimarySICCode)
SDC_TRAINING$AcquirorState <- as.factor(SDC_TRAINING$AcquirorState)
SDC_TRAINING$AcquirorNation <- as.factor(SDC_TRAINING$AcquirorNation)

SDC_TRAINING$TargetPrimarySICCode <- as.factor(SDC_TRAINING$TargetPrimarySICCode)
SDC_TRAINING$TargetState <- as.factor(SDC_TRAINING$TargetState)
SDC_TRAINING$TargetNation <- as.factor(SDC_TRAINING$TargetNation)

SDC_TRAINING <- filter(SDC_TRAINING, !is.na(TargetNetSalesLTMmil) & !is.na(ValueofTransactionmil) & !is.na(XofSharesAcq)
                       & !is.na(YEARef)  & !is.na(AcquirorState)  & !is.na(AcquirorNation)  & !is.na(AcquirorPrimarySICCode) 
                       & !is.na(TargetState)  & !is.na(TargetNation)  & !is.na(TargetPrimarySICCode) )

SDC_TRAINING <- filter(SDC_TRAINING, AcquirorName != TargetName)
SDC_TRAINING <- filter(SDC_TRAINING, AcquirorName != "Investor Group" 
                          & AcquirorName != "Investors"
                          & AcquirorName != "Shareholders"
                          & AcquirorName != "Creditors"
                          & AcquirorName != "Preferred Shareholders" | is.na(AcquirorName))

SDC_TRAINING <- filter(SDC_TRAINING, TargetNetSalesLTMmil >= 0 )

SDC_TRAINING$LOGValueOfTr <- log(SDC_TRAINING$ValueofTransactionmil)
SDC_TRAINING$LOGSales <- log(SDC_TRAINING$TargetNetSalesLTMmil)

### SDC Testset

TestSample <- sample((1:122381), 22381)

SDC_TEST <- SDC_TRAINING[TestSample,]
  
SDC_TRAINING <- SDC_TRAINING[-TestSample,]

SDCSalesFOLS <- with(SDC_TRAINING,
                     feols(LOGSales ~ LOGValueOfTr + XofSharesAcq | TargetState + TargetPrimarySICCode + TargetNation +
                     AcquirorState + AcquirorPrimarySICCode + AcquirorNation + YEARef,
                     data = SDC_TRAINING)    )


summary(SDCSalesFOLS, cluster = ~TargetState)

model.coef <- coef(SDCSalesFOLS)
model.coef


FixefDF <- select(SDC_TRAINING, AcquirorState, AcquirorNation, AcquirorPrimarySICCode, TargetState, TargetNation, TargetPrimarySICCode, YEARef )

PredModelObject <- with(SDC_TRAINING, feols.fit(LOGSales, as.matrix(data.frame(LOGValueOfTr,XofSharesAcq)),  FixefDF  ) )

PredModelObject$ssr

LMM <- with(SDC_TRAINING, lm(LOGSales ~ LOGValueOfTr +  XofSharesAcq, data = SDC_TRAINING) ) 


LMM_NL <- with(SDC_TRAINING, lm(TargetNetSalesLTMmil ~ ValueofTransactionmil +  XofSharesAcq, data = SDC_TRAINING) ) 


par(mfrow = c(2,2))
plot(LMM, pch = 3, cex = 0.1)

### Test

LOGTestResults <- predict(SDCSalesFOLS, newdata = SDC_TEST)
TestResults <- exp(LOGTestResults)

SDC_TEST <- cbind(TestResults,LOGTestResults, SDC_TEST)
SDC_TEST <- select(SDC_TEST, TestResults, TargetNetSalesLTMmil, LOGTestResults, LOGSales,everything())

SDC_TEST$LOGDiff <- SDC_TEST$LOGSales - SDC_TEST$LOGTestResults

SDC_TEST <- select(SDC_TEST, LOGDiff, TestResults, TargetNetSalesLTMmil, LOGTestResults, LOGSales,everything())

mean(na.omit(SDC_TEST$LOGDiff))

median(na.omit(SDC_TEST$LOGDiff))


exp(mean(na.omit(SDC_TEST$LOGDiff)))

exp(median(na.omit(SDC_TEST$LOGDiff)))


### TRAINING

LOGTestResults <- predict(SDCSalesFOLS, newdata = SDC_TRAINING)
TestResults <- exp(LOGTestResults)

SDC_TRAINING <- cbind(TestResults,LOGTestResults, SDC_TRAINING)
SDC_TRAINING <- select(SDC_TRAINING, TestResults, TargetNetSalesLTMmil, LOGTestResults, LOGSales,everything())

SDC_TRAINING$LOGDiff <- SDC_TRAINING$LOGSales - SDC_TRAINING$LOGTestResults

SDC_TRAINING <- select(SDC_TRAINING, LOGDiff, TestResults, TargetNetSalesLTMmil, LOGTestResults, LOGSales,everything())

mean(na.omit(SDC_TRAINING$LOGDiff))

median(na.omit(SDC_TRAINING$LOGDiff))


exp(mean(na.omit(SDC_TRAINING$LOGDiff)))

exp(median(na.omit(SDC_TRAINING$LOGDiff)))


```


## ASSIGN PREDICTED SALES VALUES TO ALL POSSIBLE SDC TRANSACTIONS

```{r GET SDC WITH FULL TARGET SALES}

SDC_TARP <- data.frame(SDC)

names(SDC_TARP) <- gsub(".", "", names(SDC_TARP), fixed = TRUE)

SDC_TARP$YEARef <- substr(SDC_TARP$DateEffective, start = 1, stop = 4)

SDC_TARP$AcquirorPrimarySICCode <- as.factor(SDC_TARP$AcquirorPrimarySICCode)
SDC_TARP$AcquirorState <- as.factor(SDC_TARP$AcquirorState)
SDC_TARP$AcquirorNation <- as.factor(SDC_TARP$AcquirorNation)

SDC_TARP$TargetPrimarySICCode <- as.factor(SDC_TARP$TargetPrimarySICCode)
SDC_TARP$TargetState <- as.factor(SDC_TARP$TargetState)
SDC_TARP$TargetNation <- as.factor(SDC_TARP$TargetNation)


SDC_TARP$LOGValueOfTr <- log(SDC_TARP$ValueofTransactionmil)

P.SDC_TARP <- predict(SDCSalesFOLS, newdata = SDC_TARP)

PredictedSales <- round(exp(P.SDC_TARP), 3)

SDC_TARP <- cbind(SDC_TARP, PredictedSales)

SDC_TARP <- select(SDC_TARP, -LOGValueOfTr)

SDC_TARP$TargetSales <- with(SDC_TARP, ifelse(is.na(TargetNetSalesLTMmil), PredictedSales, TargetNetSalesLTMmil)   )

SDC_TARP <- select(SDC_TARP, AcquirorName, TargetName, ValueofTransactionmil, XofSharesAcq, YEARef, 
                   TargetNetSalesLTMmil, PredictedSales, TargetSales,
                   AcquirorState, AcquirorNation, AcquirorPrimarySICCode, 
                   TargetName, TargetState, TargetNation, TargetPrimarySICCode, everything())

SDC_TARPforMerge <- select(SDC_TARP, PredictedSales, TargetSales, YEARef)

SDC_TARPforMerge$TarpJoin <- seq(1:length(SDC_TARPforMerge$YEARef))

SDC$TarpJoin <- seq(1:length(SDC$AcquirorName))

SDC <- left_join(SDC, SDC_TARPforMerge, by = "TarpJoin" )

SDC <- select(SDC, -TarpJoin)


PredictionCheck <- select(SDC_TRAINING, LOGSales, TargetNetSalesLTMmil)
PredictionCheck$LOGPredSales <- fitted(SDCSalesFOLS)
PredictionCheck$PredSales <- exp(fitted(SDCSalesFOLS))
PredictionCheck <- select(PredictionCheck, LOGSales, LOGPredSales,  TargetNetSalesLTMmil,PredSales )
PredictionCheck$ReDev <- with(PredictionCheck, (TargetNetSalesLTMmil -  PredSales) / TargetNetSalesLTMmil)

with(PredictionCheck, sum(LOGSales - LOGPredSales))

with(PredictionCheck, median(ReDev) ) 
with(PredictionCheck, median(TargetNetSalesLTMmil - PredSales))


```


## MATCHING COMPUSTAT FIRMS WITH SDC TRANSACTIONS

  LINKING ACQUIRORS: BASED ON MAIN & LEFT FILES (FIRMS AS ACQUIRORS)

```{r FIRM MATCHING}

## PRIMARY CUSIP MATCHING

SDC_CUSIP <- data.frame(SDC)
SDC_CUSIP$MATCHCUSIP <- SDC_CUSIP$AcquirorCUSIP

FIRMS_CUSIP <- data.frame(FIRMS)
FIRMS_CUSIP$cusip6D <- substr(FIRMS_CUSIP$cusip, start = 1, stop = 6)
FIRMS_CUSIP$MATCHCUSIP <- FIRMS_CUSIP$cusip6D

MERGED_CUSIP <- inner_join(FIRMS_CUSIP,SDC_CUSIP, by = "MATCHCUSIP", na_matches = "never")

MERGED_CUSIP <- select(MERGED_CUSIP, conml, AcquirorName, TargetName, DateEffective, everything())

MERGED_CUSIP <- arrange(MERGED_CUSIP, conml, DateEffective)

MERGED_CUSIP$COMP_SDC_ACQ <- str_replace_all(toupper(MERGED_CUSIP$AcquirorName),"[^[:alnum:]]", "")
MERGED_CUSIP$COMP_MAIN_ACQ <- str_replace_all(toupper(MERGED_CUSIP$conml),"[^[:alnum:]]", "")

MERGED_CUSIP$StringDistance <- 0

for (i in (1:length(MERGED_CUSIP$COMP_MAIN_ACQ))) {
MERGED_CUSIP$StringDistance[i] <- adist(MERGED_CUSIP$COMP_SDC_ACQ[i], MERGED_CUSIP$COMP_MAIN_ACQ[i])
}

MERGED_CUSIP <- select(MERGED_CUSIP, conml, AcquirorName, StringDistance, TargetName, everything())

MERGED_CUSIP$METHOD <- "CUSIP"

n_distinct(MERGED_CUSIP$conml)

##############################################################################################3
##############################################################################################3
##############################################################################################3

## NEW UPDATED CUSIP MATCHING

SDC_NEW_CUSIP <- data.frame(SDC)
FIRMS_NEW_CUSIP <- data.frame(FIRMS)
FIRMS_NEW_CUSIP$cusip6D <- substr(FIRMS_NEW_CUSIP$cusip, start = 1, stop = 6)

FIRMS_NEW_CUSIP$MATCHCUSIP <- FIRMS_NEW_CUSIP$cusip6D
SDC_NEW_CUSIP$MATCHCUSIP <- SDC_NEW_CUSIP$Acq.New.CUSIP

MERGED_NEW_CUSIP <- inner_join(FIRMS_NEW_CUSIP,SDC_NEW_CUSIP, by = "MATCHCUSIP", na_matches = "never")

MERGED_NEW_CUSIP <- select(MERGED_NEW_CUSIP, conml, AcquirorName, TargetName, DateEffective, everything())

MERGED_NEW_CUSIP <- arrange(MERGED_NEW_CUSIP, conml, DateEffective)

MERGED_NEW_CUSIP$COMP_SDC_ACQ <- str_replace_all(toupper(MERGED_NEW_CUSIP$AcquirorName),"[^[:alnum:]]", "")
MERGED_NEW_CUSIP$COMP_MAIN_ACQ <- str_replace_all(toupper(MERGED_NEW_CUSIP$conml),"[^[:alnum:]]", "")

MERGED_NEW_CUSIP$StringDistance <- 0

for (i in (1:length(MERGED_NEW_CUSIP$COMP_MAIN_ACQ))) {
MERGED_NEW_CUSIP$StringDistance[i] <- adist(MERGED_NEW_CUSIP$COMP_SDC_ACQ[i], MERGED_NEW_CUSIP$COMP_MAIN_ACQ[i])
}

MERGED_NEW_CUSIP <- select(MERGED_NEW_CUSIP, conml, AcquirorName, StringDistance, TargetName, everything())

MERGED_NEW_CUSIP$METHOD <- "NewCUSIP"

n_distinct(MERGED_NEW_CUSIP$conml)

##############################################################################################3
##############################################################################################3
##############################################################################################3

## IMMEDIATE PARENT CUSIP MATCHING

SDC_IMMED_CUSIP <- data.frame(SDC)
FIRMS_IMMED_CUSIP <- data.frame(FIRMS)
FIRMS_IMMED_CUSIP$cusip6D <- substr(FIRMS_IMMED_CUSIP$cusip, start = 1, stop = 6)

FIRMS_IMMED_CUSIP$MATCHCUSIP <- FIRMS_IMMED_CUSIP$cusip6D
SDC_IMMED_CUSIP$MATCHCUSIP <- SDC_IMMED_CUSIP$AcquirorImmediateParentCUSIP

MERGED_IMMED_CUSIP <- inner_join(FIRMS_IMMED_CUSIP,SDC_IMMED_CUSIP, by = "MATCHCUSIP", na_matches = "never")

MERGED_IMMED_CUSIP <- select(MERGED_IMMED_CUSIP, conml, AcquirorName, TargetName, DateEffective, everything())

MERGED_IMMED_CUSIP <- arrange(MERGED_IMMED_CUSIP, conml, DateEffective)

MERGED_IMMED_CUSIP$COMP_SDC_ACQ <- str_replace_all(toupper(MERGED_IMMED_CUSIP$AcquirorName),"[^[:alnum:]]", "")
MERGED_IMMED_CUSIP$COMP_MAIN_ACQ <- str_replace_all(toupper(MERGED_IMMED_CUSIP$conml),"[^[:alnum:]]", "")

MERGED_IMMED_CUSIP$StringDistance <- 0

for (i in (1:length(MERGED_IMMED_CUSIP$COMP_MAIN_ACQ))) {
MERGED_IMMED_CUSIP$StringDistance[i] <- adist(MERGED_IMMED_CUSIP$COMP_SDC_ACQ[i], MERGED_IMMED_CUSIP$COMP_MAIN_ACQ[i])
}

MERGED_IMMED_CUSIP <- select(MERGED_IMMED_CUSIP, conml, AcquirorName, StringDistance, TargetName, everything())

MERGED_IMMED_CUSIP$METHOD <- "ImmediateParentCUSIP"

n_distinct(MERGED_IMMED_CUSIP$conml)

##############################################################################################3
##############################################################################################3
##############################################################################################3

## ULTIMATE PARENT CUSIP MATCHING

SDC_ULTIMATE_CUSIP <- data.frame(SDC)
FIRMS_ULTIMATE_CUSIP <- data.frame(FIRMS)
FIRMS_ULTIMATE_CUSIP$cusip6D <- substr(FIRMS_ULTIMATE_CUSIP$cusip, start = 1, stop = 6)

FIRMS_ULTIMATE_CUSIP$MATCHCUSIP <- FIRMS_ULTIMATE_CUSIP$cusip6D
SDC_ULTIMATE_CUSIP$MATCHCUSIP <- SDC_ULTIMATE_CUSIP$AcquirorUltimateParentCUSIP

MERGED_ULTIMATE_CUSIP <- inner_join(FIRMS_ULTIMATE_CUSIP,SDC_ULTIMATE_CUSIP, by = "MATCHCUSIP", na_matches = "never")

MERGED_ULTIMATE_CUSIP <- select(MERGED_ULTIMATE_CUSIP, conml, AcquirorName, TargetName, DateEffective, everything())

MERGED_ULTIMATE_CUSIP <- arrange(MERGED_ULTIMATE_CUSIP, conml, DateEffective)

MERGED_ULTIMATE_CUSIP$COMP_SDC_ACQ <- str_replace_all(toupper(MERGED_ULTIMATE_CUSIP$AcquirorName),"[^[:alnum:]]", "")
MERGED_ULTIMATE_CUSIP$COMP_MAIN_ACQ <- str_replace_all(toupper(MERGED_ULTIMATE_CUSIP$conml),"[^[:alnum:]]", "")

MERGED_ULTIMATE_CUSIP$StringDistance <- 0

for (i in (1:length(MERGED_ULTIMATE_CUSIP$COMP_MAIN_ACQ))) {
MERGED_ULTIMATE_CUSIP$StringDistance[i] <- adist(MERGED_ULTIMATE_CUSIP$COMP_SDC_ACQ[i], MERGED_ULTIMATE_CUSIP$COMP_MAIN_ACQ[i])
}

MERGED_ULTIMATE_CUSIP <- select(MERGED_ULTIMATE_CUSIP, conml, AcquirorName, StringDistance, TargetName, everything())

MERGED_ULTIMATE_CUSIP$METHOD <- "UltimateParentCUSIP"

n_distinct(MERGED_ULTIMATE_CUSIP$conml)

##############################################################################################3
##############################################################################################3
##############################################################################################3

## NAME MATCHING

SDC_for_NAME <- data.frame(SDC)
FIRMS_for_NAME <- data.frame(FIRMS)

SDC_for_NAME$AC_NAME <- SDC_for_NAME$AcquirorName
FIRMS_for_NAME$AC_NAME <- FIRMS_for_NAME$conml

SDC_for_NAME$AC_NAME <- toupper(SDC_for_NAME$AC_NAME)
FIRMS_for_NAME$AC_NAME <- toupper(FIRMS_for_NAME$AC_NAME)

SDC_for_NAME$AC_NAME <- str_replace_all(SDC_for_NAME$AC_NAME, "[^[:alnum:]]", "")
FIRMS_for_NAME$AC_NAME <- str_replace_all(FIRMS_for_NAME$AC_NAME, "[^[:alnum:]]", "")
  
MERGED_NAME <- inner_join(FIRMS_for_NAME,SDC_for_NAME, by = "AC_NAME", na_matches = "never")

MERGED_NAME <- select(MERGED_NAME, conml, AcquirorName, TargetName, DateEffective, everything())

MERGED_NAME <- arrange(MERGED_NAME, conml, DateEffective)

MERGED_NAME$COMP_SDC_ACQ <- str_replace_all(toupper(MERGED_NAME$AcquirorName),"[^[:alnum:]]", "")
MERGED_NAME$COMP_MAIN_ACQ <- str_replace_all(toupper(MERGED_NAME$conml),"[^[:alnum:]]", "")

MERGED_NAME$StringDistance <- 0

for (i in (1:length(MERGED_NAME$COMP_MAIN_ACQ))) {
MERGED_NAME$StringDistance[i] <- adist(MERGED_NAME$COMP_SDC_ACQ[i],MERGED_NAME$COMP_MAIN_ACQ[i])
}

MERGED_NAME <- select(MERGED_NAME, conml, AcquirorName, StringDistance, TargetName, everything())

MERGED_NAME$METHOD <- "Name"

n_distinct(MERGED_NAME$conml)


##############################################################################################3
##############################################################################################3
##############################################################################################3

## TICKER MATCHING

SDC_for_TIC <- data.frame(SDC)
FIRMS_for_TIC <- data.frame(FIRMS)

SDC_for_TIC$TICMATCH <- SDC_for_TIC$AcquirorPrimaryTickerSymbol
FIRMS_for_TIC$TICMATCH <- FIRMS_for_TIC$tic

MERGED_TIC <- inner_join(FIRMS_for_TIC,SDC_for_TIC, by = "TICMATCH", na_matches = "never")

MERGED_TIC <- select(MERGED_TIC, conml, AcquirorName, TargetName, DateEffective, everything())

MERGED_TIC <- arrange(MERGED_TIC, conml, DateEffective)

MERGED_TIC$COMP_SDC_ACQ <- str_replace_all(toupper(MERGED_TIC$AcquirorName),"[^[:alnum:]]", "")

MERGED_TIC$COMP_MAIN_ACQ <- str_replace_all(toupper(MERGED_TIC$conml),"[^[:alnum:]]", "")

MERGED_TIC$StringDistance <- 0

for (i in (1:length(MERGED_TIC$COMP_MAIN_ACQ))) {
  
MERGED_TIC$StringDistance[i] <- adist(MERGED_TIC$COMP_SDC_ACQ[i],MERGED_TIC$COMP_MAIN_ACQ[i])

}

MERGED_TIC <- select(MERGED_TIC, conml, AcquirorName, StringDistance, TargetName, everything())

MERGED_TIC$METHOD <- "Ticker"

n_distinct(MERGED_TIC$conml)


##############################################################################################3
##############################################################################################3
##############################################################################################3

## PARENT'S TICKER MATCHING

SDC_for_PARENTTIC <- data.frame(SDC)
FIRMS_for_PAERNTTIC <- data.frame(FIRMS)

SDC_for_PARENTTIC$TICMATCH <- SDC_for_PARENTTIC$AcquirorUltimateParentPrimaryTickerSymbol
FIRMS_for_PAERNTTIC$TICMATCH <- FIRMS_for_PAERNTTIC$tic

MERGED_PARENTIC <- inner_join(FIRMS_for_PAERNTTIC, SDC_for_PARENTTIC, by = "TICMATCH", na_matches = "never")

MERGED_PARENTIC <- select(MERGED_PARENTIC, conml, AcquirorName, TargetName, DateEffective, everything())

MERGED_PARENTIC <- arrange(MERGED_PARENTIC, conml, DateEffective)

MERGED_PARENTIC$COMP_SDC_ACQ <- str_replace_all(toupper(MERGED_PARENTIC$AcquirorName),"[^[:alnum:]]", "")

MERGED_PARENTIC$COMP_MAIN_ACQ <- str_replace_all(toupper(MERGED_PARENTIC$conml),"[^[:alnum:]]", "")

MERGED_PARENTIC$StringDistance <- 0

for (i in (1:length(MERGED_PARENTIC$COMP_MAIN_ACQ))) {
  
MERGED_PARENTIC$StringDistance[i] <- adist(MERGED_PARENTIC$COMP_SDC_ACQ[i],MERGED_PARENTIC$COMP_MAIN_ACQ[i])

}

MERGED_PARENTIC <- select(MERGED_PARENTIC, conml, AcquirorName, StringDistance, TargetName, everything())

MERGED_PARENTIC$METHOD <- "ParentTicker"

n_distinct(MERGED_PARENTIC$conml)

##############################################################################################3
##############################################################################################3
##############################################################################################3

## NEW UPDATED TICKER MATCHING

SDC_for_NEWTIC <- data.frame(SDC)
FIRMS_for_NEWTIC <- data.frame(FIRMS)

SDC_for_NEWTIC$TICMATCH <- SDC_for_NEWTIC$Acq.New.TICKER
FIRMS_for_NEWTIC$TICMATCH <- FIRMS_for_NEWTIC$tic

MERGED_NEWTIC <- inner_join(FIRMS_for_NEWTIC, SDC_for_NEWTIC, by = "TICMATCH", na_matches = "never")

MERGED_NEWTIC <- select(MERGED_NEWTIC, conml, AcquirorName, TargetName, DateEffective, everything())

MERGED_NEWTIC <- arrange(MERGED_NEWTIC, conml, DateEffective)

MERGED_NEWTIC$COMP_SDC_ACQ <- str_replace_all(toupper(MERGED_NEWTIC$AcquirorName),"[^[:alnum:]]", "")

MERGED_NEWTIC$COMP_MAIN_ACQ <- str_replace_all(toupper(MERGED_NEWTIC$conml),"[^[:alnum:]]", "")

MERGED_NEWTIC$StringDistance <- 0

for (i in (1:length(MERGED_NEWTIC$COMP_MAIN_ACQ))) {
  
MERGED_NEWTIC$StringDistance[i] <- adist(MERGED_NEWTIC$COMP_SDC_ACQ[i],MERGED_NEWTIC$COMP_MAIN_ACQ[i])

}

MERGED_NEWTIC <- select(MERGED_NEWTIC, conml, AcquirorName, StringDistance, TargetName, everything())

MERGED_NEWTIC$METHOD <- "NewTicker"

n_distinct(MERGED_NEWTIC$conml)


##############################################################################################3
##############################################################################################3
##############################################################################################3

## CREATING R DATA FRAME FROM URL MATCHES (MATCHES IMPORTED FROM PYTHON)

URLtoMATCH <- data.frame(URLMatchesMAINLEFT)
SDCURLMerge <- data.frame(SDC)

SDC_MERGE_URL <- left_join(URLtoMATCH, SDCURLMerge, by = "AcquirorName")

MERGED_URL <- left_join(SDC_MERGE_URL, FIRMS, by = "conml")

MERGED_URL <- select(MERGED_URL, conml, AcquirorName, TargetName, DateEffective, everything())

MERGED_URL <- arrange(MERGED_URL, conml, DateEffective)

MERGED_URL$COMP_SDC_ACQ <- str_replace_all(toupper(MERGED_URL$AcquirorName),"[^[:alnum:]]", "")

MERGED_URL$COMP_MAIN_ACQ <- str_replace_all(toupper(MERGED_URL$conml),"[^[:alnum:]]", "")

MERGED_URL$StringDistance <- 0

for (i in (1:length(MERGED_URL$COMP_MAIN_ACQ))) {
  
MERGED_URL$StringDistance[i] <- adist(MERGED_URL$COMP_SDC_ACQ[i],MERGED_URL$COMP_MAIN_ACQ[i])

}

MERGED_URL <- select(MERGED_URL, conml, AcquirorName, StringDistance, TargetName, everything())

MERGED_URL$METHOD <- "URLs"


n_distinct(MERGED_URL$conml)

```


  -> STACKING  MATCHES ON TOP OF EACHOTHER AND ASSIGNING URL SIMILARITY

```{r FILE: FIRM Matches}

M_CUSIP <- select(MERGED_CUSIP, -c(cusip6D,MATCHCUSIP))
M_NEWCUSIP <- select(MERGED_NEW_CUSIP, -c(cusip6D,MATCHCUSIP))
M_ULTIMATE_CUSIP <- select(MERGED_ULTIMATE_CUSIP, -c(cusip6D,MATCHCUSIP))
M_IMMED_CUSIP <- select(MERGED_IMMED_CUSIP, -c(cusip6D,MATCHCUSIP))
M_NAME <- select(MERGED_NAME, -c(AC_NAME))
M_TIC <- select(MERGED_TIC, -c(TICMATCH))
M_PARENTIC <- select(MERGED_PARENTIC, -c(TICMATCH))
M_NEWTIC <- select(MERGED_NEWTIC, -c(TICMATCH))
M_URL <- select(MERGED_URL, -c(MATCHES))
M_URL <- M_URL[names(M_NEWTIC)]


for (i in (1:length(colnames(M_URL)))) {
ifelse(colnames(M_URL)[i]==colnames(M_NEWCUSIP)[i], FALSE,print(paste(colnames(M_URL)[i], " ",i, " ",colnames(M_NEWCUSIP)[i])))
}

FIRM_MATCHES <- rbind(M_CUSIP,M_NEWCUSIP,M_IMMED_CUSIP,M_ULTIMATE_CUSIP, M_NAME,M_TIC,M_PARENTIC,M_NEWTIC , M_URL)

FIRM_MATCHES <- select(FIRM_MATCHES, ROWINDEX.sdc, conml, AcquirorName, StringDistance, METHOD, TargetName, everything())

n_distinct(FIRM_MATCHES$conml)

#write.csv(FIRM_MATCHES, "FirmMatches_UNFILTERED.csv")
#write.csv(FIRM_MATCHES, "FirmMatches_UNFILTERED_NABlank.csv", na = "")

FIRM_MATCHES_UNFILTERED <- data.frame(FIRM_MATCHES)
FIRM_MATCHES_UNFILTEREDview <- filter(FIRM_MATCHES_UNFILTERED, conml == "")

FIRM_MATCHES <- filter(FIRM_MATCHES, !duplicated(ROWINDEX.sdc))


##############################################################################################3
##############################################################################################3
##############################################################################################3
# ADD URLS

FIRM_MATCHES$URLMATCH <- NA

for (i in (1:length(FIRM_MATCHES$url))) {
  
spliturlx <- strsplit(as.character( FIRM_MATCHES$url[i] ), ",")[[1]] 

spliturly <- strsplit( as.character( FIRM_MATCHES$AcquirorURL[i]), ",")[[1]]

intersection <- intersect(spliturlx,spliturly)

FIRM_MATCHES$URLMATCH[i] <- length(intersection)
}

FIRM_MATCHES <- select(FIRM_MATCHES, ROWINDEX.sdc, conml, AcquirorName, URLMATCH, METHOD, TargetName, everything())


#write.csv(FIRM_MATCHES, "MatchesMLFirms.csv")
#write.csv(FIRM_MATCHES, "MatchesMLFirms_NABlank.csv", na="")

n_distinct(FIRM_MATCHES$conml)
n_distinct(FIRMS$conml)


```


  LINKING ACQUIRORS: BASED ON SALES/CUSIP FILE (FIRMS AS ACQUIRORS)

```{r SALES/CUSIP MATCHING}

## PRIMARY CUSIP MATCHING

SDC_CUSIP <- data.frame(SDC)
SDC_CUSIP$MATCHCUSIP <- SDC_CUSIP$AcquirorCUSIP

FIRMS_CUSIP <- data.frame(SALESforMatching)
FIRMS_CUSIP$cusip6D <- substr(FIRMS_CUSIP$cusip, start = 1, stop = 6)
FIRMS_CUSIP$MATCHCUSIP <- FIRMS_CUSIP$cusip6D

MERGED_CUSIP <- inner_join(FIRMS_CUSIP,SDC_CUSIP, by = "MATCHCUSIP", na_matches = "never")

MERGED_CUSIP <- select(MERGED_CUSIP, conml, AcquirorName, TargetName, DateEffective, everything())

MERGED_CUSIP <- arrange(MERGED_CUSIP, conml, DateEffective)

MERGED_CUSIP$COMP_SDC_ACQ <- str_replace_all(toupper(MERGED_CUSIP$AcquirorName),"[^[:alnum:]]", "")
MERGED_CUSIP$COMP_MAIN_ACQ <- str_replace_all(toupper(MERGED_CUSIP$conml),"[^[:alnum:]]", "")

MERGED_CUSIP$StringDistance <- 0

for (i in (1:length(MERGED_CUSIP$COMP_MAIN_ACQ))) {
MERGED_CUSIP$StringDistance[i] <- adist(MERGED_CUSIP$COMP_SDC_ACQ[i], MERGED_CUSIP$COMP_MAIN_ACQ[i])
}

MERGED_CUSIP <- select(MERGED_CUSIP, conml, AcquirorName, StringDistance, TargetName, everything())

MERGED_CUSIP$METHOD <- "CUSIP"

n_distinct(MERGED_CUSIP$conml)

##############################################################################################3
##############################################################################################3
##############################################################################################3

## NEW UPDATED CUSIP MATCHING

SDC_NEW_CUSIP <- data.frame(SDC)
FIRMS_NEW_CUSIP <- data.frame(SALESforMatching)
FIRMS_NEW_CUSIP$cusip6D <- substr(FIRMS_NEW_CUSIP$cusip, start = 1, stop = 6)

FIRMS_NEW_CUSIP$MATCHCUSIP <- FIRMS_NEW_CUSIP$cusip6D
SDC_NEW_CUSIP$MATCHCUSIP <- SDC_NEW_CUSIP$Acq.New.CUSIP

MERGED_NEW_CUSIP <- inner_join(FIRMS_NEW_CUSIP,SDC_NEW_CUSIP, by = "MATCHCUSIP", na_matches = "never")

MERGED_NEW_CUSIP <- select(MERGED_NEW_CUSIP, conml, AcquirorName, TargetName, DateEffective, everything())

MERGED_NEW_CUSIP <- arrange(MERGED_NEW_CUSIP, conml, DateEffective)

MERGED_NEW_CUSIP$COMP_SDC_ACQ <- str_replace_all(toupper(MERGED_NEW_CUSIP$AcquirorName),"[^[:alnum:]]", "")
MERGED_NEW_CUSIP$COMP_MAIN_ACQ <- str_replace_all(toupper(MERGED_NEW_CUSIP$conml),"[^[:alnum:]]", "")

MERGED_NEW_CUSIP$StringDistance <- 0

for (i in (1:length(MERGED_NEW_CUSIP$COMP_MAIN_ACQ))) {
MERGED_NEW_CUSIP$StringDistance[i] <- adist(MERGED_NEW_CUSIP$COMP_SDC_ACQ[i], MERGED_NEW_CUSIP$COMP_MAIN_ACQ[i])
}

MERGED_NEW_CUSIP <- select(MERGED_NEW_CUSIP, conml, AcquirorName, StringDistance, TargetName, everything())

MERGED_NEW_CUSIP$METHOD <- "NewCUSIP"

n_distinct(MERGED_NEW_CUSIP$conml)

##############################################################################################3
##############################################################################################3
##############################################################################################3

## IMMEDIATE PARENT CUSIP MATCHING

SDC_IMMED_CUSIP <- data.frame(SDC)
FIRMS_IMMED_CUSIP <- data.frame(SALESforMatching)
FIRMS_IMMED_CUSIP$cusip6D <- substr(FIRMS_IMMED_CUSIP$cusip, start = 1, stop = 6)

FIRMS_IMMED_CUSIP$MATCHCUSIP <- FIRMS_IMMED_CUSIP$cusip6D
SDC_IMMED_CUSIP$MATCHCUSIP <- SDC_IMMED_CUSIP$AcquirorImmediateParentCUSIP

MERGED_IMMED_CUSIP <- inner_join(FIRMS_IMMED_CUSIP,SDC_IMMED_CUSIP, by = "MATCHCUSIP", na_matches = "never")

MERGED_IMMED_CUSIP <- select(MERGED_IMMED_CUSIP, conml, AcquirorName, TargetName, DateEffective, everything())

MERGED_IMMED_CUSIP <- arrange(MERGED_IMMED_CUSIP, conml, DateEffective)

MERGED_IMMED_CUSIP$COMP_SDC_ACQ <- str_replace_all(toupper(MERGED_IMMED_CUSIP$AcquirorName),"[^[:alnum:]]", "")
MERGED_IMMED_CUSIP$COMP_MAIN_ACQ <- str_replace_all(toupper(MERGED_IMMED_CUSIP$conml),"[^[:alnum:]]", "")

MERGED_IMMED_CUSIP$StringDistance <- 0

for (i in (1:length(MERGED_IMMED_CUSIP$COMP_MAIN_ACQ))) {
MERGED_IMMED_CUSIP$StringDistance[i] <- adist(MERGED_IMMED_CUSIP$COMP_SDC_ACQ[i], MERGED_IMMED_CUSIP$COMP_MAIN_ACQ[i])
}

MERGED_IMMED_CUSIP <- select(MERGED_IMMED_CUSIP, conml, AcquirorName, StringDistance, TargetName, everything())

MERGED_IMMED_CUSIP$METHOD <- "ImmediateParentCUSIP"

n_distinct(MERGED_IMMED_CUSIP$conml)

##############################################################################################3
##############################################################################################3
##############################################################################################3

## ULTIMATE PARENT CUSIP MATCHING

SDC_ULTIMATE_CUSIP <- data.frame(SDC)
FIRMS_ULTIMATE_CUSIP <- data.frame(SALESforMatching)
FIRMS_ULTIMATE_CUSIP$cusip6D <- substr(FIRMS_ULTIMATE_CUSIP$cusip, start = 1, stop = 6)

FIRMS_ULTIMATE_CUSIP$MATCHCUSIP <- FIRMS_ULTIMATE_CUSIP$cusip6D
SDC_ULTIMATE_CUSIP$MATCHCUSIP <- SDC_ULTIMATE_CUSIP$AcquirorUltimateParentCUSIP

MERGED_ULTIMATE_CUSIP <- inner_join(FIRMS_ULTIMATE_CUSIP,SDC_ULTIMATE_CUSIP, by = "MATCHCUSIP", na_matches = "never")

MERGED_ULTIMATE_CUSIP <- select(MERGED_ULTIMATE_CUSIP, conml, AcquirorName, TargetName, DateEffective, everything())

MERGED_ULTIMATE_CUSIP <- arrange(MERGED_ULTIMATE_CUSIP, conml, DateEffective)

MERGED_ULTIMATE_CUSIP$COMP_SDC_ACQ <- str_replace_all(toupper(MERGED_ULTIMATE_CUSIP$AcquirorName),"[^[:alnum:]]", "")
MERGED_ULTIMATE_CUSIP$COMP_MAIN_ACQ <- str_replace_all(toupper(MERGED_ULTIMATE_CUSIP$conml),"[^[:alnum:]]", "")

MERGED_ULTIMATE_CUSIP$StringDistance <- 0

for (i in (1:length(MERGED_ULTIMATE_CUSIP$COMP_MAIN_ACQ))) {
MERGED_ULTIMATE_CUSIP$StringDistance[i] <- adist(MERGED_ULTIMATE_CUSIP$COMP_SDC_ACQ[i], MERGED_ULTIMATE_CUSIP$COMP_MAIN_ACQ[i])
}

MERGED_ULTIMATE_CUSIP <- select(MERGED_ULTIMATE_CUSIP, conml, AcquirorName, StringDistance, TargetName, everything())

MERGED_ULTIMATE_CUSIP$METHOD <- "UltimateParentCUSIP"

n_distinct(MERGED_ULTIMATE_CUSIP$conml)

##############################################################################################3
##############################################################################################3
##############################################################################################3

## NAME MATCHING

SDC_for_NAME <- data.frame(SDC)
FIRMS_for_NAME <- data.frame(SALESforMatching)

SDC_for_NAME$AC_NAME <- SDC_for_NAME$AcquirorName
FIRMS_for_NAME$AC_NAME <- FIRMS_for_NAME$conml

SDC_for_NAME$AC_NAME <- toupper(SDC_for_NAME$AC_NAME)
FIRMS_for_NAME$AC_NAME <- toupper(FIRMS_for_NAME$AC_NAME)

SDC_for_NAME$AC_NAME <- str_replace_all(SDC_for_NAME$AC_NAME, "[^[:alnum:]]", "")
FIRMS_for_NAME$AC_NAME <- str_replace_all(FIRMS_for_NAME$AC_NAME, "[^[:alnum:]]", "")
  
MERGED_NAME <- inner_join(FIRMS_for_NAME,SDC_for_NAME, by = "AC_NAME", na_matches = "never")

MERGED_NAME <- select(MERGED_NAME, conml, AcquirorName, TargetName, DateEffective, everything())

MERGED_NAME <- arrange(MERGED_NAME, conml, DateEffective)

MERGED_NAME$COMP_SDC_ACQ <- str_replace_all(toupper(MERGED_NAME$AcquirorName),"[^[:alnum:]]", "")
MERGED_NAME$COMP_MAIN_ACQ <- str_replace_all(toupper(MERGED_NAME$conml),"[^[:alnum:]]", "")

MERGED_NAME$StringDistance <- 0

for (i in (1:length(MERGED_NAME$COMP_MAIN_ACQ))) {
MERGED_NAME$StringDistance[i] <- adist(MERGED_NAME$COMP_SDC_ACQ[i],MERGED_NAME$COMP_MAIN_ACQ[i])
}

MERGED_NAME <- select(MERGED_NAME, conml, AcquirorName, StringDistance, TargetName, everything())

MERGED_NAME$METHOD <- "Name"

n_distinct(MERGED_NAME$conml)


##############################################################################################3
##############################################################################################3
##############################################################################################3

## TICKER MATCHING

SDC_for_TIC <- data.frame(SDC)
FIRMS_for_TIC <- data.frame(SALESforMatching)

SDC_for_TIC$TICMATCH <- SDC_for_TIC$AcquirorPrimaryTickerSymbol
FIRMS_for_TIC$TICMATCH <- FIRMS_for_TIC$tic

MERGED_TIC <- inner_join(FIRMS_for_TIC,SDC_for_TIC, by = "TICMATCH", na_matches = "never")

MERGED_TIC <- select(MERGED_TIC, conml, AcquirorName, TargetName, DateEffective, everything())

MERGED_TIC <- arrange(MERGED_TIC, conml, DateEffective)

MERGED_TIC$COMP_SDC_ACQ <- str_replace_all(toupper(MERGED_TIC$AcquirorName),"[^[:alnum:]]", "")

MERGED_TIC$COMP_MAIN_ACQ <- str_replace_all(toupper(MERGED_TIC$conml),"[^[:alnum:]]", "")

MERGED_TIC$StringDistance <- 0

for (i in (1:length(MERGED_TIC$COMP_MAIN_ACQ))) {
  
MERGED_TIC$StringDistance[i] <- adist(MERGED_TIC$COMP_SDC_ACQ[i],MERGED_TIC$COMP_MAIN_ACQ[i])

}

MERGED_TIC <- select(MERGED_TIC, conml, AcquirorName, StringDistance, TargetName, everything())

MERGED_TIC$METHOD <- "Ticker"

n_distinct(MERGED_TIC$conml)


lokup <- select(MERGED_TIC, AcquirorName, TICMATCH)


##############################################################################################3
##############################################################################################3
##############################################################################################3

## PARENT'S TICKER MATCHING

SDC_for_PARENTTIC <- data.frame(SDC)
FIRMS_for_PAERNTTIC <- data.frame(SALESforMatching)

SDC_for_PARENTTIC$TICMATCH <- SDC_for_PARENTTIC$AcquirorUltimateParentPrimaryTickerSymbol
FIRMS_for_PAERNTTIC$TICMATCH <- FIRMS_for_PAERNTTIC$tic

MERGED_PARENTIC <- inner_join(FIRMS_for_PAERNTTIC, SDC_for_PARENTTIC, by = "TICMATCH", na_matches = "never")

MERGED_PARENTIC <- select(MERGED_PARENTIC, conml, AcquirorName, TargetName, DateEffective, everything())

MERGED_PARENTIC <- arrange(MERGED_PARENTIC, conml, DateEffective)

MERGED_PARENTIC$COMP_SDC_ACQ <- str_replace_all(toupper(MERGED_PARENTIC$AcquirorName),"[^[:alnum:]]", "")

MERGED_PARENTIC$COMP_MAIN_ACQ <- str_replace_all(toupper(MERGED_PARENTIC$conml),"[^[:alnum:]]", "")

MERGED_PARENTIC$StringDistance <- 0

for (i in (1:length(MERGED_PARENTIC$COMP_MAIN_ACQ))) {
  
MERGED_PARENTIC$StringDistance[i] <- adist(MERGED_PARENTIC$COMP_SDC_ACQ[i],MERGED_PARENTIC$COMP_MAIN_ACQ[i])

}

MERGED_PARENTIC <- select(MERGED_PARENTIC, conml, AcquirorName, StringDistance, TargetName, everything())

MERGED_PARENTIC$METHOD <- "ParentTicker"

n_distinct(MERGED_PARENTIC$conml)

##############################################################################################3
##############################################################################################3
##############################################################################################3

## NEW UPDATED TICKER MATCHING

SDC_for_NEWTIC <- data.frame(SDC)
FIRMS_for_NEWTIC <- data.frame(SALESforMatching)

SDC_for_NEWTIC$TICMATCH <- SDC_for_NEWTIC$Acq.New.TICKER
FIRMS_for_NEWTIC$TICMATCH <- FIRMS_for_NEWTIC$tic

MERGED_NEWTIC <- inner_join(FIRMS_for_NEWTIC, SDC_for_NEWTIC, by = "TICMATCH", na_matches = "never")

MERGED_NEWTIC <- select(MERGED_NEWTIC, conml, AcquirorName, TargetName, DateEffective, everything())

MERGED_NEWTIC <- arrange(MERGED_NEWTIC, conml, DateEffective)

MERGED_NEWTIC$COMP_SDC_ACQ <- str_replace_all(toupper(MERGED_NEWTIC$AcquirorName),"[^[:alnum:]]", "")

MERGED_NEWTIC$COMP_MAIN_ACQ <- str_replace_all(toupper(MERGED_NEWTIC$conml),"[^[:alnum:]]", "")

MERGED_NEWTIC$StringDistance <- 0

for (i in (1:length(MERGED_NEWTIC$COMP_MAIN_ACQ))) {
  
MERGED_NEWTIC$StringDistance[i] <- adist(MERGED_NEWTIC$COMP_SDC_ACQ[i],MERGED_NEWTIC$COMP_MAIN_ACQ[i])

}

MERGED_NEWTIC <- select(MERGED_NEWTIC, conml, AcquirorName, StringDistance, TargetName, everything())

MERGED_NEWTIC$METHOD <- "NewTicker"

n_distinct(MERGED_NEWTIC$conml)


##############################################################################################3
##############################################################################################3
##############################################################################################3

## CREATING R DATA FRAME FROM URL MATCHES (MATCHES IMPORTED FROM PYTHON)

URLtoMATCH <- data.frame(URLMatchesSALES)
SDCURLMerge <- data.frame(SDC)

SDC_MERGE_URL <- left_join(URLtoMATCH, SDCURLMerge, by = "AcquirorName")

MERGED_URL <- left_join(SDC_MERGE_URL, SALESforMatching, by = "conml")

MERGED_URL <- select(MERGED_URL, conml, AcquirorName, TargetName, DateEffective, everything())

MERGED_URL <- arrange(MERGED_URL, conml, DateEffective)

MERGED_URL$COMP_SDC_ACQ <- str_replace_all(toupper(MERGED_URL$AcquirorName),"[^[:alnum:]]", "")

MERGED_URL$COMP_MAIN_ACQ <- str_replace_all(toupper(MERGED_URL$conml),"[^[:alnum:]]", "")

MERGED_URL$StringDistance <- 0

for (i in (1:length(MERGED_URL$COMP_MAIN_ACQ))) {
  
MERGED_URL$StringDistance[i] <- adist(MERGED_URL$COMP_SDC_ACQ[i],MERGED_URL$COMP_MAIN_ACQ[i])

}

MERGED_URL <- select(MERGED_URL, conml, AcquirorName, StringDistance, TargetName, everything())

MERGED_URL$METHOD <- "URLs"


n_distinct(MERGED_URL$conml)

```


  -> STACKING MATCHES ON TOP OF EACHOTHER AND ASSIGNING URL SIMILARITY

```{r FILE: FIRM Matches from SALES/CUSIP and according Method}


M_CUSIP <- select(MERGED_CUSIP, -c(cusip6D,MATCHCUSIP))
M_NEWCUSIP <- select(MERGED_NEW_CUSIP, -c(cusip6D,MATCHCUSIP))
M_ULTIMATE_CUSIP <- select(MERGED_ULTIMATE_CUSIP, -c(cusip6D,MATCHCUSIP))
M_IMMED_CUSIP <- select(MERGED_IMMED_CUSIP, -c(cusip6D,MATCHCUSIP))
M_NAME <- select(MERGED_NAME, -c(AC_NAME))
M_TIC <- select(MERGED_TIC, -c(TICMATCH))
M_PARENTIC <- select(MERGED_PARENTIC, -c(TICMATCH))
M_NEWTIC <- select(MERGED_NEWTIC, -c(TICMATCH))
M_URL <- select(MERGED_URL, -c(MATCHES))
M_URL <- M_URL[names(M_NEWTIC)]


for (i in (1:length(colnames(M_URL)))) {
ifelse(colnames(M_URL)[i]==colnames(M_NEWCUSIP)[i], FALSE,print(paste(colnames(M_URL)[i], " ",i, " ",colnames(M_NEWCUSIP)[i])))
}

SALES_FIRM_MATCHES <- rbind(M_CUSIP,M_NEWCUSIP,M_IMMED_CUSIP,M_ULTIMATE_CUSIP, M_NAME,M_TIC,M_PARENTIC,M_NEWTIC , M_URL)

SALES_FIRM_MATCHES <- select(SALES_FIRM_MATCHES, ROWINDEX.sdc, conml, AcquirorName, StringDistance, METHOD, TargetName, everything())


n_distinct(SALES_FIRM_MATCHES$conml)

SALES_FIRM_MATCHES_UNFILTERED <- data.frame(SALES_FIRM_MATCHES)

#write.csv(SALES_FIRM_MATCHES, "SalesCUSIPMatches_UNFILTERED.csv")
#write.csv(SALES_FIRM_MATCHES, "SalesCUSIPMatches_UNFILTERED_NABlank.csv", na = "")

SALES_FIRM_MATCHES <- filter(SALES_FIRM_MATCHES, !duplicated(ROWINDEX.sdc))


##############################################################################################3
##############################################################################################3
##############################################################################################3
# ADD URLS


SALES_FIRM_MATCHES$URLMATCH <- NA

for (i in (1:length(SALES_FIRM_MATCHES$url))) {
  
spliturlx <- strsplit(as.character( SALES_FIRM_MATCHES$url[i] ), ",")[[1]] 

spliturly <- strsplit( as.character( SALES_FIRM_MATCHES$AcquirorURL[i]), ",")[[1]]

intersection <- intersect(spliturlx,spliturly)

SALES_FIRM_MATCHES$URLMATCH[i] <- length(intersection)
}

SALES_FIRM_MATCHES <- select(SALES_FIRM_MATCHES, ROWINDEX.sdc, conml, AcquirorName, URLMATCH, METHOD, TargetName, everything())


#write.csv(SALES_FIRM_MATCHES, "MatchesSCFirms.csv")
#write.csv(SALES_FIRM_MATCHES, "MatchesSCFirms_NABlank.csv", na="")

n_distinct(SALES_FIRM_MATCHES$conml)
n_distinct(SALESforMatching$conml)


```


  LINKING TARGETS: BASED ON MAIN & LEFT FILES (FIRMS AS TARGETS)
  
```{r LEFT MATCHING}

## CUSIP MATCHING

SDC_CUSIP_LE <- data.frame(SDC)
SDC_CUSIP_LE$MATCHCUSIP <- SDC_CUSIP_LE$TargetCUSIP

LEFT_CUSIP <- data.frame(FIRMS)
LEFT_CUSIP$cusip6D <- substr(LEFT_CUSIP$cusip, start = 1, stop = 6)
LEFT_CUSIP$MATCHCUSIP <- LEFT_CUSIP$cusip6D

MERGED_CUSIP_LE <- inner_join(LEFT_CUSIP,SDC_CUSIP_LE, by = "MATCHCUSIP", na_matches = "never")

MERGED_CUSIP_LE <- select(MERGED_CUSIP_LE, conml, TargetName, AcquirorName, DateEffective, everything())
MERGED_CUSIP_LE <- arrange(MERGED_CUSIP_LE, conml, DateEffective)

MERGED_CUSIP_LE$COMP_SDC_TAR <- str_replace_all(toupper(MERGED_CUSIP_LE$TargetName),"[^[:alnum:]]", "")
MERGED_CUSIP_LE$COMP_LEFT_TAR <- str_replace_all(toupper(MERGED_CUSIP_LE$conml),"[^[:alnum:]]", "")

MERGED_CUSIP_LE$StringDistance <- 0

for (i in (1:length(MERGED_CUSIP_LE$COMP_LEFT_TAR))) {
MERGED_CUSIP_LE$StringDistance[i] <- adist(MERGED_CUSIP_LE$COMP_SDC_TAR[i],MERGED_CUSIP_LE$COMP_LEFT_TAR[i])
}

MERGED_CUSIP_LE$METHOD <- "CUSIP"

MERGED_CUSIP_LE <- select(MERGED_CUSIP_LE, conml,  TargetName, AcquirorName, StringDistance, everything())

n_distinct(MERGED_CUSIP_LE$conml)


##############################################################################################3
##############################################################################################3
##############################################################################################3

## NEW UPDATED CUSIP MATCHING

SDC_NEW_CUSIP <- data.frame(SDC)
LEFT_NEW_CUSIP <- data.frame(FIRMS)
LEFT_NEW_CUSIP$cusip6D <- substr(LEFT_NEW_CUSIP$cusip, start = 1, stop = 6)

LEFT_NEW_CUSIP$MATCHCUSIP <- LEFT_NEW_CUSIP$cusip6D
SDC_NEW_CUSIP$MATCHCUSIP <- SDC_NEW_CUSIP$Tar.New.CUSIP

MERGED_NEW_CUSIP_LE <- inner_join(LEFT_NEW_CUSIP,SDC_NEW_CUSIP, by = "MATCHCUSIP", na_matches = "never")

MERGED_NEW_CUSIP_LE <- select(MERGED_NEW_CUSIP_LE, conml, TargetName, AcquirorName, DateEffective, everything())

MERGED_NEW_CUSIP_LE <- arrange(MERGED_NEW_CUSIP_LE, conml, DateEffective)

MERGED_NEW_CUSIP_LE$COMP_SDC_TAR <- str_replace_all(toupper(MERGED_NEW_CUSIP_LE$TargetName),"[^[:alnum:]]", "")
MERGED_NEW_CUSIP_LE$COMP_LEFT_TAR <- str_replace_all(toupper(MERGED_NEW_CUSIP_LE$conml),"[^[:alnum:]]", "")

MERGED_NEW_CUSIP_LE$StringDistance <- 0

for (i in (1:length(MERGED_NEW_CUSIP_LE$COMP_LEFT_TAR))) {
MERGED_NEW_CUSIP_LE$StringDistance[i] <- adist(MERGED_NEW_CUSIP_LE$COMP_SDC_TAR[i], MERGED_NEW_CUSIP_LE$COMP_LEFT_TAR[i])
}

MERGED_NEW_CUSIP_LE$METHOD <- "NewCUSIP"

MERGED_NEW_CUSIP_LE <- select(MERGED_NEW_CUSIP_LE, conml, TargetName, AcquirorName, StringDistance, everything())

n_distinct(MERGED_NEW_CUSIP_LE$conml)
  
  
##############################################################################################3
##############################################################################################3
##############################################################################################3

## IMMEDIATE PARENT CUSIP MATCHING
  
SDC_IMMED_CUSIP <- data.frame(SDC)
LEFT_IMMED_CUSIP <- data.frame(FIRMS)
LEFT_IMMED_CUSIP$cusip6D <- substr(LEFT_IMMED_CUSIP$cusip, start = 1, stop = 6)

LEFT_IMMED_CUSIP$MATCHCUSIP <- LEFT_IMMED_CUSIP$cusip6D
SDC_IMMED_CUSIP$MATCHCUSIP <- SDC_IMMED_CUSIP$TargetImmediateParentCUSIP

MERGED_IMMED_CUSIP_LE <- inner_join(LEFT_IMMED_CUSIP,SDC_IMMED_CUSIP, by = "MATCHCUSIP", na_matches = "never")

MERGED_IMMED_CUSIP_LE <- select(MERGED_IMMED_CUSIP_LE, conml, TargetName, AcquirorName, DateEffective, everything())

MERGED_IMMED_CUSIP_LE <- arrange(MERGED_IMMED_CUSIP_LE, conml, DateEffective)

MERGED_IMMED_CUSIP_LE$COMP_SDC_TAR <- str_replace_all(toupper(MERGED_IMMED_CUSIP_LE$TargetName),"[^[:alnum:]]", "")
MERGED_IMMED_CUSIP_LE$COMP_LEFT_TAR <- str_replace_all(toupper(MERGED_IMMED_CUSIP_LE$conml),"[^[:alnum:]]", "")

MERGED_IMMED_CUSIP_LE$StringDistance <- 0

for (i in (1:length(MERGED_IMMED_CUSIP_LE$COMP_LEFT_TAR))) {
MERGED_IMMED_CUSIP_LE$StringDistance[i] <- adist(MERGED_IMMED_CUSIP_LE$COMP_SDC_TAR[i], MERGED_IMMED_CUSIP_LE$COMP_LEFT_TAR[i])
}

MERGED_IMMED_CUSIP_LE$METHOD <- "ImmediateParentCUSIP"

MERGED_IMMED_CUSIP_LE <- select(MERGED_IMMED_CUSIP_LE, conml, TargetName, AcquirorName, StringDistance, everything())

n_distinct(MERGED_IMMED_CUSIP_LE$conml)

  
##############################################################################################3
##############################################################################################3
##############################################################################################3

## ULTIMATE PARENT CUSIP MATCHING

SDC_ULTIMATE_CUSIP <- data.frame(SDC)
LEFT_ULTIMATE_CUSIP <- data.frame(FIRMS)
LEFT_ULTIMATE_CUSIP$cusip6D <- substr(LEFT_ULTIMATE_CUSIP$cusip, start = 1, stop = 6)

LEFT_ULTIMATE_CUSIP$MATCHCUSIP <- LEFT_ULTIMATE_CUSIP$cusip6D
SDC_ULTIMATE_CUSIP$MATCHCUSIP <- SDC_ULTIMATE_CUSIP$TargetUltimateParentCUSIP

MERGED_ULTIMATE_CUSIP_LE <- inner_join(LEFT_ULTIMATE_CUSIP,SDC_ULTIMATE_CUSIP, by = "MATCHCUSIP", na_matches = "never")

MERGED_ULTIMATE_CUSIP_LE <- select(MERGED_ULTIMATE_CUSIP_LE, conml, TargetName, AcquirorName, DateEffective, everything())

MERGED_ULTIMATE_CUSIP_LE <- arrange(MERGED_ULTIMATE_CUSIP_LE, conml, DateEffective)

MERGED_ULTIMATE_CUSIP_LE$COMP_SDC_TAR <- str_replace_all(toupper(MERGED_ULTIMATE_CUSIP_LE$TargetName),"[^[:alnum:]]", "")
MERGED_ULTIMATE_CUSIP_LE$COMP_LEFT_TAR <- str_replace_all(toupper(MERGED_ULTIMATE_CUSIP_LE$conml),"[^[:alnum:]]", "")

MERGED_ULTIMATE_CUSIP_LE$StringDistance <- 0

for (i in (1:length(MERGED_ULTIMATE_CUSIP_LE$COMP_LEFT_TAR))) {
MERGED_ULTIMATE_CUSIP_LE$StringDistance[i] <- adist(MERGED_ULTIMATE_CUSIP_LE$COMP_SDC_TAR[i], MERGED_ULTIMATE_CUSIP_LE$COMP_LEFT_TAR[i])
}

MERGED_ULTIMATE_CUSIP_LE$METHOD <- "UltimateParentCUSIP"

MERGED_ULTIMATE_CUSIP_LE <- select(MERGED_ULTIMATE_CUSIP_LE, conml, TargetName, AcquirorName, StringDistance, everything())

n_distinct(MERGED_ULTIMATE_CUSIP_LE$conml)

  
##############################################################################################3
##############################################################################################3
##############################################################################################3
  
## NAME MATCHING

SDC_for_NAME_LE <- data.frame(SDC)
LEFT_for_NAME <- data.frame(FIRMS)

SDC_for_NAME_LE$AC_NAME <- SDC_for_NAME_LE$TargetName
LEFT_for_NAME$AC_NAME <- LEFT_for_NAME$conml

SDC_for_NAME_LE$AC_NAME <- str_replace_all(toupper(SDC_for_NAME_LE$AC_NAME), "[^[:alnum:]]", "")
LEFT_for_NAME$AC_NAME <- str_replace_all(toupper(LEFT_for_NAME$AC_NAME), "[^[:alnum:]]", "")
  
MERGED_NAME_LE <- inner_join(LEFT_for_NAME,SDC_for_NAME_LE, by = "AC_NAME", na_matches = "never")

MERGED_NAME_LE <- select(MERGED_NAME_LE, conml, TargetName, AcquirorName, DateEffective, everything())
MERGED_NAME_LE <- arrange(MERGED_NAME_LE, conml, DateEffective)

MERGED_NAME_LE$COMP_SDC_TAR <- str_replace_all(toupper(MERGED_NAME_LE$TargetName),"[^[:alnum:]]", "")
MERGED_NAME_LE$COMP_LEFT_TAR <- str_replace_all(toupper(MERGED_NAME_LE$conml),"[^[:alnum:]]", "")

MERGED_NAME_LE$StringDistance <- 0

for (i in (1:length(MERGED_NAME_LE$COMP_LEFT_TAR))) {
MERGED_NAME_LE$StringDistance[i] <- adist(MERGED_NAME_LE$COMP_SDC_TAR[i],MERGED_NAME_LE$COMP_LEFT_TAR[i])
}

MERGED_NAME_LE$METHOD <- "Name"

MERGED_NAME_LE <- select(MERGED_NAME_LE, conml, TargetName, AcquirorName, StringDistance, everything())

n_distinct(MERGED_NAME_LE$conml)


##############################################################################################3
##############################################################################################3
##############################################################################################3

## TICKER MATCHING

SDC_for_TIC_LE <- data.frame(SDC)
LEFT_for_TIC <- data.frame(FIRMS)

SDC_for_TIC_LE$TICMATCH <- SDC_for_TIC_LE$TargetPrimaryTickerSymbol
LEFT_for_TIC$TICMATCH <- LEFT_for_TIC$tic

MERGED_TIC_LE <- inner_join(LEFT_for_TIC,SDC_for_TIC_LE, by = "TICMATCH", na_matches = "never")

MERGED_TIC_LE <- select(MERGED_TIC_LE, conml, TargetName, AcquirorName, DateEffective, everything())
MERGED_TIC_LE <- arrange(MERGED_TIC_LE, conml, DateEffective)

MERGED_TIC_LE$COMP_SDC_TAR <- str_replace_all(toupper(MERGED_TIC_LE$TargetName),"[^[:alnum:]]", "")

MERGED_TIC_LE$COMP_LEFT_TAR <- str_replace_all(toupper(MERGED_TIC_LE$conml),"[^[:alnum:]]", "")

MERGED_TIC_LE$StringDistance <- 0

for (i in (1:length(MERGED_TIC_LE$COMP_LEFT_TAR))) {
  
MERGED_TIC_LE$StringDistance[i] <- adist(MERGED_TIC_LE$COMP_SDC_TAR[i],MERGED_TIC_LE$COMP_LEFT_TAR[i])
}

MERGED_TIC_LE$METHOD <- "Ticker"

MERGED_TIC_LE <- select(MERGED_TIC_LE, conml, TargetName, AcquirorName, StringDistance, everything())

n_distinct(MERGED_TIC_LE$conml)


##############################################################################################3
##############################################################################################3
##############################################################################################3

## PARENT'S TICKER MATCHING

SDC_for_PARENTTIC_LE <- data.frame(SDC)
LEFT_for_PAERNTTIC <- data.frame(FIRMS)

SDC_for_PARENTTIC_LE$TICMATCH <- SDC_for_PARENTTIC_LE$TargetUltimateParentPrimaryTickerSymbol
LEFT_for_PAERNTTIC$TICMATCH <- LEFT_for_PAERNTTIC$tic

MERGED_PARENTIC_LE <- inner_join(LEFT_for_PAERNTTIC, SDC_for_PARENTTIC_LE, by = "TICMATCH", na_matches = "never")

MERGED_PARENTIC_LE <- select(MERGED_PARENTIC_LE, conml, TargetName, AcquirorName, DateEffective, everything())
MERGED_PARENTIC_LE <- arrange(MERGED_PARENTIC_LE, conml, DateEffective)

MERGED_PARENTIC_LE$COMP_SDC_TAR <- str_replace_all(toupper(MERGED_PARENTIC_LE$TargetName),"[^[:alnum:]]", "")

MERGED_PARENTIC_LE$COMP_LEFT_TAR <- str_replace_all(toupper(MERGED_PARENTIC_LE$conml),"[^[:alnum:]]", "")

MERGED_PARENTIC_LE$StringDistance <- 0

for (i in (1:length(MERGED_PARENTIC_LE$COMP_LEFT_TAR))) {
  
MERGED_PARENTIC_LE$StringDistance[i] <- adist(MERGED_PARENTIC_LE$COMP_SDC_TAR[i],MERGED_PARENTIC_LE$COMP_LEFT_TAR[i])

}

MERGED_PARENTIC_LE$METHOD <- "ParentTicker"

MERGED_PARENTIC_LE <- select(MERGED_PARENTIC_LE, conml, TargetName, AcquirorName, StringDistance, everything())

n_distinct(MERGED_PARENTIC_LE$conml)


##############################################################################################3
##############################################################################################3
##############################################################################################3

## NEW UPDATED TICKER MATCHING

SDC_for_NEWTIC_LE <- data.frame(SDC)
LEFT_for_NEWTIC <- data.frame(FIRMS)

SDC_for_NEWTIC_LE$TICMATCH <- SDC_for_NEWTIC_LE$Tar.New.TICKER
LEFT_for_NEWTIC$TICMATCH <- LEFT_for_NEWTIC$tic

MERGED_NEWTIC_LE <- inner_join(LEFT_for_NEWTIC, SDC_for_NEWTIC_LE, by = "TICMATCH", na_matches = "never")

MERGED_NEWTIC_LE <- select(MERGED_NEWTIC_LE, conml, TargetName, AcquirorName, DateEffective, everything())
MERGED_NEWTIC_LE <- arrange(MERGED_NEWTIC_LE, conml, DateEffective)

MERGED_NEWTIC_LE$COMP_SDC_TAR <- str_replace_all(toupper(MERGED_NEWTIC_LE$TargetName),"[^[:alnum:]]", "")

MERGED_NEWTIC_LE$COMP_LEFT_TAR <- str_replace_all(toupper(MERGED_NEWTIC_LE$conml),"[^[:alnum:]]", "")

MERGED_NEWTIC_LE$StringDistance <- 0

for (i in (1:length(MERGED_NEWTIC_LE$COMP_LEFT_TAR))) {
  
MERGED_NEWTIC_LE$StringDistance[i] <- adist(MERGED_NEWTIC_LE$COMP_SDC_TAR[i],MERGED_NEWTIC_LE$COMP_LEFT_TAR[i])

}

MERGED_NEWTIC_LE$METHOD <- "NewTicker"

MERGED_NEWTIC_LE <- select(MERGED_NEWTIC_LE, conml, TargetName, AcquirorName, StringDistance, everything())

n_distinct(MERGED_NEWTIC_LE$conml)


##############################################################################################3
##############################################################################################3
##############################################################################################3

## CREATING R DATA FRAME FROM URL MATCHES (MATCHES IMPORTED FROM PYTHON)

URLtoMATCH <- data.frame(URLMatchesLEFT)
SDCURLMerge <- data.frame(SDC)

SDC_MERGE_URL <- left_join(URLtoMATCH, SDCURLMerge, by = "TargetName")

MERGED_URL_LE <- left_join(SDC_MERGE_URL, FIRMS, by = c("conmlT" = "conml"))

MERGED_URL_LE <- select(MERGED_URL_LE, conmlT, TargetName, AcquirorName, DateEffective, everything())

MERGED_URL_LE <- arrange(MERGED_URL_LE, conmlT, DateEffective)

MERGED_URL_LE$COMP_SDC_TAR <- str_replace_all(toupper(MERGED_URL_LE$AcquirorName),"[^[:alnum:]]", "")

MERGED_URL_LE$COMP_LEFT_TAR <- str_replace_all(toupper(MERGED_URL_LE$conml),"[^[:alnum:]]", "")

MERGED_URL_LE$StringDistance <- 0

for (i in (1:length(MERGED_URL_LE$COMP_LEFT_TAR))) {
  
MERGED_URL_LE$StringDistance[i] <- adist(MERGED_URL_LE$COMP_SDC_TAR[i],MERGED_URL_LE$COMP_LEFT_TAR[i])

}

MERGED_URL_LE <- select(MERGED_URL_LE, conmlT, TargetName, AcquirorName, StringDistance, everything())
MERGED_URL_LE <- rename(MERGED_URL_LE, conml = conmlT)

MERGED_URL_LE$METHOD <- "URLs"


n_distinct(MERGED_URL_LE$conml)



```


  -> STACKING MATCHES ON TOP OF EACHOTHER AND ASSIGNING URL SIMILARITY

```{r FILE: LEFT Matches and according Method}

M_CUSIP_LE <- select(MERGED_CUSIP_LE, -c(cusip6D,MATCHCUSIP))
M_NEWCUSIP_LE <- select(MERGED_NEW_CUSIP_LE, -c(cusip6D,MATCHCUSIP))
M_IMMED_CUSIP_LE <- select(MERGED_IMMED_CUSIP_LE, -c(cusip6D,MATCHCUSIP))
M_ULTIMATE_CUSIP_LE <- select(MERGED_ULTIMATE_CUSIP_LE, -c(cusip6D,MATCHCUSIP))
M_NAME_LE <- select(MERGED_NAME_LE, -c(AC_NAME))
M_TIC_LE <- select(MERGED_TIC_LE, -c(TICMATCH))
M_PARENTIC_LE <- select(MERGED_PARENTIC_LE, -c(TICMATCH))
M_NEWTIC_LE <- select(MERGED_NEWTIC_LE, -c(TICMATCH))
M_URL_LE <- select(MERGED_URL_LE, -c(MATCHES))
M_URL_LE <- M_URL_LE[names(M_NEWTIC_LE)]


for (i in (1:length(colnames(M_URL_LE)))) {
  
ifelse(colnames(M_URL_LE)[i]==colnames(M_NEWTIC_LE)[i],FALSE,print(paste(colnames(M_URL_LE)[i], " ",i, " ",colnames(M_NEWTIC_LE)[i])))
}

LEFT_MATCHES <- rbind(M_CUSIP_LE, M_NEWCUSIP_LE, M_NAME_LE, M_TIC_LE,M_PARENTIC_LE,M_NEWTIC_LE,M_URL_LE)

LEFT_MATCHES <- select(LEFT_MATCHES, conml, TargetName, StringDistance, METHOD, AcquirorName, everything())

n_distinct(LEFT_MATCHES$conml)

#write.csv(LEFT_MATCHES, "LeftMatches_EXTENDED.csv")
#write.csv(LEFT_MATCHES, "LeftMatches_EXTENDED_NABlank.csv", na = "")

LEFT_MATCHES <- filter(LEFT_MATCHES, !duplicated(ROWINDEX.sdc))

##############################################################################################3
##############################################################################################3
##############################################################################################3
# ADD URLS

LEFT_MATCHES$URLMATCH <- NA

for (i in (1:length(LEFT_MATCHES$url))) {
  
spliturlx <- strsplit(as.character( LEFT_MATCHES$url[i] ), ",")[[1]] 

spliturly <- strsplit( as.character( LEFT_MATCHES$TargetURL[i]), ",")[[1]]

intersection <- intersect(spliturlx,spliturly)

LEFT_MATCHES$URLMATCH[i] <- length(intersection)
}

LEFT_MATCHES <- select(LEFT_MATCHES, ROWINDEX.sdc, conml, TargetName, AcquirorName, URLMATCH, METHOD, everything())


#write.csv(LEFT_MATCHES, "MatchesLTFirms.csv")
#write.csv(LEFT_MATCHES, "MatchesLTFirms_NABlank.csv", na="")

n_distinct(LEFT_MATCHES$conml)
n_distinct(FIRMS$conml)


```


## CLEANING THE RESULTING MATCHED FILES

  MATCHED FROM SALES/CUSIP -> SCMatches
  MATCHED FROM MAIN/LEFT   -> MLMatches
  MATCHED FROM TARGETS     -> LTargets

```{r ANALYSIS FILES}

MLMatches <- data.frame(FIRM_MATCHES)
SCMatches <- data.frame(SALES_FIRM_MATCHES)
LTargets <- data.frame(LEFT_MATCHES)

## REMOVING FALSE POSITIVES BASED ON URLS MATCHES
MLMatches <- filter(MLMatches, METHOD == "CUSIP" | 
                      METHOD == "NewCUSIP" |
                      METHOD == "ImmediateParentCUSIP" |
                      METHOD == "UltimateParentCUSIP" |
                      METHOD == "Name" |
                      URLMATCH > 2)

SCMatches <- filter(SCMatches, METHOD == "CUSIP" | 
                      METHOD == "NewCUSIP" |
                      METHOD == "ImmediateParentCUSIP" |
                      METHOD == "UltimateParentCUSIP" |
                      METHOD == "Name" |
                      URLMATCH > 2)

LTargets <- filter(LTargets, METHOD == "CUSIP" | 
                      METHOD == "NewCUSIP" |
                      METHOD == "ImmediateParentCUSIP" |
                      METHOD == "UltimateParentCUSIP" |
                      METHOD == "Name" |
                      URLMATCH > 2)

## CLEANING THE NAMES
names(MLMatches) <- gsub(".", "", names(MLMatches), fixed = TRUE)
names(SCMatches) <- gsub(".", "", names(SCMatches), fixed = TRUE)
names(LTargets) <- gsub(".", "", names(LTargets), fixed = TRUE)

## REMOVING SOME UNNECESSARY COLUMNS
MLMatches <- select(MLMatches, -StringDistance, -weburl, -RankDate,
                    -TargetSharePrice1DayPriortoAnnouncement,
                    -TargetSharePrice1WeekPriortoAnnouncement,
                    -TargetSharePrice4WeeksPriortoAnnouncement,
                    -AcquirorClosingPrice1DayAfterAnnDate,
                    -AcquirorClosingPrice10DaysAfterAnnDate,
                    -TargetCommonDividendsOneYearPriormil,
                    -TargetCommonDividendsTwoYearsPriormil,
                    -TargetCommonDividendsThreeYearsPriormil,
                    -TargetCommonDividendsFourYearsPriormil,
                    -ReasonRelatedDescription,
                    -TargetClosingPrice1DayAfterAnnDate,
                    -TargetClosingPrice1WeekAfterAnnDate,
                    -TargetClosingPrice180DaysAfterAnnDate,
                    -COMP_SDC_ACQ,
                    -COMP_MAIN_ACQ,
                    -AcquirorClosingPrice180DaysAfterAnnDate,
                    -AcquirorClosingPrice1WeekAfterAnnDate)

## CREATING THE YEAR COLUMNS FOR LATER USE
MLMatches$YEARef <- substr(MLMatches$DateEffective, start = 1, stop = 4)
MLMatches$YEARan <- substr(MLMatches$DateAnnounced, start = 1, stop = 4)

## REMOVING SOME UNNECESSARY COLUMNS
SCMatches <- select(SCMatches, -StringDistance, -weburl, -RankDate,
                    -TargetSharePrice1DayPriortoAnnouncement,
                    -TargetSharePrice1WeekPriortoAnnouncement,
                    -TargetSharePrice4WeeksPriortoAnnouncement,
                    -AcquirorClosingPrice1DayAfterAnnDate,
                    -AcquirorClosingPrice10DaysAfterAnnDate,
                    -TargetCommonDividendsOneYearPriormil,
                    -TargetCommonDividendsTwoYearsPriormil,
                    -TargetCommonDividendsThreeYearsPriormil,
                    -TargetCommonDividendsFourYearsPriormil,
                    -ReasonRelatedDescription,
                    -TargetClosingPrice1DayAfterAnnDate,
                    -TargetClosingPrice1WeekAfterAnnDate,
                    -TargetClosingPrice180DaysAfterAnnDate,
                    -COMP_SDC_ACQ,
                    -COMP_MAIN_ACQ,
                    -AcquirorClosingPrice180DaysAfterAnnDate,
                    -AcquirorClosingPrice1WeekAfterAnnDate)

## CREATING THE YEAR COLUMNS FOR LATER USE
SCMatches$YEARef <- substr(SCMatches$DateEffective, start = 1, stop = 4)
SCMatches$YEARan <- substr(SCMatches$DateAnnounced, start = 1, stop = 4)

## REMOVING SOME UNNECESSARY COLUMNS
LTargets <- select(LTargets, -StringDistance, -weburl, -RankDate,
                    -TargetSharePrice1DayPriortoAnnouncement,
                    -TargetSharePrice1WeekPriortoAnnouncement,
                    -TargetSharePrice4WeeksPriortoAnnouncement,
                    -AcquirorClosingPrice1DayAfterAnnDate,
                    -AcquirorClosingPrice10DaysAfterAnnDate,
                    -TargetCommonDividendsOneYearPriormil,
                    -TargetCommonDividendsTwoYearsPriormil,
                    -TargetCommonDividendsThreeYearsPriormil,
                    -TargetCommonDividendsFourYearsPriormil,
                    -ReasonRelatedDescription,
                    -TargetClosingPrice1DayAfterAnnDate,
                    -TargetClosingPrice1WeekAfterAnnDate,
                    -TargetClosingPrice180DaysAfterAnnDate,
                    -COMP_SDC_TAR,
                    -COMP_LEFT_TAR,
                    -AcquirorClosingPrice180DaysAfterAnnDate,
                    -AcquirorClosingPrice1WeekAfterAnnDate)

## CREATING THE YEAR COLUMNS FOR LATER USE
LTargets$YEARef <- substr(LTargets$DateEffective, start = 1, stop = 4)
LTargets$YEARan <- substr(LTargets$DateAnnounced, start = 1, stop = 4)

## COUNTING DISTINCT FIRM OBSERVATIONS IN THE DATA SETS
n_distinct(MLMatches$conml)
n_distinct(SCMatches$conml)
n_distinct(LTargets$conml)

## PREPARE A SET FORM THE TARGETS TO ASSIGN TARGET GVKEYS TO SCMatches
LTargetsForMerge <- data.frame(LTargets)
LTargetsForMerge <- select(LTargetsForMerge, gvkey, TargetName)
LTargetsForMerge <- distinct(LTargetsForMerge, gvkey, .keep_all = TRUE)
LTargetsForMerge <- rename(LTargetsForMerge, gvkeyT = gvkey)

# ASSIGN GVKEYS FOR TARGETS
MLMatches <- left_join(MLMatches, LTargetsForMerge, by = "TargetName",na_matches = "never")

SCMatches <- left_join(SCMatches, LTargetsForMerge, by = "TargetName",na_matches = "never")


#write.csv(MLMatches,"MLMatchesUPDATED.csv")
#write.csv(MLMatches,"MLMatchesUPDATED_NABlank.csv", na = "")

#write.csv(SCMatches, "SCMatchesUPTODATE.csv")
#write.csv(SCMatches, "SCMatchesUPTODATE_NABlank.csv", na = "")

#write.csv(LTargets, "LTargetsUPDATED.csv")
#write.csv(LTargets, "LTargetsUPDATED_NABlank.csv", na = "")

##############################################################################################################################################################################################################################################################

```

  
  CREATE FILE OF THOSE TRANSACTIONS THAT WERE NOT MACTHED FOR FURTHER ANALYSIS
  
```{r CHECK UNMATCHED SDC}

### SC Matches
MatchedInSC <- SCMatches$ROWINDEXsdc

SDCnoMatchSC <- data.frame(SDC)

SDCnoMatchSC <- filter(SDCnoMatchSC, ! ROWINDEX.sdc %in% MatchedInSC) #394'992
SDCnoMatchSCfiltered <- filter(SDCnoMatchSC, AcquirorName != TargetName) #373'836
SDCnoMatchSCfiltered <- filter(SDCnoMatchSCfiltered, AcquirorName != "Investor Group"   # 322'261
                          & AcquirorName != "Investors"
                          & AcquirorName != "Shareholders"
                          & AcquirorName != "Creditors"
                          & AcquirorName != "Preferred Shareholders")

n_distinct(SCMatches$conm) # 12'424
n_distinct(SALES$conm) # 21'365

n_distinct(SCMatches$conm)/n_distinct(SALES$conm) # 21'365

SDCnoMatchSC <- arrange(SDCnoMatchSC, desc(ValueofTransaction..mil.) )
SDCnoMatchSCfiltered <- arrange(SDCnoMatchSCfiltered, desc(ValueofTransaction..mil.) )

#write.csv(SDCnoMatchSC, "SDCnoMatchSC_NABlank.csv", na = "")
#write.csv(SDCnoMatchSCfiltered, "SDCnoMatchSCfiltered_NABlank.csv", na = "")


## ML Matches

MatchedInML <- MLMatches$ROWINDEXsdc

SDCnoMatchML <- data.frame(SDC)

SDCnoMatchML <- filter(SDCnoMatchML, ! ROWINDEX.sdc %in% MatchedInML) #359'696
SDCnoMatchMLfiltered <- filter(SDCnoMatchML, AcquirorName != TargetName) #344'641
SDCnoMatchMLfiltered <- filter(SDCnoMatchMLfiltered, AcquirorName != "Investor Group" # 293'066
                          & AcquirorName != "Investors"
                          & AcquirorName != "Shareholders"
                          & AcquirorName != "Creditors"
                          & AcquirorName != "Preferred Shareholders")


n_distinct(MLMatches$conml) # 17'195
n_distinct(FIRMS$conml) # 38'185

n_distinct(MLMatches$conml)/n_distinct(FIRMS$conml) # 38'185

SDCnoMatchML <- arrange(SDCnoMatchML, desc(ValueofTransaction..mil.) )
SDCnoMatchMLfiltered <- arrange(SDCnoMatchMLfiltered, desc(ValueofTransaction..mil.) )

#write.csv(SDCnoMatchML, "SDCnoMatchML_NABlank.csv", na = "")
#write.csv(SDCnoMatchMLfiltered, "SDCnoMatchMLfiltered_NABlank.csv", na = "")


#### Not Matched at all:

MatchANY <- c(MatchedInSC,MatchedInML)

SDCnoMatchANY <- data.frame(SDC)

SDCnoMatchANY <- filter(SDCnoMatchANY, ! ROWINDEX.sdc %in% MatchANY) #359'024
SDCnoMatchANYfiltered <- filter(SDCnoMatchANY, AcquirorName != TargetName) #344'024
SDCnoMatchANYfiltered <- filter(SDCnoMatchANYfiltered, AcquirorName != "Investor Group"   # 292'449
                          & AcquirorName != "Investors"
                          & AcquirorName != "Shareholders"
                          & AcquirorName != "Creditors"
                          & AcquirorName != "Preferred Shareholders")


SDCnoMatchANY <- arrange(SDCnoMatchANY, desc(ValueofTransaction..mil.) )
SDCnoMatchANYfiltered <- arrange(SDCnoMatchANYfiltered, desc(ValueofTransaction..mil.) )

#write.csv(SDCnoMatchANY, "SDCnoMatchANY_NABlank.csv", na = "")
#write.csv(SDCnoMatchANYfiltered, "SDCnoMatchANYfiltered_NABlank.csv", na = "")

```


  CLEANING SCMatches and MLMatches BY REMOVING BUYBACKS AND OTHER UNWANTED TRANSACTIONS

```{r REMOVE BUYBACKS AND OTHER UNWANTED TRANSACTIONS}

##############################################################################################################################################################################################################################################################

SCMatchesClean <- data.frame(SCMatches)

SCMatchesClean <- filter(SCMatchesClean, TargetCUSIP != AcquirorCUSIP 
                                  | is.na(TargetCUSIP) | is.na(AcquirorCUSIP))

SCMatchesClean <- filter(SCMatchesClean, TargetCUSIP != AcqNewCUSIP 
                                  | is.na(TargetCUSIP) | is.na(AcqNewCUSIP))

SCMatchesClean <- filter(SCMatchesClean, TargetCUSIP != AcquirorImmediateParentCUSIP 
                                  | is.na(TargetCUSIP) | is.na(AcquirorImmediateParentCUSIP))

SCMatchesClean <- filter(SCMatchesClean, TargetCUSIP != AcquirorUltimateParentCUSIP 
                                  | is.na(TargetCUSIP) | is.na(AcquirorUltimateParentCUSIP))

############

SCMatchesClean <- filter(SCMatchesClean, TarNewCUSIP != AcquirorCUSIP 
                                  | is.na(TarNewCUSIP) | is.na(AcquirorCUSIP))

SCMatchesClean <- filter(SCMatchesClean, TarNewCUSIP != AcqNewCUSIP 
                                  | is.na(TarNewCUSIP) | is.na(AcqNewCUSIP))

SCMatchesClean <- filter(SCMatchesClean, TarNewCUSIP != AcquirorImmediateParentCUSIP 
                                  | is.na(TarNewCUSIP) | is.na(AcquirorImmediateParentCUSIP))

SCMatchesClean <- filter(SCMatchesClean, TarNewCUSIP != AcquirorUltimateParentCUSIP 
                                  | is.na(TarNewCUSIP) | is.na(AcquirorUltimateParentCUSIP))

############

SCMatchesClean <- filter(SCMatchesClean, TargetImmediateParentCUSIP != AcquirorCUSIP 
                                  | is.na(TargetImmediateParentCUSIP) | is.na(AcquirorCUSIP))

SCMatchesClean <- filter(SCMatchesClean, TargetImmediateParentCUSIP != AcqNewCUSIP 
                                  | is.na(TargetImmediateParentCUSIP) | is.na(AcqNewCUSIP))

SCMatchesClean <- filter(SCMatchesClean, TargetImmediateParentCUSIP != AcquirorImmediateParentCUSIP 
                                  | is.na(TargetImmediateParentCUSIP) | is.na(AcquirorImmediateParentCUSIP))

SCMatchesClean <- filter(SCMatchesClean, TargetImmediateParentCUSIP != AcquirorUltimateParentCUSIP 
                                  | is.na(TargetImmediateParentCUSIP) | is.na(AcquirorUltimateParentCUSIP))
############

SCMatchesClean <- filter(SCMatchesClean, TargetUltimateParentCUSIP != AcquirorCUSIP 
                                  | is.na(TargetUltimateParentCUSIP) | is.na(AcquirorCUSIP))

SCMatchesClean <- filter(SCMatchesClean, TargetUltimateParentCUSIP != AcqNewCUSIP 
                                  | is.na(TargetUltimateParentCUSIP) | is.na(AcqNewCUSIP))

SCMatchesClean <- filter(SCMatchesClean, TargetUltimateParentCUSIP != AcquirorImmediateParentCUSIP 
                                  | is.na(TargetUltimateParentCUSIP) | is.na(AcquirorImmediateParentCUSIP))

SCMatchesClean <- filter(SCMatchesClean, TargetUltimateParentCUSIP != AcquirorUltimateParentCUSIP 
                                  | is.na(TargetUltimateParentCUSIP) | is.na(AcquirorUltimateParentCUSIP))

############
SCMatchesClean <- filter(SCMatchesClean, TargetName != AcquirorName 
                                  | is.na(TargetName) | is.na(AcquirorName))

#OTHER:

SCMatchesClean <- filter(SCMatchesClean, AcquirorName != "Investor Group"  
                          & AcquirorName != "Investors"
                          & AcquirorName != "Shareholders"
                          & AcquirorName != "Creditors"
                          & AcquirorName != "Preferred Shareholders"
                          & AcquirorName != "Investors (Non-US)" | is.na(AcquirorName))

############
SCMatches <- data.frame(SCMatchesClean)

sum(is.na(SCMatches$TargetNetSalesLTMmil))
n_distinct(SCMatches$gvkeyT)
#############################################################################################################################################################################################################################################################
#############################################################################################################################################################################################################################################################


MLMatchesClean <- data.frame(MLMatches)

MLMatchesClean <- filter(MLMatchesClean, TargetCUSIP != AcquirorCUSIP 
                                  | is.na(TargetCUSIP) | is.na(AcquirorCUSIP))

MLMatchesClean <- filter(MLMatchesClean, TargetCUSIP != AcqNewCUSIP 
                                  | is.na(TargetCUSIP) | is.na(AcqNewCUSIP))

MLMatchesClean <- filter(MLMatchesClean, TargetCUSIP != AcquirorImmediateParentCUSIP 
                                  | is.na(TargetCUSIP) | is.na(AcquirorImmediateParentCUSIP))

MLMatchesClean <- filter(MLMatchesClean, TargetCUSIP != AcquirorUltimateParentCUSIP 
                                  | is.na(TargetCUSIP) | is.na(AcquirorUltimateParentCUSIP))

############

MLMatchesClean <- filter(MLMatchesClean, TarNewCUSIP != AcquirorCUSIP 
                                  | is.na(TarNewCUSIP) | is.na(AcquirorCUSIP))

MLMatchesClean <- filter(MLMatchesClean, TarNewCUSIP != AcqNewCUSIP 
                                  | is.na(TarNewCUSIP) | is.na(AcqNewCUSIP))

MLMatchesClean <- filter(MLMatchesClean, TarNewCUSIP != AcquirorImmediateParentCUSIP 
                                  | is.na(TarNewCUSIP) | is.na(AcquirorImmediateParentCUSIP))

MLMatchesClean <- filter(MLMatchesClean, TarNewCUSIP != AcquirorUltimateParentCUSIP 
                                  | is.na(TarNewCUSIP) | is.na(AcquirorUltimateParentCUSIP))

############

MLMatchesClean <- filter(MLMatchesClean, TargetImmediateParentCUSIP != AcquirorCUSIP 
                                  | is.na(TargetImmediateParentCUSIP) | is.na(AcquirorCUSIP))

MLMatchesClean <- filter(MLMatchesClean, TargetImmediateParentCUSIP != AcqNewCUSIP 
                                  | is.na(TargetImmediateParentCUSIP) | is.na(AcqNewCUSIP))

MLMatchesClean <- filter(MLMatchesClean, TargetImmediateParentCUSIP != AcquirorImmediateParentCUSIP 
                                  | is.na(TargetImmediateParentCUSIP) | is.na(AcquirorImmediateParentCUSIP))

MLMatchesClean <- filter(MLMatchesClean, TargetImmediateParentCUSIP != AcquirorUltimateParentCUSIP 
                                  | is.na(TargetImmediateParentCUSIP) | is.na(AcquirorUltimateParentCUSIP))
############

MLMatchesClean <- filter(MLMatchesClean, TargetUltimateParentCUSIP != AcquirorCUSIP 
                                  | is.na(TargetUltimateParentCUSIP) | is.na(AcquirorCUSIP))

MLMatchesClean <- filter(MLMatchesClean, TargetUltimateParentCUSIP != AcqNewCUSIP 
                                  | is.na(TargetUltimateParentCUSIP) | is.na(AcqNewCUSIP))

MLMatchesClean <- filter(MLMatchesClean, TargetUltimateParentCUSIP != AcquirorImmediateParentCUSIP 
                                  | is.na(TargetUltimateParentCUSIP) | is.na(AcquirorImmediateParentCUSIP))

MLMatchesClean <- filter(MLMatchesClean, TargetUltimateParentCUSIP != AcquirorUltimateParentCUSIP 
                                  | is.na(TargetUltimateParentCUSIP) | is.na(AcquirorUltimateParentCUSIP))

############
MLMatchesClean <- filter(MLMatchesClean, TargetName != AcquirorName 
                                  | is.na(TargetName) | is.na(AcquirorName))

#OTHER:

MLMatchesClean <- filter(MLMatchesClean, AcquirorName != "Investor Group"  
                          & AcquirorName != "Investors"
                          & AcquirorName != "Shareholders"
                          & AcquirorName != "Creditors"
                          & AcquirorName != "Preferred Shareholders"
                          & AcquirorName != "Investors (Non-US)" | is.na(AcquirorName))

############
MLMatches <- data.frame(MLMatchesClean)


```


## ASSIGNING SALES VALUES TO THE TARGETS

  ADDING SALES VALUES FROM COMPUSTAT

```{r FINAL MATCH}

SCMatchesFin <- data.frame(SCMatches)
SCMatchesFin <- select(SCMatchesFin, -sale_D)
SCMatchesFin <- rename(SCMatchesFin, saleAc = sale)

SCMatchesFin <- filter(SCMatchesFin, !is.na(gvkeyT) | !is.na(TargetNetSalesLTMmil) | !is.na(TargetSales))

SALESFin <- data.frame(SALES)
SALESFin <- select(SALESFin, year, gvkey, sale, conm)
SALESFin <- rename(SALESFin, yearS = year, gvkeyT = gvkey, conmT = conm)

SCMatchesFin <- left_join(SCMatchesFin, SALESFin, by = "gvkeyT", na_match = "never")

SCMatchesFin$TargetNetSales <- SCMatchesFin$TargetNetSalesLTMmil

SCMatchesFin$sale <- SCMatchesFin$sale/1000

SCMatchesFin$saleAc <- SCMatchesFin$saleAc/1000

SCMatchesFin$yearS <- ifelse(is.na(SCMatchesFin$yearS), SCMatchesFin$YEARan, SCMatchesFin$yearS)

SCMatchesFin$yearDiff <- abs(as.numeric(SCMatchesFin$YEARan) - 1 - as.numeric(SCMatchesFin$yearS))

SCMatchesFin <- select(SCMatchesFin, conml, AcquirorName, conmT, TargetName, METHOD, yearS, YEARan, 
                       YEARef,  yearDiff, sale, TargetNetSales, saleAc, everything())

SCMatchesFinMinYears <- SCMatchesFin %>%
  group_by(gvkey, TargetName) %>%
  slice(which.min(yearDiff) )

SCMatchesFinMATCHES <- select(SCMatchesFinMinYears, conml, AcquirorName, conmT, TargetName, METHOD, yearS, YEARan, 
                       YEARef,  yearDiff, sale, TargetNetSales, saleAc, everything())

SCMatchesFinMATCHES$saleDiff <- abs(SCMatchesFinMATCHES$TargetNetSales - SCMatchesFinMATCHES$sale)

SCMatchesFinMATCHES$RELsaleDiff <- with(  SCMatchesFinMATCHES, round ( 100 * saleDiff / ((TargetNetSales + sale) / 2),2 )  )

median(na.omit(SCMatchesFinMATCHES$saleDiff))

SCMatchesFinMATCHES <- filter(SCMatchesFinMATCHES, !is.na(XofSharesAcq))

SCMatchesFinMATCHES <- select(SCMatchesFinMATCHES, conml, AcquirorName, conmT, TargetName, METHOD, yearS, YEARan, 
                       YEARef,  yearDiff, sale, TargetNetSales, saleDiff, 
                       RELsaleDiff, saleAc, everything())

```


  PREDICT SALES VALUES BASED ON COMPUSTAT DATA

```{r PREDICTION BASED ON FIN MATCHES}

set.seed(8)

FINTraining <- data.frame(SCMatchesFinMATCHES)


FINTraining <- select(FINTraining, AcquirorName, AcquirorState, AcquirorNation, AcquirorPrimarySICCode,
                       TargetName, TargetState, TargetNation, TargetPrimarySICCode,
                       sale, saleAc, ValueofTransactionmil, XofSharesAcq, YEARef)

FINTraining$AcquirorPrimarySICCode2D <- as.factor(substr(FINTraining$AcquirorPrimarySICCode, start = 1, stop = 2) )
FINTraining$AcquirorState <- as.factor(FINTraining$AcquirorState)

FINTraining$TargetPrimarySICCode2D <- as.factor(substr(FINTraining$TargetPrimarySICCode, start = 1, stop = 2) )
FINTraining$TargetState <- as.factor(FINTraining$TargetState)

FINTraining <- filter(FINTraining, !is.na(sale) & !is.na(ValueofTransactionmil) & !is.na(XofSharesAcq)
                       & !is.na(YEARef)  & !is.na(AcquirorState)  & !is.na(AcquirorPrimarySICCode2D) 
                       & !is.na(TargetState)  & !is.na(TargetPrimarySICCode2D) )

FINTraining$LOGValueOfTr <- log(FINTraining$ValueofTransactionmil)
FINTraining$LOGSales <- log(FINTraining$sale)
FINTraining$LOGACSales <- log(FINTraining$saleAc)



### SDC Testset

TestSampleCompu <- sample((1:6219), 1219)

FINTest <- FINTraining[TestSampleCompu,]
  
FINTraining <- FINTraining[-TestSampleCompu,]


CompSalesFOLS <- with(FINTraining,
                     feols(LOGSales ~ LOGValueOfTr + LOGACSales + XofSharesAcq | TargetState + TargetPrimarySICCode2D +
                     AcquirorState + AcquirorPrimarySICCode2D + YEARef,
                     data = FINTraining)    )


summary(CompSalesFOLS, cluster = ~TargetState)

model.coef <- coef(CompSalesFOLS)
model.coef

### Test
LOGTestResults <- predict(CompSalesFOLS, newdata = FINTest)
TestResults <- exp(LOGTestResults)

FINTest <- cbind(TestResults,LOGTestResults, FINTest)
FINTest <- select(FINTest, TestResults, sale, LOGTestResults, LOGSales,everything())

FINTest$LOGDiff <- FINTest$LOGSales - FINTest$LOGTestResults

FINTest <- select(FINTest, LOGDiff, TestResults, sale, LOGTestResults, LOGSales,everything())

mean(na.omit(FINTest$LOGDiff))

median(na.omit(FINTest$LOGDiff))


exp(mean(na.omit(FINTest$LOGDiff)))

exp(median(na.omit(FINTest$LOGDiff)))

### TRAINING
LOGTestResults <- predict(CompSalesFOLS, newdata = FINTraining)
TestResults <- exp(LOGTestResults)

FINTraining <- cbind(TestResults,LOGTestResults, FINTraining)
FINTraining <- select(FINTraining, TestResults, sale, LOGTestResults, LOGSales,everything())

FINTraining$LOGDiff <- FINTraining$LOGSales - FINTraining$LOGTestResults

FINTraining <- select(FINTraining, LOGDiff, TestResults, sale, LOGTestResults, LOGSales,everything())

mean(na.omit(FINTraining$LOGDiff))

median(na.omit(FINTraining$LOGDiff))


exp(mean(na.omit(FINTraining$LOGDiff)))

exp(median(na.omit(FINTraining$LOGDiff)))

#### APPLY TO ALL MATCHES
SCMatchesFinMATCHES$LOGValueOfTr <- log(SCMatchesFinMATCHES$ValueofTransactionmil)
SCMatchesFinMATCHES$AcquirorPrimarySICCode2D <- substr(SCMatchesFinMATCHES$AcquirorPrimarySICCode, start = 1, stop = 2)
SCMatchesFinMATCHES$TargetPrimarySICCode2D <- substr(SCMatchesFinMATCHES$TargetPrimarySICCode, start = 1, stop = 2)
SCMatchesFinMATCHES$LOGACSales <- log(SCMatchesFinMATCHES$saleAc)

PredictedCompu <- predict(CompSalesFOLS, newdata = SCMatchesFinMATCHES)


SCMatchesFinMATCHES$PredictedCompu <- exp(PredictedCompu)

SCMatchesFinMATCHES <- SCMatchesFinMATCHES %>% ungroup()

#### MAKING SOME COMPARISON TO OTHER SALES VALUES
saleview <- select(SCMatchesFinMATCHES, AcquirorName, PredictedSales, PredictedCompu, sale, TargetNetSales)

saleview$diff <-
  with(saleview, (PredictedCompu - PredictedSales ) )

saleview$diff2 <- with(saleview, (PredictedCompu - TargetNetSales ) )

median(na.omit(saleview$diff))

saleview$reldiff <- with(saleview, diff/PredictedSales )

mean(na.omit(saleview$diff))
median(na.omit(saleview$diff2))

##############
```


## CREATING THE FIVE SAMPLES BASED ON COMBINATIONS OF SALES SOURCES

```{r CREATING FINAL MATCHED SETS FOR ALL SAMPLES}

## Only for export (showing frame with all sale sources)
SCMatchesAllSaleSources <- data.frame(SCMatchesFinMATCHES)
SCMatchesAllSaleSources <- select(SCMatchesAllSaleSources, conml, AcquirorName, conmT, TargetName, METHOD, yearS, YEARan, 
                              YEARef, sale, TargetNetSales, PredictedSales, PredictedCompu, everything() )


################################################################################################################
#Only Compustat Data: SAMPLE 1
SCMatchesFinPureCompu <- filter(SCMatchesFinMATCHES, !is.na(sale) & yearDiff < 3)

SCMatchesFinPureCompu$TARGET_SALES <- SCMatchesFinPureCompu$sale

SCMatchesFinPureCompu$RevenueShare <- with(SCMatchesFinPureCompu, TARGET_SALES * XofSharesAcq / 100 )

SCMatchesFinPureCompu$SaleSource <- NA

n_distinct(SCMatchesFinPureCompu$gvkey)
length(SCMatchesFinPureCompu$gvkey)

#Primary Compustat, supplemented with SDC Data: SAMPLE 2
SCMatchesFinStandard <- filter(SCMatchesFinMATCHES, !is.na(sale) | !is.na(TargetNetSales) )

SCMatchesFinStandard$TARGET_SALES <- with(SCMatchesFinStandard, 
                                          ifelse(is.na(sale) | yearDiff > 2 ,  TargetNetSales,  sale)   )

SCMatchesFinStandard$SaleSource <- with(SCMatchesFinStandard, 
                                          ifelse(is.na(sale) | yearDiff > 2 ,  "S",  "C")   )

SCMatchesFinStandard$RevenueShare <- with(SCMatchesFinStandard, TARGET_SALES * XofSharesAcq / 100 )

SCMatchesFinStandard <- filter(SCMatchesFinStandard, !is.na(TARGET_SALES))

n_distinct(SCMatchesFinStandard$gvkey)
length(SCMatchesFinStandard$gvkey)

#write.csv(SCMatchesFinStandard, "SCMatchesFinStandard_NABLANK.csv", na = "")

#Primary Compustat, supplemented with SDC Data and Predicted Values SDC: SAMPLE 3
SCMatchesFinMaxedObservations <- filter(SCMatchesFinMATCHES, !is.na(sale) | !is.na(TargetNetSales) | !is.na(TargetSales))

SCMatchesFinMaxedObservations$TARGET_SALES <- with(SCMatchesFinMaxedObservations, 
                                          ifelse(is.na(sale) | yearDiff > 2 ,  TargetNetSales,  sale)   )

SCMatchesFinMaxedObservations$SaleSource <- with(SCMatchesFinMaxedObservations, 
                                          ifelse(is.na(sale) | yearDiff > 2 ,  "S",  "C")   )

SCMatchesFinMaxedObservations$TARGET_SALES <- with(SCMatchesFinMaxedObservations, 
                                          ifelse(is.na(TARGET_SALES)  ,  PredictedSales,  TARGET_SALES)   )

SCMatchesFinMaxedObservations$SaleSource <- with(SCMatchesFinMaxedObservations, 
                                          ifelse(is.na(TARGET_SALES) ,  "P",  SaleSource)   )

SCMatchesFinMaxedObservations$RevenueShare <- with(SCMatchesFinMaxedObservations, TARGET_SALES * XofSharesAcq / 100 )

SCMatchesFinMaxedObservations <- filter(SCMatchesFinMaxedObservations, !is.na(TARGET_SALES))

n_distinct(SCMatchesFinMaxedObservations$gvkey)
length(SCMatchesFinMaxedObservations$gvkey)


#Primary Compustat, supplemented with Predicted Compustat: SAMPLE 4
SCMatchesFinCompuPred <- filter(SCMatchesFinMATCHES, !is.na(sale) | !is.na(PredictedCompu) )

SCMatchesFinCompuPred$TARGET_SALES <- with(SCMatchesFinCompuPred, 
                                          ifelse(is.na(sale) | yearDiff > 2 ,  PredictedCompu,  sale)   )

SCMatchesFinCompuPred$SaleSource <- with(SCMatchesFinCompuPred, 
                                          ifelse(is.na(sale) | yearDiff > 2 ,  "P",  "C")   )

SCMatchesFinCompuPred$RevenueShare <- with(SCMatchesFinCompuPred, TARGET_SALES * XofSharesAcq / 100 )

SCMatchesFinCompuPred <- filter(SCMatchesFinCompuPred, !is.na(TARGET_SALES))

n_distinct(SCMatchesFinCompuPred$gvkey)
length(SCMatchesFinCompuPred$gvkey)


#Only Predicted Values SDC: SAMPLE 5
SCMatchesFinPredicted <- filter(SCMatchesFinMATCHES, !is.na(PredictedSales) )

SCMatchesFinPredicted$TARGET_SALES <- SCMatchesFinPredicted$PredictedSales

SCMatchesFinPredicted$RevenueShare <- with(SCMatchesFinPredicted, TARGET_SALES * XofSharesAcq / 100 )

SCMatchesFinPredicted$SaleSource <- NA

n_distinct(SCMatchesFinPredicted$gvkey)
length(SCMatchesFinPredicted$gvkey)


```


## TRACK DIVESTMENTS

```{r TRACK SELLING TARGETS}

LTViewer <- select(LTargets, gvkey, ROWINDEXsdc, conml, TargetName, AcquirorName, DateEffective, XofSharesAcq, 
                   XOwnedAfterTransaction, ValueofTransactionmil, TargetNetSalesLTMmil, PredictedSales, TargetSales,
                   AcquirorCUSIP,AcqNewCUSIP,AcquirorImmediateParentCUSIP,AcquirorUltimateParentCUSIP,
                   TargetCUSIP,TarNewCUSIP,TargetImmediateParentCUSIP,TargetUltimateParentCUSIP)

LTViewer$YEARef <- substr( LTViewer$DateEffective, start = 1, stop = 4)

LTViewer <- arrange(LTViewer, TargetName)

LTViewer <- filter(LTViewer, AcquirorName != TargetName & !is.na(XofSharesAcq))

LTViewer$mark <- with(LTViewer, ifelse( duplicated(TargetName) |  duplicated(lead(TargetName)), 1,0  ) )

LTViewerRepeated <- filter(LTViewer, mark == 1)

n_distinct(LTViewerRepeated$gvkey)
n_distinct(LTargets$gvkey)

LTViewerRepeated$YearSold <- with(LTViewerRepeated, ifelse( lead(TargetName) == TargetName, lead(YEARef), NA) )

LTViewerRepeated$SumDig <- 1

LTViewerRepeated <- LTViewerRepeated %>% 
  group_by(TargetName) %>% 
  mutate(groupsize = sum(SumDig)) %>% 
  mutate(seqnum = row_number()) 

LTViewerLONG <- LTViewerRepeated %>% group_by(TargetName) %>% slice(rep(1:n(), first(groupsize)))

LTViewerLONG <- LTViewerLONG %>% 
  group_by(TargetName) %>% 
  mutate(AcqRow = sort(AcquirorName) ) %>% 
  mutate(IDRow = sort(ROWINDEXsdc) ) %>% 
  mutate(GroupID = match(IDRow, unique(IDRow))) %>% 
  mutate(TotalOwned = sum(XOwnedAfterTransaction)/groupsize)

LTViewerLONG <- select(LTViewerLONG, ROWINDEXsdc, IDRow, conml, TargetName, AcquirorName, AcqRow, everything())
LTViewerLONG <- select(LTViewerLONG, -ROWINDEXsdc)

LTViewerVALS <- LTViewerLONG %>% 
  group_by(TargetName,IDRow) %>% 
  slice(first(GroupID):n())  %>%
  mutate(InitialStock = first(XOwnedAfterTransaction))  %>% 
  mutate(MAXBID = lead(XofSharesAcq)) %>% 
  mutate(TotalBids = cumsum(MAXBID) )  %>% 
  transform(Remainder = pmax((InitialStock - TotalBids),0 ) )%>% 
  transform(Xsold = ifelse(is.na(lag(Remainder)), pmin(InitialStock,MAXBID), pmin(lag(Remainder),MAXBID) ) ) %>% 
  mutate(Xsold = ifelse(TotalOwned < 100, 0, Xsold) )  %>%
  mutate(TargetSalesYearSold = lead(TargetNetSalesLTMmil) ) %>%
  mutate(TargetSalesYearSoldPred = lead(PredictedSales) )

TargetSalesFULL <- data.frame(LTViewerVALS)

TargetSales <- filter(TargetSalesFULL, !is.na(YearSold) & Xsold > 0)


########
#Clean Target Sales
TargetSalesClean <- data.frame(TargetSales)

TargetSalesClean <- filter(TargetSalesClean, TargetCUSIP != AcquirorCUSIP 
                                  | is.na(TargetCUSIP) | is.na(AcquirorCUSIP))

TargetSalesClean <- filter(TargetSalesClean, TargetCUSIP != AcqNewCUSIP 
                                  | is.na(TargetCUSIP) | is.na(AcqNewCUSIP))

TargetSalesClean <- filter(TargetSalesClean, TargetCUSIP != AcquirorImmediateParentCUSIP 
                                  | is.na(TargetCUSIP) | is.na(AcquirorImmediateParentCUSIP))

TargetSalesClean <- filter(TargetSalesClean, TargetCUSIP != AcquirorUltimateParentCUSIP 
                                  | is.na(TargetCUSIP) | is.na(AcquirorUltimateParentCUSIP))



TargetSalesClean <- filter(TargetSalesClean, TarNewCUSIP != AcquirorCUSIP 
                                  | is.na(TarNewCUSIP) | is.na(AcquirorCUSIP))

TargetSalesClean <- filter(TargetSalesClean, TarNewCUSIP != AcqNewCUSIP 
                                  | is.na(TarNewCUSIP) | is.na(AcqNewCUSIP))

TargetSalesClean <- filter(TargetSalesClean, TarNewCUSIP != AcquirorImmediateParentCUSIP 
                                  | is.na(TarNewCUSIP) | is.na(AcquirorImmediateParentCUSIP))

TargetSalesClean <- filter(TargetSalesClean, TarNewCUSIP != AcquirorUltimateParentCUSIP 
                                  | is.na(TarNewCUSIP) | is.na(AcquirorUltimateParentCUSIP))



TargetSalesClean <- filter(TargetSalesClean, TargetImmediateParentCUSIP != AcquirorCUSIP 
                                  | is.na(TargetImmediateParentCUSIP) | is.na(AcquirorCUSIP))

TargetSalesClean <- filter(TargetSalesClean, TargetImmediateParentCUSIP != AcqNewCUSIP 
                                  | is.na(TargetImmediateParentCUSIP) | is.na(AcqNewCUSIP))

TargetSalesClean <- filter(TargetSalesClean, TargetImmediateParentCUSIP != AcquirorImmediateParentCUSIP 
                                  | is.na(TargetImmediateParentCUSIP) | is.na(AcquirorImmediateParentCUSIP))

TargetSalesClean <- filter(TargetSalesClean, TargetImmediateParentCUSIP != AcquirorUltimateParentCUSIP 
                                  | is.na(TargetImmediateParentCUSIP) | is.na(AcquirorUltimateParentCUSIP))


TargetSalesClean <- filter(TargetSalesClean, TargetUltimateParentCUSIP != AcquirorCUSIP 
                                  | is.na(TargetUltimateParentCUSIP) | is.na(AcquirorCUSIP))

TargetSalesClean <- filter(TargetSalesClean, TargetUltimateParentCUSIP != AcqNewCUSIP 
                                  | is.na(TargetUltimateParentCUSIP) | is.na(AcqNewCUSIP))

TargetSalesClean <- filter(TargetSalesClean, TargetUltimateParentCUSIP != AcquirorImmediateParentCUSIP 
                                  | is.na(TargetUltimateParentCUSIP) | is.na(AcquirorImmediateParentCUSIP))

TargetSalesClean <- filter(TargetSalesClean, TargetUltimateParentCUSIP != AcquirorUltimateParentCUSIP 
                                  | is.na(TargetUltimateParentCUSIP) | is.na(AcquirorUltimateParentCUSIP))


TargetSalesClean <- filter(TargetSalesClean, TargetName != AcquirorName 
                                  | is.na(TargetName) | is.na(AcquirorName))

#OTHER:

TargetSalesClean <- filter(TargetSalesClean, AcquirorName != "Investor Group"  
                          & AcquirorName != "Investors"
                          & AcquirorName != "Shareholders"
                          & AcquirorName != "Creditors"
                          & AcquirorName != "Preferred Shareholders"
                          & AcquirorName != "Investors (Non-US)" | is.na(AcquirorName))


TargetSales <- data.frame(TargetSalesClean)

########
median(TargetSalesStandard$RevenueSold)

########################

TargetSalesForMerge <- select(TargetSales, IDRow, AcqRow, TargetName, gvkey, YearSold, Xsold, 
                              TargetSalesYearSold, TargetSalesYearSoldPred)

TargetSalesForMerge$ROWID <- seq(1:length(TargetSalesForMerge$TargetName ))

SALE_TarTrackMerge <- select(SALES, gvkey, year, conm, sale)

TargetSalesCompuSale <- left_join(TargetSalesForMerge, SALE_TarTrackMerge, by = "gvkey", na_matches = "never")

TargetSalesCompuSale$sale <- TargetSalesCompuSale$sale / 1000

TargetSalesCompuSale$year <- ifelse(is.na(TargetSalesCompuSale$year), 
                                         TargetSalesCompuSale$YearSold,  TargetSalesCompuSale$year)

TargetSalesCompuSale$yearDiff <- abs( as.numeric(TargetSalesCompuSale$year) - as.numeric(TargetSalesCompuSale$YearSold) )

TargetSalesCompuSale <- select(TargetSalesCompuSale, -conm)


TargetSalesCompuSale <- TargetSalesCompuSale %>% 
    group_by(IDRow, ROWID) %>% 

    slice(which.min(yearDiff) )

TargetSalesCompuSale <- arrange(TargetSalesCompuSale, TargetName)

TargetSalesCompuSale <- TargetSalesCompuSale %>% 
  ungroup()


TargetSalesFIN <- select(TargetSalesCompuSale, AcqRow, TargetName, YearSold, yearDiff, Xsold, sale, 
                         TargetSalesYearSold, TargetSalesYearSoldPred)

TargetSalesFIN <- rename(TargetSalesFIN, AcquirorName = AcqRow, AcYear = YearSold)

TargetSalesFIN <- filter(TargetSalesFIN, AcquirorName != "Investor Group" & 
                                   AcquirorName != "Investors (Non-US)" &
                                   AcquirorName != "Creditors" &
                                   AcquirorName != "Shareholders" &
                                   AcquirorName != "Preferred Shareholders" | is.na(AcquirorName))

###################

### CREATE THE RESULTS FOR DIVESTMENTS FOR THE FIVE DIFFERENT SAMPLES
#Only Compustat Data:
TargetSalesPureCompu <- filter(TargetSalesFIN, !is.na(sale) & yearDiff < 3)

TargetSalesPureCompu$TARGET_SALES_SOLD <- TargetSalesPureCompu$sale

TargetSalesPureCompu$RevenueSold <- with(TargetSalesPureCompu, TARGET_SALES_SOLD * Xsold / 100 )


#Primary Compustat, supplemented with SDC Data
TargetSalesStandard <- filter(TargetSalesFIN, !is.na(sale) | !is.na(TargetSalesYearSold) )

TargetSalesStandard$TARGET_SALES_SOLD <- with(TargetSalesStandard, 
                                          ifelse(is.na(sale) | yearDiff > 2 ,  TargetSalesYearSold,  sale)   )

TargetSalesStandard$SaleSourceSold <- with(TargetSalesStandard, 
                                          ifelse(is.na(sale) | yearDiff > 2 ,  "S",  "C")   )

TargetSalesStandard <- filter(TargetSalesStandard, !is.na(TARGET_SALES_SOLD))

TargetSalesStandard$RevenueSold <- with(TargetSalesStandard, TARGET_SALES_SOLD * Xsold / 100 )


#Primary Compustat, supplemented with SDC Data and Predicted Values
TargetSalesMaxedObservations <- filter(TargetSalesFIN, !is.na(sale) | !is.na(TargetSalesYearSold) | 
                                         !is.na(TargetSalesYearSoldPred))

TargetSalesMaxedObservations$TARGET_SALES_SOLD <- with(TargetSalesMaxedObservations, 
                                          ifelse(is.na(sale) | yearDiff > 2 ,  TargetSalesYearSold,  sale)   )

TargetSalesMaxedObservations$SaleSourceSold <- with(TargetSalesMaxedObservations, 
                                          ifelse(is.na(sale) | yearDiff > 2 ,  "S",  "C")   )

TargetSalesMaxedObservations$TARGET_SALES_SOLD <- with(TargetSalesMaxedObservations, 
                                          ifelse(is.na(TARGET_SALES_SOLD)  ,  TargetSalesYearSoldPred,  TARGET_SALES_SOLD)   )

TargetSalesMaxedObservations$SaleSourceSold <- with(TargetSalesMaxedObservations, 
                                          ifelse(is.na(TARGET_SALES_SOLD) ,  "P",  SaleSourceSold)   )

TargetSalesMaxedObservations <- filter(TargetSalesMaxedObservations, !is.na(TARGET_SALES_SOLD))

TargetSalesMaxedObservations$RevenueSold <- with(TargetSalesMaxedObservations, TARGET_SALES_SOLD * Xsold / 100 )

#Primary Compustat, supplemented with Predicted Values
TargetSalesCompuPred <- filter(TargetSalesFIN, !is.na(sale) | !is.na(TargetSalesYearSoldPred))

TargetSalesCompuPred$TARGET_SALES_SOLD <- with(TargetSalesCompuPred, 
                                          ifelse(is.na(sale) | yearDiff > 2 ,  TargetSalesYearSoldPred,  sale)   )

TargetSalesCompuPred$SaleSourceSold <- with(TargetSalesCompuPred, 
                                          ifelse(is.na(sale) | yearDiff > 2 ,  "P",  "C")   )


TargetSalesCompuPred <- filter(TargetSalesCompuPred, !is.na(TARGET_SALES_SOLD))

TargetSalesCompuPred$RevenueSold <- with(TargetSalesCompuPred, TARGET_SALES_SOLD * Xsold / 100 )


#Only Predicted Values
TargetSalesPredicted <- filter(TargetSalesFIN, !is.na(TargetSalesYearSoldPred) )

TargetSalesPredicted$TARGET_SALES_SOLD <- TargetSalesPredicted$TargetSalesYearSoldPred

TargetSalesPredicted$RevenueSold <- with(TargetSalesPredicted, TARGET_SALES_SOLD * Xsold / 100 )


```


## CREATING THE FINAL LONGITUDINAL DATA STRUCTURE

  REPEATING COMPUTATIONS FOR EVERY SAMPLE
  
  -> SAMPLE 1

```{r MAIN OUTPUT: Pure Compustat}

## AGGREGATING FOR EACH YEAR
SCMatchesAgg <- with(SCMatchesFinPureCompu, data.frame(gvkey = gvkey, conml = conml, AcquirorName = AcquirorName,
                                                     TargetName = TargetName,TransactionValue = ValueofTransactionmil, 
                                                     Year = YEARef, AcquiredSales = round(RevenueShare,3), 
                                                     RevenueTargets = TARGET_SALES, 
                                                     Transaction = 1,
                                                     AcquirorState = AcquirorState, 
                                                     AcquirorSIC = AcquirorPrimarySICCode, AcquirorNation = AcquirorNation,
                                                     SaleSource = SaleSource) )

sum(is.na(SCMatchesAgg$RevenueAcquired))
n_distinct(SCMatchesAgg$conml)
n_distinct(SCMatchesAgg$gvkey)

SCMatchesAgg <- SCMatchesAgg %>% 
  group_by(gvkey, Year) %>%                            
  summarise(SumTransactions = sum(TransactionValue), NumberTransactions = sum(Transaction), 
            RevenueAcquired = sum(AcquiredSales), Targets = list(TargetName), conml = first(conml),
            AcquirorName = first(AcquirorName), RevenueTargets = sum(RevenueTargets),
            AcquirorState = first(AcquirorState), AcquirorSIC = first(AcquirorSIC), AcquirorNation = first(AcquirorNation),
            SaleSource = list(SaleSource))

SCMatchesAgg <- select(SCMatchesAgg, gvkey, conml, AcquirorName, Targets, Year, everything())

SCMatchesAgg <- arrange(SCMatchesAgg, desc(SumTransactions), Year)

SCMatchesAgg$Targets <- as.character(SCMatchesAgg$Targets)
SCMatchesAgg$Targets <- gsub('"', "", SCMatchesAgg$Targets, fixed = TRUE)
SCMatchesAgg$Targets <- gsub('c(', "", SCMatchesAgg$Targets, fixed = TRUE)
SCMatchesAgg$Targets <- gsub(')', "", SCMatchesAgg$Targets, fixed = TRUE)
SCMatchesAgg$Targets <- gsub(',', "  | ", SCMatchesAgg$Targets, fixed = TRUE)

SCMatchesAgg$SaleSource <- as.character(SCMatchesAgg$SaleSource)
SCMatchesAgg$SaleSource <- gsub('"', "", SCMatchesAgg$SaleSource, fixed = TRUE)
SCMatchesAgg$SaleSource <- gsub('c(', "", SCMatchesAgg$SaleSource, fixed = TRUE)
SCMatchesAgg$SaleSource <- gsub(')', "", SCMatchesAgg$SaleSource, fixed = TRUE)
SCMatchesAgg$SaleSource <- gsub(',', "  | ", SCMatchesAgg$SaleSource, fixed = TRUE)

n_distinct(SCMatchesAgg$conml)

SaleSourceForMerge <- select(SCMatchesAgg, gvkey, Year, SaleSource)


############################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################
# PREPARING DIVESTMENTS SO THEY CAN BE ASSIGNED

TargetSalesFINforMerge <- select(TargetSalesPureCompu, 
                                 -Xsold, - TargetSalesYearSold, -TargetSalesYearSoldPred, -sale, -TARGET_SALES_SOLD)

TargetSalesFINforMerge <- TargetSalesFINforMerge  %>% 
  group_by(TargetName, AcquirorName, AcYear) %>%                            
  summarise(RevenueSold = sum(RevenueSold), TargetName = first(TargetName), AcquirorName = first(AcquirorName))

TargetSalesFINforMerge <- rename(TargetSalesFINforMerge, TargetSold = TargetName)
TargetSalesFINforMerge <- select(TargetSalesFINforMerge, AcquirorName, everything())

SCMatchesRevs <- data.frame(SCMatchesAgg)
SCMatchesRevs$yearID <- seq(1:length(SCMatchesRevs$gvkey))
SCMatchesRevs <- rename(SCMatchesRevs, TransactionYear = Year)

SALESAgg <- data.frame(SALES)
SALESAgg <- select(SALESAgg, gvkey, conm, year, sale)
SALESAgg <- rename(SALESAgg, AcYear = year, conmA = conm, saleAc = sale)
SALESAgg$saleAc <- SALESAgg$saleAc/1000


SCMatchesRevs <- left_join(SCMatchesRevs, SALESAgg, by = "gvkey")

SCMatchesRevs <- arrange(SCMatchesRevs, gvkey, TransactionYear)

SCMatchesRevs$YearDiff <- as.numeric(SCMatchesRevs$AcYear) - as.numeric(SCMatchesRevs$TransactionYear) 


SCMatchesRevs$RevAcquiredInYear <- ifelse(SCMatchesRevs$YearDiff == 0, 
                                         SCMatchesRevs$RevenueAcquired, 0)

SCMatchesRevs <- select(SCMatchesRevs, gvkey, conml, Targets, AcYear, TransactionYear,YearDiff, saleAc, 
                         RevAcquiredInYear, RevenueAcquired, SumTransactions, SaleSource, everything())

SCMatchesRevs <- arrange(SCMatchesRevs, desc(SumTransactions))

n_distinct(SCMatchesRevs$gvkey)

YearObservations <- aggregate(YearDiff ~ gvkey, data = SCMatchesRevs, max)
EnoughYearObservations <- filter(YearObservations, YearDiff > 0)
EnoughYearObservations <- select(EnoughYearObservations, -YearDiff)

SCMatchesRevs <- left_join(EnoughYearObservations, SCMatchesRevs, by = "gvkey")
SCMatchesRevs <- arrange(SCMatchesRevs, gvkey, AcYear)

n_distinct(SCMatchesRevs$gvkey)

ConstructionSet <- select(SCMatchesRevs, gvkey, TransactionYear, RevenueAcquired, Targets, SumTransactions)
ConstructionSet <- ConstructionSet %>% 
  group_by(gvkey) %>%                            
  distinct(TransactionYear, .keep_all = TRUE)

ConstructionSet$TransactionYear <- as.numeric(ConstructionSet$TransactionYear )
ConstructionSet <- rename(ConstructionSet, REVACQ = RevenueAcquired, TNames =  Targets, SumTr = SumTransactions) 

SCMatchesRevs <- left_join(SCMatchesRevs, ConstructionSet, by = c("gvkey" = "gvkey", "AcYear" = "TransactionYear"))


SCMatchesRevs <- SCMatchesRevs %>% 
  group_by(gvkey) %>% 
  mutate(minYear = min(TransactionYear)) %>% 
  filter(TransactionYear == minYear)


SCMatchesRevs <- select(SCMatchesRevs, gvkey, conml, AcYear, Targets, TNames, TransactionYear,YearDiff, saleAc, 
                         RevAcquiredInYear, REVACQ, RevenueAcquired, SumTransactions, everything())

SCMatchesRevs <- select(SCMatchesRevs, -Targets, - TransactionYear, -minYear, -RevenueAcquired, -RevAcquiredInYear,
                         -conmA, -RevenueTargets, -YearDiff, - SumTransactions)
SCMatchesRevs <- rename(SCMatchesRevs, Targets = TNames, RevenueAcquired = REVACQ, SumTransactions = SumTr)

SCMatchesRevs$RevenueAcquired <- replace(SCMatchesRevs$RevenueAcquired,is.na(SCMatchesRevs$RevenueAcquired), 0   ) 
SCMatchesRevs$AcYear <- as.character(SCMatchesRevs$AcYear)

## ASSIGNING DIVESTMENTS
SCMatchesRevs <- left_join(SCMatchesRevs, TargetSalesFINforMerge, by = c("AcquirorName", "AcYear"), na_matches = "never" )

SCMatchesRevs$ID <- seq(1:length(SCMatchesRevs$gvkey))

SCMatchesRevsSelling <- SCMatchesRevs %>%
  group_by(ID)  %>%
  mutate(TargetSold=ifelse( grepl(str_replace_all(TargetSold, " ", ""), str_replace_all(Targets, " ", "")), NA,TargetSold)) %>%
  mutate(RevenueSold=ifelse( grepl(str_replace_all(TargetSold, " ", ""), str_replace_all(Targets, " ", "")), NA,RevenueSold))

SCMatchesRevsSelling <- SCMatchesRevsSelling %>%
  group_by(gvkey, AcYear)  %>%
  summarise(gvkey = first(gvkey), conml = first(conml), AcYear = first(AcYear), Targets = first(Targets), 
            saleAc = first(saleAc), RevenueAcquired = first(RevenueAcquired), AcquirorName = first(AcquirorName),
            NumberTransactions = first(NumberTransactions), AcquirorState = first(AcquirorState),
            AcquirorSIC = first(AcquirorSIC), AcquirorNation = first(AcquirorNation), yearID = first(yearID),
            SumTransactions = first(SumTransactions), TargetSold = list(TargetSold), RevenueSold = sum(RevenueSold))
  

SCMatchesRevsSelling <- SCMatchesRevsSelling %>%
    mutate(RevenueAcquired = if_else(is.na(RevenueAcquired), 0, RevenueAcquired)) %>%
    mutate(RevenueSold = if_else(is.na(RevenueSold), 0, RevenueSold)) 


SCMatchesRevsSelling$NetRevTransactions <- with(SCMatchesRevsSelling,  RevenueAcquired -  RevenueSold  )

SCMatchesRevsSelling$TargetSold <- as.character(SCMatchesRevsSelling$TargetSold)
SCMatchesRevsSelling$TargetSold <- gsub('"', "", SCMatchesRevsSelling$TargetSold, fixed = TRUE)
SCMatchesRevsSelling$TargetSold <- gsub('c(', "", SCMatchesRevsSelling$TargetSold, fixed = TRUE)
SCMatchesRevsSelling$TargetSold <- gsub(')', "", SCMatchesRevsSelling$TargetSold, fixed = TRUE)
SCMatchesRevsSelling$TargetSold <- gsub(',', "  | ", SCMatchesRevsSelling$TargetSold, fixed = TRUE)


SCMatchesRevsSelling <- select(SCMatchesRevsSelling, gvkey, conml, AcYear, saleAc, Targets, RevenueAcquired,
                               TargetSold, RevenueSold, NetRevTransactions, everything())

SCMatchesRevsSelling <- rename(SCMatchesRevsSelling, TargetsSold = TargetSold, TargetsAcquired = Targets)


SCMatchesNetRevs <- data.frame(SCMatchesRevsSelling)

## MAIN COMPUTATIONS
SCMatchesNetRevs <- SCMatchesNetRevs %>% 
  group_by(gvkey) %>% 
  mutate(CumuRevAcquired = cumsum(NetRevTransactions)) %>% 
  mutate(InternalRevenue = saleAc - CumuRevAcquired) %>% 
  mutate(SaleGrowth = saleAc - lag(saleAc)) %>% 
  mutate(CumuSaleGrowth = cumsum(  replace(SaleGrowth,is.na(SaleGrowth), 0) )  ) %>% 
  mutate(InternalRevGrowth = InternalRevenue - lag(InternalRevenue)) %>% 
  mutate(GrowthShareOfAcquisition = round(CumuRevAcquired / CumuSaleGrowth,3) ) %>% 
  mutate(GrowthShareOfAcquisition = replace(GrowthShareOfAcquisition , is.na(GrowthShareOfAcquisition ), NA)) %>% 
  mutate(GrowthShareOfAcquisition =  ifelse(GrowthShareOfAcquisition<0, NA,GrowthShareOfAcquisition ))  %>% 
  mutate(CumuSpentOnAcqui = cumsum(  replace(SumTransactions,is.na(SumTransactions), 0) )  ) %>% 
  mutate(RevenueShare_A =  round(CumuRevAcquired / saleAc,3) )  %>% 
  mutate(RevenueShare_A =  ifelse(RevenueShare_A<0, NA,RevenueShare_A ))  %>% 
  mutate(RevenueShare_V = round( (NetRevTransactions / SaleGrowth ) , 3) ) %>% 
  mutate(RevenueShare_V =  ifelse(RevenueShare_V<0, NA,RevenueShare_V ))  %>% 
  rationalize()

SCMatchesNetRevs <- left_join(SCMatchesNetRevs, SaleSourceForMerge, by = c("gvkey" = "gvkey", "AcYear" = "Year"), 
                                  na_matches = "never")

SCMatchesNetRevs <- select(SCMatchesNetRevs, gvkey, conml, AcYear, saleAc, SaleGrowth,CumuSaleGrowth, TargetsAcquired,
                        RevenueAcquired, TargetsSold, RevenueSold,NetRevTransactions, CumuRevAcquired, InternalRevenue,
                        InternalRevGrowth, RevenueShare_A, RevenueShare_V, GrowthShareOfAcquisition, SumTransactions, 
                        CumuSpentOnAcqui, SaleSource, everything())


SCMatchesNetRevsPureCompu <- data.frame(SCMatchesNetRevs)

#write.csv(SCMatchesNetRevs, "NetAcquisitionsAndRevenues.csv")
#write.csv(SCMatchesNetRevs, "NetAcquisitionsAndRevenues_NABlank.csv", na = "")

## COMPUTING SUMMARY STATISTICS
NetRevsAggPureCompu <- SCMatchesNetRevsPureCompu %>% 
  group_by(gvkey) %>% 
  summarise(conml = first(conml), FinalGrowthShare = last(GrowthShareOfAcquisition), 
            MeanGrowthShare = mean(na.omit(GrowthShareOfAcquisition)), 
            MeanRevenueShare_A = mean(na.omit(RevenueShare_A)),
            MeanRevenueShare_V = mean(na.omit(RevenueShare_V)),
            FinalSales = last(saleAc), FinalSalesShare_A = last(CumuRevAcquired)/last(saleAc))


SampleCompu <- SCMatchesNetRevsPureCompu %>%
  group_by(gvkey) %>%
  summarise(Observations = n(), NumberOfTransactions = first(NumberTransactions),
            TransactionVolume = sum(SumTransactions, na.rm = T), RevAc = sum(RevenueAcquired, na.rm = T))

## GATHERING SOME SAMPLE CHARACHTERISTICS
SampleInfoCompuSumarry <- SampleCompu %>%
  summarise(mOservations = mean(Observations, na.rm = T), medObservations = median(Observations, na.rm = T),
            mNumber = mean(NumberOfTransactions, na.rm = T), medNumber = median(NumberOfTransactions, na.rm = T),
            mVolume = mean(TransactionVolume, na.rm = T), medVolume = median(TransactionVolume, na.rm = T),
            mRevAc = mean(RevAc, na.rm = T),  medRevAc = median(RevAc, na.rm = T))

```


  -> SAMPLE 2
  
```{r MAIN OUTPUT: Standard Sales}

## SAME COMPUTATIONS AS FOR SAMPLE ONE

SCMatchesAgg <- with(SCMatchesFinStandard, data.frame(gvkey = gvkey, conml = conml, AcquirorName = AcquirorName,
                                                     TargetName = TargetName,TransactionValue = ValueofTransactionmil, 
                                                     Year = YEARef, AcquiredSales = round(RevenueShare,3), 
                                                     RevenueTargets = TARGET_SALES, 
                                                     Transaction = 1,
                                                     AcquirorState = AcquirorState, 
                                                     AcquirorSIC = AcquirorPrimarySICCode, AcquirorNation = AcquirorNation,
                                                     SaleSource = SaleSource) )

sum(is.na(SCMatchesAgg$RevenueAcquired))
n_distinct(SCMatchesAgg$conml)
n_distinct(SCMatchesAgg$gvkey)

SCMatchesAgg <- SCMatchesAgg %>% 
  group_by(gvkey, Year) %>%                            
  summarise(SumTransactions = sum(TransactionValue), NumberTransactions = sum(Transaction), 
            RevenueAcquired = sum(AcquiredSales), Targets = list(TargetName), conml = first(conml),
            AcquirorName = first(AcquirorName), RevenueTargets = sum(RevenueTargets),
            AcquirorState = first(AcquirorState), AcquirorSIC = first(AcquirorSIC), AcquirorNation = first(AcquirorNation),
            SaleSource = list(SaleSource))

SCMatchesAgg <- select(SCMatchesAgg, gvkey, conml, AcquirorName, Targets, Year, everything())

SCMatchesAgg <- arrange(SCMatchesAgg, desc(SumTransactions), Year)

SCMatchesAgg$Targets <- as.character(SCMatchesAgg$Targets)
SCMatchesAgg$Targets <- gsub('"', "", SCMatchesAgg$Targets, fixed = TRUE)
SCMatchesAgg$Targets <- gsub('c(', "", SCMatchesAgg$Targets, fixed = TRUE)
SCMatchesAgg$Targets <- gsub(')', "", SCMatchesAgg$Targets, fixed = TRUE)
SCMatchesAgg$Targets <- gsub(',', "  | ", SCMatchesAgg$Targets, fixed = TRUE)

SCMatchesAgg$SaleSource <- as.character(SCMatchesAgg$SaleSource)
SCMatchesAgg$SaleSource <- gsub('"', "", SCMatchesAgg$SaleSource, fixed = TRUE)
SCMatchesAgg$SaleSource <- gsub('c(', "", SCMatchesAgg$SaleSource, fixed = TRUE)
SCMatchesAgg$SaleSource <- gsub(')', "", SCMatchesAgg$SaleSource, fixed = TRUE)
SCMatchesAgg$SaleSource <- gsub(',', "  | ", SCMatchesAgg$SaleSource, fixed = TRUE)

n_distinct(SCMatchesAgg$conml)

SaleSourceForMerge <- select(SCMatchesAgg, gvkey, Year, SaleSource)


############################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################

TargetSalesFINforMerge <- select(TargetSalesStandard, 
                                 -Xsold, - TargetSalesYearSold, -TargetSalesYearSoldPred, -sale, -TARGET_SALES_SOLD)

TargetSalesFINforMerge <- TargetSalesFINforMerge  %>% 
  group_by(TargetName, AcquirorName, AcYear) %>%                            
  summarise(RevenueSold = sum(RevenueSold), TargetName = first(TargetName), AcquirorName = first(AcquirorName))

TargetSalesFINforMerge <- rename(TargetSalesFINforMerge, TargetSold = TargetName)
TargetSalesFINforMerge <- select(TargetSalesFINforMerge, AcquirorName, everything())

SCMatchesRevs <- data.frame(SCMatchesAgg)
SCMatchesRevs$yearID <- seq(1:length(SCMatchesRevs$gvkey))
SCMatchesRevs <- rename(SCMatchesRevs, TransactionYear = Year)

SALESAgg <- data.frame(SALES)
SALESAgg <- select(SALESAgg, gvkey, conm, year, sale)
SALESAgg <- rename(SALESAgg, AcYear = year, conmA = conm, saleAc = sale)
SALESAgg$saleAc <- SALESAgg$saleAc/1000


SCMatchesRevs <- left_join(SCMatchesRevs, SALESAgg, by = "gvkey")

SCMatchesRevs <- arrange(SCMatchesRevs, gvkey, TransactionYear)

SCMatchesRevs$YearDiff <- as.numeric(SCMatchesRevs$AcYear) - as.numeric(SCMatchesRevs$TransactionYear) 


SCMatchesRevs$RevAcquiredInYear <- ifelse(SCMatchesRevs$YearDiff == 0, 
                                         SCMatchesRevs$RevenueAcquired, 0)

SCMatchesRevs <- select(SCMatchesRevs, gvkey, conml, Targets, AcYear, TransactionYear,YearDiff, saleAc, 
                         RevAcquiredInYear, RevenueAcquired, SumTransactions, SaleSource, everything())

SCMatchesRevs <- arrange(SCMatchesRevs, desc(SumTransactions))

n_distinct(SCMatchesRevs$gvkey)

YearObservations <- aggregate(YearDiff ~ gvkey, data = SCMatchesRevs, max)
EnoughYearObservations <- filter(YearObservations, YearDiff > 0)
EnoughYearObservations <- select(EnoughYearObservations, -YearDiff)

SCMatchesRevs <- left_join(EnoughYearObservations, SCMatchesRevs, by = "gvkey")
SCMatchesRevs <- arrange(SCMatchesRevs, gvkey, AcYear)

n_distinct(SCMatchesRevs$gvkey)

ConstructionSet <- select(SCMatchesRevs, gvkey, TransactionYear, RevenueAcquired, Targets, SumTransactions)
ConstructionSet <- ConstructionSet %>% 
  group_by(gvkey) %>%                            
  distinct(TransactionYear, .keep_all = TRUE)

ConstructionSet$TransactionYear <- as.numeric(ConstructionSet$TransactionYear )
ConstructionSet <- rename(ConstructionSet, REVACQ = RevenueAcquired, TNames =  Targets, SumTr = SumTransactions) 

SCMatchesRevs <- left_join(SCMatchesRevs, ConstructionSet, by = c("gvkey" = "gvkey", "AcYear" = "TransactionYear"))


SCMatchesRevs <- SCMatchesRevs %>% 
  group_by(gvkey) %>% 
  mutate(minYear = min(TransactionYear)) %>% 
  filter(TransactionYear == minYear)


SCMatchesRevs <- select(SCMatchesRevs, gvkey, conml, AcYear, Targets, TNames, TransactionYear,YearDiff, saleAc, 
                         RevAcquiredInYear, REVACQ, RevenueAcquired, SumTransactions, everything())

SCMatchesRevs <- select(SCMatchesRevs, -Targets, - TransactionYear, -minYear, -RevenueAcquired, -RevAcquiredInYear,
                         -conmA, -RevenueTargets, -YearDiff, - SumTransactions)
SCMatchesRevs <- rename(SCMatchesRevs, Targets = TNames, RevenueAcquired = REVACQ, SumTransactions = SumTr)

SCMatchesRevs$RevenueAcquired <- replace(SCMatchesRevs$RevenueAcquired,is.na(SCMatchesRevs$RevenueAcquired), 0   ) 
SCMatchesRevs$AcYear <- as.character(SCMatchesRevs$AcYear)

SCMatchesRevs <- left_join(SCMatchesRevs, TargetSalesFINforMerge, by = c("AcquirorName", "AcYear"), na_matches = "never" )

SCMatchesRevs$ID <- seq(1:length(SCMatchesRevs$gvkey))

SCMatchesRevsSelling <- SCMatchesRevs %>%
  group_by(ID)  %>%
  mutate(TargetSold=ifelse( grepl(str_replace_all(TargetSold, " ", ""), str_replace_all(Targets, " ", "")), NA,TargetSold)) %>%
  mutate(RevenueSold=ifelse( grepl(str_replace_all(TargetSold, " ", ""), str_replace_all(Targets, " ", "")), NA,RevenueSold))

SCMatchesRevsSelling <- SCMatchesRevsSelling %>%
  group_by(gvkey, AcYear)  %>%
  summarise(gvkey = first(gvkey), conml = first(conml), AcYear = first(AcYear), Targets = first(Targets), 
            saleAc = first(saleAc), RevenueAcquired = first(RevenueAcquired), AcquirorName = first(AcquirorName),
            NumberTransactions = first(NumberTransactions), AcquirorState = first(AcquirorState),
            AcquirorSIC = first(AcquirorSIC), AcquirorNation = first(AcquirorNation), yearID = first(yearID),
            SumTransactions = first(SumTransactions), TargetSold = list(TargetSold), RevenueSold = sum(RevenueSold))
  

SCMatchesRevsSelling <- SCMatchesRevsSelling %>%
    mutate(RevenueAcquired = if_else(is.na(RevenueAcquired), 0, RevenueAcquired)) %>%
    mutate(RevenueSold = if_else(is.na(RevenueSold), 0, RevenueSold)) 


SCMatchesRevsSelling$NetRevTransactions <- with(SCMatchesRevsSelling,  RevenueAcquired -  RevenueSold  )

SCMatchesRevsSelling$TargetSold <- as.character(SCMatchesRevsSelling$TargetSold)
SCMatchesRevsSelling$TargetSold <- gsub('"', "", SCMatchesRevsSelling$TargetSold, fixed = TRUE)
SCMatchesRevsSelling$TargetSold <- gsub('c(', "", SCMatchesRevsSelling$TargetSold, fixed = TRUE)
SCMatchesRevsSelling$TargetSold <- gsub(')', "", SCMatchesRevsSelling$TargetSold, fixed = TRUE)
SCMatchesRevsSelling$TargetSold <- gsub(',', "  | ", SCMatchesRevsSelling$TargetSold, fixed = TRUE)


SCMatchesRevsSelling <- select(SCMatchesRevsSelling, gvkey, conml, AcYear, saleAc, Targets, RevenueAcquired,
                               TargetSold, RevenueSold, NetRevTransactions, everything())

SCMatchesRevsSelling <- rename(SCMatchesRevsSelling, TargetsSold = TargetSold, TargetsAcquired = Targets)


SCMatchesNetRevs <- data.frame(SCMatchesRevsSelling)


SCMatchesNetRevs <- SCMatchesNetRevs %>% 
  group_by(gvkey) %>% 
  mutate(Observations =  row_number() )  %>%
  mutate(CumuRevAcquired = cumsum(NetRevTransactions)) %>% 
  mutate(InternalRevenue = saleAc - CumuRevAcquired) %>% 
  mutate(SaleGrowth = saleAc - lag(saleAc)) %>% 
  mutate(CumuSaleGrowth = cumsum(  replace(SaleGrowth,is.na(SaleGrowth), 0) )  ) %>% 
  mutate(InternalRevGrowth = InternalRevenue - lag(InternalRevenue)) %>% 
  mutate(GrowthShareOfAcquisition = round(CumuRevAcquired / CumuSaleGrowth,3) ) %>% 
  mutate(GrowthShareOfAcquisition = replace(GrowthShareOfAcquisition , is.na(GrowthShareOfAcquisition ), NA)) %>% 
  mutate(GrowthShareOfAcquisition =  ifelse(GrowthShareOfAcquisition<0, NA,GrowthShareOfAcquisition ))  %>% 
  mutate(CumuSpentOnAcqui = cumsum(  replace(SumTransactions,is.na(SumTransactions), 0) )  ) %>% 
  mutate(RevenueShare_A =  round(CumuRevAcquired / saleAc,3) )  %>% 
  mutate(RevenueShare_A =  ifelse(RevenueShare_A<0, NA,RevenueShare_A ))  %>% 
  mutate(RevenueShare_V = round( (NetRevTransactions / SaleGrowth ) , 3) ) %>% 
  mutate(RevenueShare_V =  ifelse(RevenueShare_V<0, NA,RevenueShare_V ))  %>% 
  rationalize()

sum(is.na(SCMatchesNetRevs$GrowthShareOfAcquisition)) - n_distinct(SCMatchesNetRevs$gvkey)

lookrev <- filter(SCMatchesNetRevs, SaleGrowth < 0) #& SaleGrowth < 0)


SCMatchesNetRevs <- left_join(SCMatchesNetRevs, SaleSourceForMerge, by = c("gvkey" = "gvkey", "AcYear" = "Year"), 
                                  na_matches = "never")

SCMatchesNetRevs <- select(SCMatchesNetRevs, gvkey, conml, AcYear, saleAc, SaleGrowth,CumuSaleGrowth, TargetsAcquired,
                        RevenueAcquired, TargetsSold, RevenueSold,NetRevTransactions, CumuRevAcquired, InternalRevenue,
                        InternalRevGrowth, RevenueShare_A, RevenueShare_V, GrowthShareOfAcquisition, SumTransactions, 
                        CumuSpentOnAcqui, SaleSource, everything())


SCMatchesNetRevsStandard <- data.frame(SCMatchesNetRevs)



NetRevsAggStandard <- SCMatchesNetRevsStandard %>% 
  group_by(gvkey) %>% 
  summarise(conml = first(conml), FinalGrowthShare = last(GrowthShareOfAcquisition), 
            MeanGrowthShare = mean(na.omit(GrowthShareOfAcquisition)), 
            MeanRevenueShare_A = mean(na.omit(RevenueShare_A)),
            MeanRevenueShare_V = mean(na.omit(RevenueShare_V)),
            FinalSales = last(saleAc), FinalSalesShare_A = last(CumuRevAcquired)/last(saleAc))


## STATISTIC FOR YASSG IF ZERO YEARS ARE NOT CONSIDERED
YASSGnoZeros  <- SCMatchesNetRevsStandard %>%
  group_by(gvkey) %>%
  mutate(yassg = ifelse(RevenueShare_V == 0, NA, RevenueShare_V))

mean(YASSGnoZeros$yassg, na.rm = T)


SampleInfoStandard <- SCMatchesNetRevsStandard %>%
  group_by(gvkey) %>%
  summarise(Observations = n(), NumberOfTransactions = first(NumberTransactions),
            TransactionVolume = sum(SumTransactions, na.rm = T), RevAc = sum(RevenueAcquired, na.rm = T))

SampleInfoStandardSumarry <- SampleInfoStandard %>%
  summarise(mOservations = mean(Observations, na.rm = T), medObservations = median(Observations, na.rm = T),
            mNumber = mean(NumberOfTransactions, na.rm = T), medNumber = median(NumberOfTransactions, na.rm = T),
            mVolume = mean(TransactionVolume, na.rm = T), medVolume = median(TransactionVolume, na.rm = T),
            mRevAc = mean(RevAc, na.rm = T),  medRevAc = median(RevAc, na.rm = T))


#write.csv(SCMatchesNetRevs, "NetAcquisitionsAndRevenues.csv")
#write.csv(SCMatchesNetRevs, "NetAcquisitionsAndRevenues_NABlank.csv", na = "")

```

  
  -> SAMPLE 3
  
```{r MAIN OUTPUT: Maxed Observations}

## SAME COMPUTATIONS AS FOR SAMPLE ONE

SCMatchesAgg <- with(SCMatchesFinMaxedObservations, data.frame(gvkey = gvkey, conml = conml, AcquirorName = AcquirorName,
                                                     TargetName = TargetName,TransactionValue = ValueofTransactionmil, 
                                                     Year = YEARef, AcquiredSales = round(RevenueShare,3), 
                                                     RevenueTargets = TARGET_SALES, 
                                                     Transaction = 1,
                                                     AcquirorState = AcquirorState, 
                                                     AcquirorSIC = AcquirorPrimarySICCode, AcquirorNation = AcquirorNation,
                                                     SaleSource = SaleSource) )

sum(is.na(SCMatchesAgg$RevenueAcquired))
n_distinct(SCMatchesAgg$conml)
n_distinct(SCMatchesAgg$gvkey)

SCMatchesAgg <- SCMatchesAgg %>% 
  group_by(gvkey, Year) %>%                            
  summarise(SumTransactions = sum(TransactionValue), NumberTransactions = sum(Transaction), 
            RevenueAcquired = sum(AcquiredSales), Targets = list(TargetName), conml = first(conml),
            AcquirorName = first(AcquirorName), RevenueTargets = sum(RevenueTargets),
            AcquirorState = first(AcquirorState), AcquirorSIC = first(AcquirorSIC), AcquirorNation = first(AcquirorNation),
            SaleSource = list(SaleSource))

SCMatchesAgg <- select(SCMatchesAgg, gvkey, conml, AcquirorName, Targets, Year, everything())

SCMatchesAgg <- arrange(SCMatchesAgg, desc(SumTransactions), Year)

SCMatchesAgg$Targets <- as.character(SCMatchesAgg$Targets)
SCMatchesAgg$Targets <- gsub('"', "", SCMatchesAgg$Targets, fixed = TRUE)
SCMatchesAgg$Targets <- gsub('c(', "", SCMatchesAgg$Targets, fixed = TRUE)
SCMatchesAgg$Targets <- gsub(')', "", SCMatchesAgg$Targets, fixed = TRUE)
SCMatchesAgg$Targets <- gsub(',', "  | ", SCMatchesAgg$Targets, fixed = TRUE)

SCMatchesAgg$SaleSource <- as.character(SCMatchesAgg$SaleSource)
SCMatchesAgg$SaleSource <- gsub('"', "", SCMatchesAgg$SaleSource, fixed = TRUE)
SCMatchesAgg$SaleSource <- gsub('c(', "", SCMatchesAgg$SaleSource, fixed = TRUE)
SCMatchesAgg$SaleSource <- gsub(')', "", SCMatchesAgg$SaleSource, fixed = TRUE)
SCMatchesAgg$SaleSource <- gsub(',', "  | ", SCMatchesAgg$SaleSource, fixed = TRUE)

n_distinct(SCMatchesAgg$conml)

SaleSourceForMerge <- select(SCMatchesAgg, gvkey, Year, SaleSource)


############################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################

TargetSalesFINforMerge <- select(TargetSalesMaxedObservations, 
                                 -Xsold, - TargetSalesYearSold, -TargetSalesYearSoldPred, -sale, -TARGET_SALES_SOLD)

TargetSalesFINforMerge <- TargetSalesFINforMerge  %>% 
  group_by(TargetName, AcquirorName, AcYear) %>%                            
  summarise(RevenueSold = sum(RevenueSold), TargetName = first(TargetName), AcquirorName = first(AcquirorName))

TargetSalesFINforMerge <- rename(TargetSalesFINforMerge, TargetSold = TargetName)
TargetSalesFINforMerge <- select(TargetSalesFINforMerge, AcquirorName, everything())

SCMatchesRevs <- data.frame(SCMatchesAgg)
SCMatchesRevs$yearID <- seq(1:length(SCMatchesRevs$gvkey))
SCMatchesRevs <- rename(SCMatchesRevs, TransactionYear = Year)

SALESAgg <- data.frame(SALES)
SALESAgg <- select(SALESAgg, gvkey, conm, year, sale)
SALESAgg <- rename(SALESAgg, AcYear = year, conmA = conm, saleAc = sale)
SALESAgg$saleAc <- SALESAgg$saleAc/1000


SCMatchesRevs <- left_join(SCMatchesRevs, SALESAgg, by = "gvkey")

SCMatchesRevs <- arrange(SCMatchesRevs, gvkey, TransactionYear)

SCMatchesRevs$YearDiff <- as.numeric(SCMatchesRevs$AcYear) - as.numeric(SCMatchesRevs$TransactionYear) 


SCMatchesRevs$RevAcquiredInYear <- ifelse(SCMatchesRevs$YearDiff == 0, 
                                         SCMatchesRevs$RevenueAcquired, 0)

SCMatchesRevs <- select(SCMatchesRevs, gvkey, conml, Targets, AcYear, TransactionYear,YearDiff, saleAc, 
                         RevAcquiredInYear, RevenueAcquired, SumTransactions, SaleSource, everything())

SCMatchesRevs <- arrange(SCMatchesRevs, desc(SumTransactions))

n_distinct(SCMatchesRevs$gvkey)

YearObservations <- aggregate(YearDiff ~ gvkey, data = SCMatchesRevs, max)
EnoughYearObservations <- filter(YearObservations, YearDiff > 0)
EnoughYearObservations <- select(EnoughYearObservations, -YearDiff)

SCMatchesRevs <- left_join(EnoughYearObservations, SCMatchesRevs, by = "gvkey")
SCMatchesRevs <- arrange(SCMatchesRevs, gvkey, AcYear)

n_distinct(SCMatchesRevs$gvkey)

ConstructionSet <- select(SCMatchesRevs, gvkey, TransactionYear, RevenueAcquired, Targets, SumTransactions)
ConstructionSet <- ConstructionSet %>% 
  group_by(gvkey) %>%                            
  distinct(TransactionYear, .keep_all = TRUE)

ConstructionSet$TransactionYear <- as.numeric(ConstructionSet$TransactionYear )
ConstructionSet <- rename(ConstructionSet, REVACQ = RevenueAcquired, TNames =  Targets, SumTr = SumTransactions) 

SCMatchesRevs <- left_join(SCMatchesRevs, ConstructionSet, by = c("gvkey" = "gvkey", "AcYear" = "TransactionYear"))


SCMatchesRevs <- SCMatchesRevs %>% 
  group_by(gvkey) %>% 
  mutate(minYear = min(TransactionYear)) %>% 
  filter(TransactionYear == minYear)


SCMatchesRevs <- select(SCMatchesRevs, gvkey, conml, AcYear, Targets, TNames, TransactionYear,YearDiff, saleAc, 
                         RevAcquiredInYear, REVACQ, RevenueAcquired, SumTransactions, everything())

SCMatchesRevs <- select(SCMatchesRevs, -Targets, - TransactionYear, -minYear, -RevenueAcquired, -RevAcquiredInYear,
                         -conmA, -RevenueTargets, -YearDiff, - SumTransactions)
SCMatchesRevs <- rename(SCMatchesRevs, Targets = TNames, RevenueAcquired = REVACQ, SumTransactions = SumTr)

SCMatchesRevs$RevenueAcquired <- replace(SCMatchesRevs$RevenueAcquired,is.na(SCMatchesRevs$RevenueAcquired), 0   ) 
SCMatchesRevs$AcYear <- as.character(SCMatchesRevs$AcYear)

SCMatchesRevs <- left_join(SCMatchesRevs, TargetSalesFINforMerge, by = c("AcquirorName", "AcYear"), na_matches = "never" )

SCMatchesRevs$ID <- seq(1:length(SCMatchesRevs$gvkey))

SCMatchesRevsSelling <- SCMatchesRevs %>%
  group_by(ID)  %>%
  mutate(TargetSold=ifelse( grepl(str_replace_all(TargetSold, " ", ""), str_replace_all(Targets, " ", "")), NA,TargetSold)) %>%
  mutate(RevenueSold=ifelse( grepl(str_replace_all(TargetSold, " ", ""), str_replace_all(Targets, " ", "")), NA,RevenueSold))

SCMatchesRevsSelling <- SCMatchesRevsSelling %>%
  group_by(gvkey, AcYear)  %>%
  summarise(gvkey = first(gvkey), conml = first(conml), AcYear = first(AcYear), Targets = first(Targets), 
            saleAc = first(saleAc), RevenueAcquired = first(RevenueAcquired), AcquirorName = first(AcquirorName),
            NumberTransactions = first(NumberTransactions), AcquirorState = first(AcquirorState),
            AcquirorSIC = first(AcquirorSIC), AcquirorNation = first(AcquirorNation), yearID = first(yearID),
            SumTransactions = first(SumTransactions), TargetSold = list(TargetSold), RevenueSold = sum(RevenueSold))
  

SCMatchesRevsSelling <- SCMatchesRevsSelling %>%
    mutate(RevenueAcquired = if_else(is.na(RevenueAcquired), 0, RevenueAcquired)) %>%
    mutate(RevenueSold = if_else(is.na(RevenueSold), 0, RevenueSold)) 


SCMatchesRevsSelling$NetRevTransactions <- with(SCMatchesRevsSelling,  RevenueAcquired -  RevenueSold  )

SCMatchesRevsSelling$TargetSold <- as.character(SCMatchesRevsSelling$TargetSold)
SCMatchesRevsSelling$TargetSold <- gsub('"', "", SCMatchesRevsSelling$TargetSold, fixed = TRUE)
SCMatchesRevsSelling$TargetSold <- gsub('c(', "", SCMatchesRevsSelling$TargetSold, fixed = TRUE)
SCMatchesRevsSelling$TargetSold <- gsub(')', "", SCMatchesRevsSelling$TargetSold, fixed = TRUE)
SCMatchesRevsSelling$TargetSold <- gsub(',', "  | ", SCMatchesRevsSelling$TargetSold, fixed = TRUE)


SCMatchesRevsSelling <- select(SCMatchesRevsSelling, gvkey, conml, AcYear, saleAc, Targets, RevenueAcquired,
                               TargetSold, RevenueSold, NetRevTransactions, everything())

SCMatchesRevsSelling <- rename(SCMatchesRevsSelling, TargetsSold = TargetSold, TargetsAcquired = Targets)


SCMatchesNetRevs <- data.frame(SCMatchesRevsSelling)


SCMatchesNetRevs <- SCMatchesNetRevs %>% 
  group_by(gvkey) %>% 
  mutate(CumuRevAcquired = cumsum(NetRevTransactions)) %>% 
  mutate(InternalRevenue = saleAc - CumuRevAcquired) %>% 
  mutate(SaleGrowth = saleAc - lag(saleAc)) %>% 
  mutate(CumuSaleGrowth = cumsum(  replace(SaleGrowth,is.na(SaleGrowth), 0) )  ) %>% 
  mutate(InternalRevGrowth = InternalRevenue - lag(InternalRevenue)) %>% 
  mutate(GrowthShareOfAcquisition = round(CumuRevAcquired / CumuSaleGrowth,3) ) %>% 
  mutate(GrowthShareOfAcquisition = replace(GrowthShareOfAcquisition , is.na(GrowthShareOfAcquisition ), NA)) %>% 
  mutate(GrowthShareOfAcquisition =  ifelse(GrowthShareOfAcquisition<0, NA,GrowthShareOfAcquisition ))  %>% 
  mutate(CumuSpentOnAcqui = cumsum(  replace(SumTransactions,is.na(SumTransactions), 0) )  ) %>% 
  mutate(RevenueShare_A =  round(CumuRevAcquired / saleAc,3) )  %>% 
  mutate(RevenueShare_A =  ifelse(RevenueShare_A<0, NA,RevenueShare_A ))  %>% 
  mutate(RevenueShare_V = round( (NetRevTransactions / SaleGrowth ) , 3) ) %>% 
  mutate(RevenueShare_V =  ifelse(RevenueShare_V<0, NA,RevenueShare_V ))  %>% 
  rationalize()

SCMatchesNetRevs <- left_join(SCMatchesNetRevs, SaleSourceForMerge, by = c("gvkey" = "gvkey", "AcYear" = "Year"), 
                                  na_matches = "never")

SCMatchesNetRevs <- select(SCMatchesNetRevs, gvkey, conml, AcYear, saleAc, SaleGrowth,CumuSaleGrowth, TargetsAcquired,
                        RevenueAcquired, TargetsSold, RevenueSold,NetRevTransactions, CumuRevAcquired, InternalRevenue,
                        InternalRevGrowth, RevenueShare_A, RevenueShare_V, GrowthShareOfAcquisition, SumTransactions, 
                        CumuSpentOnAcqui, SaleSource, everything())


SCMatchesNetRevsMaxedObservations <- data.frame(SCMatchesNetRevs)

#write.csv(SCMatchesNetRevs, "NetAcquisitionsAndRevenues.csv")
#write.csv(SCMatchesNetRevs, "NetAcquisitionsAndRevenues_NABlank.csv", na = "")


NetRevsAggMaxedObservations <- SCMatchesNetRevsMaxedObservations %>% 
  group_by(gvkey) %>% 
  summarise(conml = first(conml), FinalGrowthShare = last(GrowthShareOfAcquisition), 
            MeanGrowthShare = mean(na.omit(GrowthShareOfAcquisition)), 
            MeanRevenueShare_A = mean(na.omit(RevenueShare_A)),
            MeanRevenueShare_V = mean(na.omit(RevenueShare_V)),
            FinalSales = last(saleAc), FinalSalesShare_A = last(CumuRevAcquired)/last(saleAc))


SampleInfoMaxed <- SCMatchesNetRevsMaxedObservations %>%
  group_by(gvkey) %>%
  summarise(Observations = n(), NumberOfTransactions = first(NumberTransactions),
            TransactionVolume = sum(SumTransactions, na.rm = T), RevAc = sum(RevenueAcquired, na.rm = T))

SampleInfoMaxedSumarry <- SampleInfoMaxed %>%
  summarise(mOservations = mean(Observations, na.rm = T), medObservations = median(Observations, na.rm = T),
            mNumber = mean(NumberOfTransactions, na.rm = T), medNumber = median(NumberOfTransactions, na.rm = T),
            mVolume = mean(TransactionVolume, na.rm = T), medVolume = median(TransactionVolume, na.rm = T),
            mRevAc = mean(RevAc, na.rm = T),  medRevAc = median(RevAc, na.rm = T))



```


  -> SAMPLE 4
  
```{r MAIN OUTPUT: Compustat Prediction}

## SAME COMPUTATIONS AS FOR SAMPLE ONE


SCMatchesAgg <- with(SCMatchesFinCompuPred, data.frame(gvkey = gvkey, conml = conml, AcquirorName = AcquirorName,
                                                     TargetName = TargetName,TransactionValue = ValueofTransactionmil, 
                                                     Year = YEARef, AcquiredSales = round(RevenueShare,3), 
                                                     RevenueTargets = TARGET_SALES, 
                                                     Transaction = 1,
                                                     AcquirorState = AcquirorState, 
                                                     AcquirorSIC = AcquirorPrimarySICCode, AcquirorNation = AcquirorNation,
                                                     SaleSource = SaleSource) )

sum(is.na(SCMatchesAgg$RevenueAcquired))
n_distinct(SCMatchesAgg$conml)
n_distinct(SCMatchesAgg$gvkey)

SCMatchesAgg <- SCMatchesAgg %>% 
  group_by(gvkey, Year) %>%                            
  summarise(SumTransactions = sum(TransactionValue), NumberTransactions = sum(Transaction), 
            RevenueAcquired = sum(AcquiredSales), Targets = list(TargetName), conml = first(conml),
            AcquirorName = first(AcquirorName), RevenueTargets = sum(RevenueTargets),
            AcquirorState = first(AcquirorState), AcquirorSIC = first(AcquirorSIC), AcquirorNation = first(AcquirorNation),
            SaleSource = list(SaleSource))

SCMatchesAgg <- select(SCMatchesAgg, gvkey, conml, AcquirorName, Targets, Year, everything())

SCMatchesAgg <- arrange(SCMatchesAgg, desc(SumTransactions), Year)

SCMatchesAgg$Targets <- as.character(SCMatchesAgg$Targets)
SCMatchesAgg$Targets <- gsub('"', "", SCMatchesAgg$Targets, fixed = TRUE)
SCMatchesAgg$Targets <- gsub('c(', "", SCMatchesAgg$Targets, fixed = TRUE)
SCMatchesAgg$Targets <- gsub(')', "", SCMatchesAgg$Targets, fixed = TRUE)
SCMatchesAgg$Targets <- gsub(',', "  | ", SCMatchesAgg$Targets, fixed = TRUE)

SCMatchesAgg$SaleSource <- as.character(SCMatchesAgg$SaleSource)
SCMatchesAgg$SaleSource <- gsub('"', "", SCMatchesAgg$SaleSource, fixed = TRUE)
SCMatchesAgg$SaleSource <- gsub('c(', "", SCMatchesAgg$SaleSource, fixed = TRUE)
SCMatchesAgg$SaleSource <- gsub(')', "", SCMatchesAgg$SaleSource, fixed = TRUE)
SCMatchesAgg$SaleSource <- gsub(',', "  | ", SCMatchesAgg$SaleSource, fixed = TRUE)

n_distinct(SCMatchesAgg$conml)

SaleSourceForMerge <- select(SCMatchesAgg, gvkey, Year, SaleSource)


############################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################

TargetSalesFINforMerge <- select(TargetSalesCompuPred, 
                                 -Xsold, - TargetSalesYearSold, -TargetSalesYearSoldPred, -sale, -TARGET_SALES_SOLD)

TargetSalesFINforMerge <- TargetSalesFINforMerge  %>% 
  group_by(TargetName, AcquirorName, AcYear) %>%                            
  summarise(RevenueSold = sum(RevenueSold), TargetName = first(TargetName), AcquirorName = first(AcquirorName))

TargetSalesFINforMerge <- rename(TargetSalesFINforMerge, TargetSold = TargetName)
TargetSalesFINforMerge <- select(TargetSalesFINforMerge, AcquirorName, everything())

SCMatchesRevs <- data.frame(SCMatchesAgg)
SCMatchesRevs$yearID <- seq(1:length(SCMatchesRevs$gvkey))
SCMatchesRevs <- rename(SCMatchesRevs, TransactionYear = Year)

SALESAgg <- data.frame(SALES)
SALESAgg <- select(SALESAgg, gvkey, conm, year, sale)
SALESAgg <- rename(SALESAgg, AcYear = year, conmA = conm, saleAc = sale)
SALESAgg$saleAc <- SALESAgg$saleAc/1000


SCMatchesRevs <- left_join(SCMatchesRevs, SALESAgg, by = "gvkey")

SCMatchesRevs <- arrange(SCMatchesRevs, gvkey, TransactionYear)

SCMatchesRevs$YearDiff <- as.numeric(SCMatchesRevs$AcYear) - as.numeric(SCMatchesRevs$TransactionYear) 


SCMatchesRevs$RevAcquiredInYear <- ifelse(SCMatchesRevs$YearDiff == 0, 
                                         SCMatchesRevs$RevenueAcquired, 0)

SCMatchesRevs <- select(SCMatchesRevs, gvkey, conml, Targets, AcYear, TransactionYear,YearDiff, saleAc, 
                         RevAcquiredInYear, RevenueAcquired, SumTransactions, SaleSource, everything())

SCMatchesRevs <- arrange(SCMatchesRevs, desc(SumTransactions))

n_distinct(SCMatchesRevs$gvkey)

YearObservations <- aggregate(YearDiff ~ gvkey, data = SCMatchesRevs, max)
EnoughYearObservations <- filter(YearObservations, YearDiff > 0)
EnoughYearObservations <- select(EnoughYearObservations, -YearDiff)

SCMatchesRevs <- left_join(EnoughYearObservations, SCMatchesRevs, by = "gvkey")
SCMatchesRevs <- arrange(SCMatchesRevs, gvkey, AcYear)

n_distinct(SCMatchesRevs$gvkey)

ConstructionSet <- select(SCMatchesRevs, gvkey, TransactionYear, RevenueAcquired, Targets, SumTransactions)
ConstructionSet <- ConstructionSet %>% 
  group_by(gvkey) %>%                            
  distinct(TransactionYear, .keep_all = TRUE)

ConstructionSet$TransactionYear <- as.numeric(ConstructionSet$TransactionYear )
ConstructionSet <- rename(ConstructionSet, REVACQ = RevenueAcquired, TNames =  Targets, SumTr = SumTransactions) 

SCMatchesRevs <- left_join(SCMatchesRevs, ConstructionSet, by = c("gvkey" = "gvkey", "AcYear" = "TransactionYear"))


SCMatchesRevs <- SCMatchesRevs %>% 
  group_by(gvkey) %>% 
  mutate(minYear = min(TransactionYear)) %>% 
  filter(TransactionYear == minYear)


SCMatchesRevs <- select(SCMatchesRevs, gvkey, conml, AcYear, Targets, TNames, TransactionYear,YearDiff, saleAc, 
                         RevAcquiredInYear, REVACQ, RevenueAcquired, SumTransactions, everything())

SCMatchesRevs <- select(SCMatchesRevs, -Targets, - TransactionYear, -minYear, -RevenueAcquired, -RevAcquiredInYear,
                         -conmA, -RevenueTargets, -YearDiff, - SumTransactions)
SCMatchesRevs <- rename(SCMatchesRevs, Targets = TNames, RevenueAcquired = REVACQ, SumTransactions = SumTr)

SCMatchesRevs$RevenueAcquired <- replace(SCMatchesRevs$RevenueAcquired,is.na(SCMatchesRevs$RevenueAcquired), 0   ) 
SCMatchesRevs$AcYear <- as.character(SCMatchesRevs$AcYear)

SCMatchesRevs <- left_join(SCMatchesRevs, TargetSalesFINforMerge, by = c("AcquirorName", "AcYear"), na_matches = "never" )

SCMatchesRevs$ID <- seq(1:length(SCMatchesRevs$gvkey))

SCMatchesRevsSelling <- SCMatchesRevs %>%
  group_by(ID)  %>%
  mutate(TargetSold=ifelse( grepl(str_replace_all(TargetSold, " ", ""), str_replace_all(Targets, " ", "")), NA,TargetSold)) %>%
  mutate(RevenueSold=ifelse( grepl(str_replace_all(TargetSold, " ", ""), str_replace_all(Targets, " ", "")), NA,RevenueSold))

SCMatchesRevsSelling <- SCMatchesRevsSelling %>%
  group_by(gvkey, AcYear)  %>%
  summarise(gvkey = first(gvkey), conml = first(conml), AcYear = first(AcYear), Targets = first(Targets), 
            saleAc = first(saleAc), RevenueAcquired = first(RevenueAcquired), AcquirorName = first(AcquirorName),
            NumberTransactions = first(NumberTransactions), AcquirorState = first(AcquirorState),
            AcquirorSIC = first(AcquirorSIC), AcquirorNation = first(AcquirorNation), yearID = first(yearID),
            SumTransactions = first(SumTransactions), TargetSold = list(TargetSold), RevenueSold = sum(RevenueSold))
  

SCMatchesRevsSelling <- SCMatchesRevsSelling %>%
    mutate(RevenueAcquired = if_else(is.na(RevenueAcquired), 0, RevenueAcquired)) %>%
    mutate(RevenueSold = if_else(is.na(RevenueSold), 0, RevenueSold)) 


SCMatchesRevsSelling$NetRevTransactions <- with(SCMatchesRevsSelling,  RevenueAcquired -  RevenueSold  )

SCMatchesRevsSelling$TargetSold <- as.character(SCMatchesRevsSelling$TargetSold)
SCMatchesRevsSelling$TargetSold <- gsub('"', "", SCMatchesRevsSelling$TargetSold, fixed = TRUE)
SCMatchesRevsSelling$TargetSold <- gsub('c(', "", SCMatchesRevsSelling$TargetSold, fixed = TRUE)
SCMatchesRevsSelling$TargetSold <- gsub(')', "", SCMatchesRevsSelling$TargetSold, fixed = TRUE)
SCMatchesRevsSelling$TargetSold <- gsub(',', "  | ", SCMatchesRevsSelling$TargetSold, fixed = TRUE)


SCMatchesRevsSelling <- select(SCMatchesRevsSelling, gvkey, conml, AcYear, saleAc, Targets, RevenueAcquired,
                               TargetSold, RevenueSold, NetRevTransactions, everything())

SCMatchesRevsSelling <- rename(SCMatchesRevsSelling, TargetsSold = TargetSold, TargetsAcquired = Targets)


SCMatchesNetRevs <- data.frame(SCMatchesRevsSelling)


SCMatchesNetRevs <- SCMatchesNetRevs %>% 
  group_by(gvkey) %>% 
  mutate(CumuRevAcquired = cumsum(NetRevTransactions)) %>% 
  mutate(InternalRevenue = saleAc - CumuRevAcquired) %>% 
  mutate(SaleGrowth = saleAc - lag(saleAc)) %>% 
  mutate(CumuSaleGrowth = cumsum(  replace(SaleGrowth,is.na(SaleGrowth), 0) )  ) %>% 
  mutate(InternalRevGrowth = InternalRevenue - lag(InternalRevenue)) %>% 
  mutate(GrowthShareOfAcquisition = round(CumuRevAcquired / CumuSaleGrowth,3) ) %>% 
  mutate(GrowthShareOfAcquisition = replace(GrowthShareOfAcquisition , is.na(GrowthShareOfAcquisition ), NA)) %>% 
  mutate(GrowthShareOfAcquisition =  ifelse(GrowthShareOfAcquisition<0, NA,GrowthShareOfAcquisition ))  %>% 
  mutate(CumuSpentOnAcqui = cumsum(  replace(SumTransactions,is.na(SumTransactions), 0) )  ) %>% 
  mutate(RevenueShare_A =  round(CumuRevAcquired / saleAc,3) )  %>% 
  mutate(RevenueShare_A =  ifelse(RevenueShare_A<0, NA,RevenueShare_A ))  %>% 
  mutate(RevenueShare_V = round( (NetRevTransactions / SaleGrowth ) , 3) ) %>% 
  mutate(RevenueShare_V =  ifelse(RevenueShare_V<0, NA,RevenueShare_V ))  %>% 
  rationalize()

SCMatchesNetRevs <- left_join(SCMatchesNetRevs, SaleSourceForMerge, by = c("gvkey" = "gvkey", "AcYear" = "Year"), 
                                  na_matches = "never")

SCMatchesNetRevs <- select(SCMatchesNetRevs, gvkey, conml, AcYear, saleAc, SaleGrowth,CumuSaleGrowth, TargetsAcquired,
                        RevenueAcquired, TargetsSold, RevenueSold,NetRevTransactions, CumuRevAcquired, InternalRevenue,
                        InternalRevGrowth, RevenueShare_A, RevenueShare_V, GrowthShareOfAcquisition, SumTransactions, 
                        CumuSpentOnAcqui, SaleSource, everything())


SCMatchesNetRevsCompuPred <- data.frame(SCMatchesNetRevs)

#write.csv(SCMatchesNetRevs, "NetAcquisitionsAndRevenues.csv")
#write.csv(SCMatchesNetRevs, "NetAcquisitionsAndRevenues_NABlank.csv", na = "")


NetRevsAggCompuPred <- SCMatchesNetRevsCompuPred %>% 
  group_by(gvkey) %>% 
  summarise(conml = first(conml), FinalGrowthShare = last(GrowthShareOfAcquisition), 
            MeanGrowthShare = mean(na.omit(GrowthShareOfAcquisition)), 
            MeanRevenueShare_A = mean(na.omit(RevenueShare_A)),
            MeanRevenueShare_V = mean(na.omit(RevenueShare_V)),
            FinalSales = last(saleAc), FinalSalesShare_A = last(CumuRevAcquired)/last(saleAc))


SampleInfoCompuPred <- SCMatchesNetRevsCompuPred %>%
  group_by(gvkey) %>%
  summarise(Observations = n(), NumberOfTransactions = first(NumberTransactions),
            TransactionVolume = sum(SumTransactions, na.rm = T), RevAc = sum(RevenueAcquired, na.rm = T))

SampleInfoCompuPredSumarry <- SampleInfoCompuPred %>%
  summarise(mOservations = mean(Observations, na.rm = T), medObservations = median(Observations, na.rm = T),
            mNumber = mean(NumberOfTransactions, na.rm = T), medNumber = median(NumberOfTransactions, na.rm = T),
            mVolume = mean(TransactionVolume, na.rm = T), medVolume = median(TransactionVolume, na.rm = T),
            mRevAc = mean(RevAc, na.rm = T),  medRevAc = median(RevAc, na.rm = T))


```

  
  -> SAMPLE 5

```{r MAIN OUTPUT: SDC Predicted Values}

## SAME COMPUTATIONS AS FOR SAMPLE ONE


SCMatchesAgg <- with(SCMatchesFinPredicted, data.frame(gvkey = gvkey, conml = conml, AcquirorName = AcquirorName,
                                                     TargetName = TargetName,TransactionValue = ValueofTransactionmil, 
                                                     Year = YEARef, AcquiredSales = round(RevenueShare,3), 
                                                     RevenueTargets = TARGET_SALES, 
                                                     Transaction = 1,
                                                     AcquirorState = AcquirorState, 
                                                     AcquirorSIC = AcquirorPrimarySICCode, AcquirorNation = AcquirorNation,
                                                     SaleSource = SaleSource) )

sum(is.na(SCMatchesAgg$RevenueAcquired))
n_distinct(SCMatchesAgg$conml)
n_distinct(SCMatchesAgg$gvkey)

SCMatchesAgg <- SCMatchesAgg %>% 
  group_by(gvkey, Year) %>%                            
  summarise(SumTransactions = sum(TransactionValue), NumberTransactions = sum(Transaction), 
            RevenueAcquired = sum(AcquiredSales), Targets = list(TargetName), conml = first(conml),
            AcquirorName = first(AcquirorName), RevenueTargets = sum(RevenueTargets),
            AcquirorState = first(AcquirorState), AcquirorSIC = first(AcquirorSIC), AcquirorNation = first(AcquirorNation),
            SaleSource = list(SaleSource))

SCMatchesAgg <- select(SCMatchesAgg, gvkey, conml, AcquirorName, Targets, Year, everything())

SCMatchesAgg <- arrange(SCMatchesAgg, desc(SumTransactions), Year)

SCMatchesAgg$Targets <- as.character(SCMatchesAgg$Targets)
SCMatchesAgg$Targets <- gsub('"', "", SCMatchesAgg$Targets, fixed = TRUE)
SCMatchesAgg$Targets <- gsub('c(', "", SCMatchesAgg$Targets, fixed = TRUE)
SCMatchesAgg$Targets <- gsub(')', "", SCMatchesAgg$Targets, fixed = TRUE)
SCMatchesAgg$Targets <- gsub(',', "  | ", SCMatchesAgg$Targets, fixed = TRUE)

SCMatchesAgg$SaleSource <- as.character(SCMatchesAgg$SaleSource)
SCMatchesAgg$SaleSource <- gsub('"', "", SCMatchesAgg$SaleSource, fixed = TRUE)
SCMatchesAgg$SaleSource <- gsub('c(', "", SCMatchesAgg$SaleSource, fixed = TRUE)
SCMatchesAgg$SaleSource <- gsub(')', "", SCMatchesAgg$SaleSource, fixed = TRUE)
SCMatchesAgg$SaleSource <- gsub(',', "  | ", SCMatchesAgg$SaleSource, fixed = TRUE)

n_distinct(SCMatchesAgg$conml)

SaleSourceForMerge <- select(SCMatchesAgg, gvkey, Year, SaleSource)


############################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################

TargetSalesFINforMerge <- select(TargetSalesPredicted, 
                                 -Xsold, - TargetSalesYearSold, -TargetSalesYearSoldPred, -sale, -TARGET_SALES_SOLD)

TargetSalesFINforMerge <- TargetSalesFINforMerge  %>% 
  group_by(TargetName, AcquirorName, AcYear) %>%                            
  summarise(RevenueSold = sum(RevenueSold), TargetName = first(TargetName), AcquirorName = first(AcquirorName))

TargetSalesFINforMerge <- rename(TargetSalesFINforMerge, TargetSold = TargetName)
TargetSalesFINforMerge <- select(TargetSalesFINforMerge, AcquirorName, everything())

SCMatchesRevs <- data.frame(SCMatchesAgg)
SCMatchesRevs$yearID <- seq(1:length(SCMatchesRevs$gvkey))
SCMatchesRevs <- rename(SCMatchesRevs, TransactionYear = Year)

SALESAgg <- data.frame(SALES)
SALESAgg <- select(SALESAgg, gvkey, conm, year, sale)
SALESAgg <- rename(SALESAgg, AcYear = year, conmA = conm, saleAc = sale)
SALESAgg$saleAc <- SALESAgg$saleAc/1000


SCMatchesRevs <- left_join(SCMatchesRevs, SALESAgg, by = "gvkey")

SCMatchesRevs <- arrange(SCMatchesRevs, gvkey, TransactionYear)

SCMatchesRevs$YearDiff <- as.numeric(SCMatchesRevs$AcYear) - as.numeric(SCMatchesRevs$TransactionYear) 


SCMatchesRevs$RevAcquiredInYear <- ifelse(SCMatchesRevs$YearDiff == 0, 
                                         SCMatchesRevs$RevenueAcquired, 0)

SCMatchesRevs <- select(SCMatchesRevs, gvkey, conml, Targets, AcYear, TransactionYear,YearDiff, saleAc, 
                         RevAcquiredInYear, RevenueAcquired, SumTransactions, SaleSource, everything())

SCMatchesRevs <- arrange(SCMatchesRevs, desc(SumTransactions))

n_distinct(SCMatchesRevs$gvkey)

YearObservations <- aggregate(YearDiff ~ gvkey, data = SCMatchesRevs, max)
EnoughYearObservations <- filter(YearObservations, YearDiff > 0)
EnoughYearObservations <- select(EnoughYearObservations, -YearDiff)

SCMatchesRevs <- left_join(EnoughYearObservations, SCMatchesRevs, by = "gvkey")
SCMatchesRevs <- arrange(SCMatchesRevs, gvkey, AcYear)

n_distinct(SCMatchesRevs$gvkey)

ConstructionSet <- select(SCMatchesRevs, gvkey, TransactionYear, RevenueAcquired, Targets, SumTransactions)
ConstructionSet <- ConstructionSet %>% 
  group_by(gvkey) %>%                            
  distinct(TransactionYear, .keep_all = TRUE)

ConstructionSet$TransactionYear <- as.numeric(ConstructionSet$TransactionYear )
ConstructionSet <- rename(ConstructionSet, REVACQ = RevenueAcquired, TNames =  Targets, SumTr = SumTransactions) 

SCMatchesRevs <- left_join(SCMatchesRevs, ConstructionSet, by = c("gvkey" = "gvkey", "AcYear" = "TransactionYear"))


SCMatchesRevs <- SCMatchesRevs %>% 
  group_by(gvkey) %>% 
  mutate(minYear = min(TransactionYear)) %>% 
  filter(TransactionYear == minYear)


SCMatchesRevs <- select(SCMatchesRevs, gvkey, conml, AcYear, Targets, TNames, TransactionYear,YearDiff, saleAc, 
                         RevAcquiredInYear, REVACQ, RevenueAcquired, SumTransactions, everything())

SCMatchesRevs <- select(SCMatchesRevs, -Targets, - TransactionYear, -minYear, -RevenueAcquired, -RevAcquiredInYear,
                         -conmA, -RevenueTargets, -YearDiff, - SumTransactions)
SCMatchesRevs <- rename(SCMatchesRevs, Targets = TNames, RevenueAcquired = REVACQ, SumTransactions = SumTr)

SCMatchesRevs$RevenueAcquired <- replace(SCMatchesRevs$RevenueAcquired,is.na(SCMatchesRevs$RevenueAcquired), 0   ) 
SCMatchesRevs$AcYear <- as.character(SCMatchesRevs$AcYear)

SCMatchesRevs <- left_join(SCMatchesRevs, TargetSalesFINforMerge, by = c("AcquirorName", "AcYear"), na_matches = "never" )

SCMatchesRevs$ID <- seq(1:length(SCMatchesRevs$gvkey))

SCMatchesRevsSelling <- SCMatchesRevs %>%
  group_by(ID)  %>%
  mutate(TargetSold=ifelse( grepl(str_replace_all(TargetSold, " ", ""), str_replace_all(Targets, " ", "")), NA,TargetSold)) %>%
  mutate(RevenueSold=ifelse( grepl(str_replace_all(TargetSold, " ", ""), str_replace_all(Targets, " ", "")), NA,RevenueSold))

SCMatchesRevsSelling <- SCMatchesRevsSelling %>%
  group_by(gvkey, AcYear)  %>%
  summarise(gvkey = first(gvkey), conml = first(conml), AcYear = first(AcYear), Targets = first(Targets), 
            saleAc = first(saleAc), RevenueAcquired = first(RevenueAcquired), AcquirorName = first(AcquirorName),
            NumberTransactions = first(NumberTransactions), AcquirorState = first(AcquirorState),
            AcquirorSIC = first(AcquirorSIC), AcquirorNation = first(AcquirorNation), yearID = first(yearID),
            SumTransactions = first(SumTransactions), TargetSold = list(TargetSold), RevenueSold = sum(RevenueSold))
  

SCMatchesRevsSelling <- SCMatchesRevsSelling %>%
    mutate(RevenueAcquired = if_else(is.na(RevenueAcquired), 0, RevenueAcquired)) %>%
    mutate(RevenueSold = if_else(is.na(RevenueSold), 0, RevenueSold)) 


SCMatchesRevsSelling$NetRevTransactions <- with(SCMatchesRevsSelling,  RevenueAcquired -  RevenueSold  )

SCMatchesRevsSelling$TargetSold <- as.character(SCMatchesRevsSelling$TargetSold)
SCMatchesRevsSelling$TargetSold <- gsub('"', "", SCMatchesRevsSelling$TargetSold, fixed = TRUE)
SCMatchesRevsSelling$TargetSold <- gsub('c(', "", SCMatchesRevsSelling$TargetSold, fixed = TRUE)
SCMatchesRevsSelling$TargetSold <- gsub(')', "", SCMatchesRevsSelling$TargetSold, fixed = TRUE)
SCMatchesRevsSelling$TargetSold <- gsub(',', "  | ", SCMatchesRevsSelling$TargetSold, fixed = TRUE)


SCMatchesRevsSelling <- select(SCMatchesRevsSelling, gvkey, conml, AcYear, saleAc, Targets, RevenueAcquired,
                               TargetSold, RevenueSold, NetRevTransactions, everything())

SCMatchesRevsSelling <- rename(SCMatchesRevsSelling, TargetsSold = TargetSold, TargetsAcquired = Targets)


SCMatchesNetRevs <- data.frame(SCMatchesRevsSelling)


SCMatchesNetRevs <- SCMatchesNetRevs %>% 
  group_by(gvkey) %>% 
  mutate(CumuRevAcquired = cumsum(NetRevTransactions)) %>% 
  mutate(InternalRevenue = saleAc - CumuRevAcquired) %>% 
  mutate(SaleGrowth = saleAc - lag(saleAc)) %>% 
  mutate(CumuSaleGrowth = cumsum(  replace(SaleGrowth,is.na(SaleGrowth), 0) )  ) %>% 
  mutate(InternalRevGrowth = InternalRevenue - lag(InternalRevenue)) %>% 
  mutate(GrowthShareOfAcquisition = round(CumuRevAcquired / CumuSaleGrowth,3) ) %>% 
  mutate(GrowthShareOfAcquisition = replace(GrowthShareOfAcquisition , is.na(GrowthShareOfAcquisition ), NA)) %>% 
  mutate(GrowthShareOfAcquisition =  ifelse(GrowthShareOfAcquisition<0, NA,GrowthShareOfAcquisition ))  %>% 
  mutate(CumuSpentOnAcqui = cumsum(  replace(SumTransactions,is.na(SumTransactions), 0) )  ) %>% 
  mutate(RevenueShare_A =  round(CumuRevAcquired / saleAc,3) )  %>% 
  mutate(RevenueShare_A =  ifelse(RevenueShare_A<0, NA,RevenueShare_A ))  %>% 
  mutate(RevenueShare_V = round( (NetRevTransactions / SaleGrowth ) , 3) ) %>% 
  mutate(RevenueShare_V =  ifelse(RevenueShare_V<0, NA,RevenueShare_V ))  %>% 
  rationalize()

SCMatchesNetRevs <- left_join(SCMatchesNetRevs, SaleSourceForMerge, by = c("gvkey" = "gvkey", "AcYear" = "Year"), 
                                  na_matches = "never")

SCMatchesNetRevs <- select(SCMatchesNetRevs, gvkey, conml, AcYear, saleAc, SaleGrowth,CumuSaleGrowth, TargetsAcquired,
                        RevenueAcquired, TargetsSold, RevenueSold,NetRevTransactions, CumuRevAcquired, InternalRevenue,
                        InternalRevGrowth, RevenueShare_A, RevenueShare_V, GrowthShareOfAcquisition, SumTransactions, 
                        CumuSpentOnAcqui, SaleSource, everything())


SCMatchesNetRevsPredicted <- data.frame(SCMatchesNetRevs)

#write.csv(SCMatchesNetRevs, "NetAcquisitionsAndRevenues.csv")
#write.csv(SCMatchesNetRevs, "NetAcquisitionsAndRevenues_NABlank.csv", na = "")


NetRevsAggPredicted <- SCMatchesNetRevsPredicted %>% 
  group_by(gvkey) %>% 
  summarise(conml = first(conml), FinalGrowthShare = last(GrowthShareOfAcquisition), 
            MeanGrowthShare = mean(na.omit(GrowthShareOfAcquisition)), 
            MeanRevenueShare_A = mean(na.omit(RevenueShare_A)),
            MeanRevenueShare_V = mean(na.omit(RevenueShare_V)),
            FinalSales = last(saleAc), FinalSalesShare_A = last(CumuRevAcquired)/last(saleAc))


SampleInfoPredicted <- SCMatchesNetRevsPredicted %>%
  group_by(gvkey) %>%
  summarise(Observations = n(), NumberOfTransactions = first(NumberTransactions),
            TransactionVolume = sum(SumTransactions), RevAc = sum(RevenueAcquired))

SampleInfoPredictedSumarry <- SampleInfoPredicted %>%
  summarise(mOservations = mean(Observations, na.rm = T), medObservations = median(Observations, na.rm = T),
            mNumber = mean(NumberOfTransactions, na.rm = T), medNumber = median(NumberOfTransactions, na.rm = T),
            mVolume = mean(TransactionVolume, na.rm = T), medVolume = median(TransactionVolume, na.rm = T),
            mRevAc = mean(RevAc, na.rm = T),  medRevAc = median(RevAc, na.rm = T))
  

```


  SAMPLE STATISTICS
  
```{r SAMPLE INFORMATION}

SampleInfo <- rbind(SampleInfoCompuSumarry, SampleInfoStandardSumarry, SampleInfoMaxedSumarry, 
                    SampleInfoCompuPredSumarry, SampleInfoPredictedSumarry)

## SOME STATISTICS ON THE SAMPLES
mean(SampleInfo$medNumber)
mean(SampleInfo$medVolume)
mean(SampleInfo$medRevAc)

mean(SampleInfo$mNumber)
mean(SampleInfo$mVolume)
mean(SampleInfo$mRevAc)

```

  
## COMPUTING AND SUMMARIZING THE RESULTS

  CREATING THE MAIN RESULTS TABLE SUMMARIZING ACROSS FIRMS

```{r SUMMARIZED OUTPUT: BY FIRM }

### Pure Compustat Data

PCDmeanGS <- mean(na.omit(NetRevsAggPureCompu$MeanGrowthShare))
PCDmedianGS <- median(na.omit(NetRevsAggPureCompu$MeanGrowthShare))

PCDmeanFGS <- mean(na.omit(NetRevsAggPureCompu$FinalGrowthShare))
PCDWeightedmeanFGS <- with(NetRevsAggPureCompu,
                         sum(na.omit(FinalGrowthShare*FinalSales) ) / sum(na.omit(FinalSales))  )
PCDmedianFGS <- median(na.omit(NetRevsAggPureCompu$FinalGrowthShare))

PCDmeanAS_A <- mean(na.omit(NetRevsAggPureCompu$MeanRevenueShare_A ))
PCDmedianAS_A <- median(na.omit(NetRevsAggPureCompu$MeanRevenueShare_A))
PCDmeanFAS_A <- mean(na.omit(NetRevsAggPureCompu$FinalSalesShare_A ))

PCDmeanAS_V <- mean(na.omit(NetRevsAggPureCompu$MeanRevenueShare_V ))
PCDmedianAS_V <- median(na.omit(NetRevsAggPureCompu$MeanRevenueShare_V))

PCDFirmCount <- n_distinct(NetRevsAggPureCompu$gvkey)

PCD <- c(PCDmeanGS, PCDmedianGS, PCDmeanFGS, PCDWeightedmeanFGS, PCDmedianFGS, PCDmeanAS_A, PCDmedianAS_A, PCDmeanFAS_A,
        PCDmeanAS_V, PCDmedianAS_V, PCDFirmCount)

PCD <- round(PCD* 100, 2)

### STANDARD Data

SDmeanGS <- mean(na.omit(NetRevsAggStandard$MeanGrowthShare))
SDmedianGS <- median(na.omit(NetRevsAggStandard$MeanGrowthShare))

SDmeanFGS <- mean(na.omit(NetRevsAggStandard$FinalGrowthShare))
SDWeightedmeanFGS <- with(NetRevsAggStandard,
                         sum(na.omit(FinalGrowthShare*FinalSales) ) / sum(na.omit(FinalSales))  )
SDmedianFGS <- median(na.omit(NetRevsAggStandard$FinalGrowthShare))
                             
SDmeanAS_A <- mean(na.omit(NetRevsAggStandard$MeanRevenueShare_A ))
SDmedianAS_A <- median(na.omit(NetRevsAggStandard$MeanRevenueShare_A))
SDmeanFAS_A <- mean(na.omit(NetRevsAggStandard$FinalSalesShare_A ))

SDmeanAS_V <- mean(na.omit(NetRevsAggStandard$MeanRevenueShare_V ))
SDmedianAS_V <- median(na.omit(NetRevsAggStandard$MeanRevenueShare_V))

SDFirmCount <- n_distinct(NetRevsAggStandard$gvkey)

SRD <- c(SDmeanGS, SDmedianGS, SDmeanFGS, SDWeightedmeanFGS, SDmedianFGS, SDmeanAS_A, SDmedianAS_A, SDmeanFAS_A,
        SDmeanAS_V, SDmedianAS_V, SDFirmCount)

SRD <- round(SRD* 100, 2)


### MAX OBSERVATION Data

MOmeanGS <- mean(na.omit(NetRevsAggMaxedObservations$MeanGrowthShare))
MOmedianGS <- median(na.omit(NetRevsAggMaxedObservations$MeanGrowthShare))

MOmeanFGS <- mean(na.omit(NetRevsAggMaxedObservations$FinalGrowthShare))
MOWeightedmeanFGS <- with(NetRevsAggMaxedObservations,
                         sum(na.omit(FinalGrowthShare*FinalSales) ) / sum(na.omit(FinalSales))  )
MOmedianFGS <- median(na.omit(NetRevsAggMaxedObservations$FinalGrowthShare))

MOmeanAS_A <- mean(na.omit(NetRevsAggMaxedObservations$MeanRevenueShare_A ))
MOmedianAS_A <- median(na.omit(NetRevsAggMaxedObservations$MeanRevenueShare_A))
MOmeanFAS_A <- mean(na.omit(NetRevsAggMaxedObservations$FinalSalesShare_A ))

MOmeanAS_V <- mean(na.omit(NetRevsAggMaxedObservations$MeanRevenueShare_V ))
MOmedianAS_V <- median(na.omit(NetRevsAggMaxedObservations$MeanRevenueShare_V))

MOFirmCount <- n_distinct(NetRevsAggMaxedObservations$gvkey)

MO <- c(MOmeanGS, MOmedianGS, MOmeanFGS, MOWeightedmeanFGS, MOmedianFGS, MOmeanAS_A, MOmedianAS_A, MOmeanFAS_A,
        MOmeanAS_V, MOmedianAS_V, MOFirmCount)

MO <- round(MO* 100, 2)


### COMPU AND PREDICTION Data

CPmeanGS <- mean(na.omit(NetRevsAggCompuPred$MeanGrowthShare))
CPmedianGS <- median(na.omit(NetRevsAggCompuPred$MeanGrowthShare))

CPmeanFGS <- mean(na.omit(NetRevsAggCompuPred$FinalGrowthShare))
CPWeightedmeanFGS <- with(NetRevsAggCompuPred,
                         sum(na.omit(FinalGrowthShare*FinalSales) ) / sum(na.omit(FinalSales))  )
CPmedianFGS <- median(na.omit(NetRevsAggCompuPred$FinalGrowthShare))

CPmeanAS_A <- mean(na.omit(NetRevsAggCompuPred$MeanRevenueShare_A ))
CPmedianAS_A <- median(na.omit(NetRevsAggCompuPred$MeanRevenueShare_A))
CPmeanFAS_A <- mean(na.omit(NetRevsAggCompuPred$FinalSalesShare_A ))

CPmeanAS_V <- mean(na.omit(NetRevsAggCompuPred$MeanRevenueShare_V ))
CPmedianAS_V <- median(na.omit(NetRevsAggCompuPred$MeanRevenueShare_V))

CPFirmCount <- n_distinct(NetRevsAggCompuPred$gvkey)

CP <- c(CPmeanGS, CPmedianGS, CPmeanFGS, CPWeightedmeanFGS, CPmedianFGS, CPmeanAS_A, CPmedianAS_A, CPmeanFAS_A,
        CPmeanAS_V, CPmedianAS_V, CPFirmCount)

CP <- round(CP* 100, 2)


### PREDICTED Data

PRmeanGS <- mean(na.omit(NetRevsAggPredicted$MeanGrowthShare))
PRmedianGS <- median(na.omit(NetRevsAggPredicted$MeanGrowthShare))

PRmeanFGS <- mean(na.omit(NetRevsAggPredicted$FinalGrowthShare))
PRWeightedmeanFGS <- with(NetRevsAggPredicted,
                         sum(na.omit(FinalGrowthShare*FinalSales) ) / sum(na.omit(FinalSales))  )
PRmedianFGS <- median(na.omit(NetRevsAggPredicted$FinalGrowthShare))
                             
PRmeanAS_A <- mean(na.omit(NetRevsAggPredicted$MeanRevenueShare_A ))
PRmedianAS_A <- median(na.omit(NetRevsAggPredicted$MeanRevenueShare_A))
PRmeanFAS_A <- mean(na.omit(NetRevsAggPredicted$FinalSalesShare_A ))

PRmeanAS_V <- mean(na.omit(NetRevsAggPredicted$MeanRevenueShare_V ))
PRmedianAS_V <- median(na.omit(NetRevsAggPredicted$MeanRevenueShare_V))

PRFirmCount <- n_distinct(NetRevsAggPredicted$gvkey)

PR <- c(PRmeanGS, PRmedianGS, PRmeanFGS, PRWeightedmeanFGS, PRmedianFGS, PRmeanAS_A, PRmedianAS_A, PRmeanFAS_A, 
        PRmeanAS_V, PRmedianAS_V, PRFirmCount)

PR <- round(PR* 100, 2)

################### DF

RESULTS_FIRM <- as.data.frame( cbind(PCD, SRD, MO, CP, PR)  )

colnames(RESULTS_FIRM) <-c("Only Compustat Data (in %)", "Standard Case (in %)", "All Sources (in %)", 
                           "Compu and Pred (in %)", "Only Predicted (in %)" )

RESULTS_FIRM_RowNames <- c("Mean Growth Share",
                           "Median Growth Share",
                           "Mean Final Growth Share", 
                           "Weighted Mean Final Growth Share",
                           "Median Final Growth Share",
                           "Mean Revenue Share A", 
                           "Median Revenue Share A", 
                           "Mean Final Revenue Share A",
                           "Mean Revenue Share V", 
                           "Median Revenue Share V", 
                           "Observations")

rownames(RESULTS_FIRM) <- RESULTS_FIRM_RowNames

RESULTS_FIRM[11,] <- round(RESULTS_FIRM[11,]/100)

RESULTS_FIRM$ORDER <- c(6, 7, 8, 9, 10, 1, 2, 3, 4, 5, 11)

RESULTS_FIRM <- arrange(RESULTS_FIRM, ORDER)

RESULTS_FIRM <- select(RESULTS_FIRM, -ORDER)

```


  CREATING THE MAIN RESULTS TABLE SUMMARIZING ACROSS OBSERVATIONS

```{r SUMMARIZED OUTPUT: BY OBSERVATION }

### Pure Compustat Data

PCDmeanGS <- mean(na.omit(SCMatchesNetRevsPureCompu$GrowthShareOfAcquisition))
PCDmedianGS <- median(na.omit(SCMatchesNetRevsPureCompu$GrowthShareOfAcquisition))

PCDmeanAS_A <- mean(na.omit(SCMatchesNetRevsPureCompu$RevenueShare_A ))
PCDmedianAS_A <- median(na.omit(SCMatchesNetRevsPureCompu$RevenueShare_A))

PCDmeanAS_V <- mean(na.omit(SCMatchesNetRevsPureCompu$RevenueShare_V ))
PCDmedianAS_V <- median(na.omit(SCMatchesNetRevsPureCompu$RevenueShare_V))

PCDFirmCount <- length(SCMatchesNetRevsPureCompu$gvkey)

PCD <- c(PCDmeanGS, PCDmedianGS, PCDmeanAS_A, PCDmedianAS_A,
        PCDmeanAS_V, PCDmedianAS_V, PCDFirmCount)

PCD <- round(PCD* 100, 2)

### STANDARD Data

SDmeanGS <- mean(na.omit(SCMatchesNetRevsStandard$GrowthShareOfAcquisition))
SDmedianGS <- median(na.omit(SCMatchesNetRevsStandard$GrowthShareOfAcquisition))
                             
SDmeanAS_A <- mean(na.omit(SCMatchesNetRevsStandard$RevenueShare_A ))
SDmedianAS_A <- median(na.omit(SCMatchesNetRevsStandard$RevenueShare_A))

SDmeanAS_V <- mean(na.omit(SCMatchesNetRevsStandard$RevenueShare_V ))
SDmedianAS_V <- median(na.omit(SCMatchesNetRevsStandard$RevenueShare_V))

SDFirmCount <- length(SCMatchesNetRevsStandard$gvkey)

SRD <- c(SDmeanGS, SDmedianGS, SDmeanAS_A, SDmedianAS_A,
        SDmeanAS_V, SDmedianAS_V, SDFirmCount)

SRD <- round(SRD* 100, 2)


### MAX OBSERVATION Data

MOmeanGS <- mean(na.omit(SCMatchesNetRevsMaxedObservations$GrowthShareOfAcquisition))
MOmedianGS <- median(na.omit(SCMatchesNetRevsMaxedObservations$GrowthShareOfAcquisition))


MOmeanAS_A <- mean(na.omit(SCMatchesNetRevsMaxedObservations$RevenueShare_A ))
MOmedianAS_A <- median(na.omit(SCMatchesNetRevsMaxedObservations$RevenueShare_A))

MOmeanAS_V <- mean(na.omit(SCMatchesNetRevsMaxedObservations$RevenueShare_V ))
MOmedianAS_V <- median(na.omit(SCMatchesNetRevsMaxedObservations$RevenueShare_V))

MOFirmCount <- length(SCMatchesNetRevsMaxedObservations$gvkey)

MO <- c(MOmeanGS, MOmedianGS, MOmeanAS_A, MOmedianAS_A,
        MOmeanAS_V, MOmedianAS_V, MOFirmCount)

MO <- round(MO* 100, 2)

### COMPU AND PRED Data

CPmeanGS <- mean(na.omit(SCMatchesNetRevsCompuPred$GrowthShareOfAcquisition))
CPmedianGS <- median(na.omit(SCMatchesNetRevsCompuPred$GrowthShareOfAcquisition))


CPmeanAS_A <- mean(na.omit(SCMatchesNetRevsCompuPred$RevenueShare_A ))
CPmedianAS_A <- median(na.omit(SCMatchesNetRevsCompuPred$RevenueShare_A))

CPmeanAS_V <- mean(na.omit(SCMatchesNetRevsCompuPred$RevenueShare_V ))
CPmedianAS_V <- median(na.omit(SCMatchesNetRevsCompuPred$RevenueShare_V))

CPFirmCount <- length(SCMatchesNetRevsCompuPred$gvkey)

CP <- c(CPmeanGS, CPmedianGS, CPmeanAS_A, CPmedianAS_A,
        CPmeanAS_V, CPmedianAS_V, CPFirmCount)

CP <- round(CP* 100, 2)

### PREDICTED Data

PRmeanGS <- mean(na.omit(SCMatchesNetRevsPredicted$GrowthShareOfAcquisition))
PRmedianGS <- median(na.omit(SCMatchesNetRevsPredicted$GrowthShareOfAcquisition))

                             
PRmeanAS_A <- mean(na.omit(SCMatchesNetRevsPredicted$RevenueShare_A ))
PRmedianAS_A <- median(na.omit(SCMatchesNetRevsPredicted$RevenueShare_A))

PRmeanAS_V <- mean(na.omit(SCMatchesNetRevsPredicted$RevenueShare_V ))
PRmedianAS_V <- median(na.omit(SCMatchesNetRevsPredicted$RevenueShare_V))

PRFirmCount <- length(SCMatchesNetRevsPredicted$gvkey)

PR <- c(PRmeanGS, PRmedianGS, PRmeanAS_A, PRmedianAS_A,
        PRmeanAS_V, PRmedianAS_V, PRFirmCount)

PR <- round(PR* 100, 2)

################### DF

RESULTS_OBSERVATIONS <- as.data.frame( cbind(PCD, SRD, MO, CP, PR)  )

colnames(RESULTS_OBSERVATIONS) <-c("Only Compustat Data (in %)", "Standard Case (in %)", "All Sources (in %)",
                           "Compu and Pred (in %)", "Only Predicted (in %)" )

RESULTS_OBSERVATIONS_RowNames <- c("Mean Growth Share","Median Growth Share",
                                 "Mean Revenue Share A", "Median Revenue Share A",
                                 "Mean Revenue Share V", "Median Revenue Share V", "Observations")

rownames(RESULTS_OBSERVATIONS) <- RESULTS_OBSERVATIONS_RowNames

RESULTS_OBSERVATIONS[7,] <- round(RESULTS_OBSERVATIONS[7,]/100)


RESULTS_OBSERVATIONS$ORDER <- c(5,6,1,2,3,4,7)

RESULTS_OBSERVATIONS <- arrange(RESULTS_OBSERVATIONS, ORDER)

RESULTS_OBSERVATIONS <- select(RESULTS_OBSERVATIONS, -ORDER)

```


  COMPUTING RESULTS FOR INDUSRIES: SUMMARIZING ACROSS OBSERVATIONS
  
```{r RESULTS: ALL OBSERVTAIONS ACROSS INDUSTRIES }

## SAMPLE 2

ResAnalysisStandard <- data.frame(SCMatchesNetRevsStandard)

ResAnalysisStandard$ASIC2d <- substr(ResAnalysisStandard$AcquirorSIC, start = 1, stop = 2)


ResAnalysisAggStandard <- ResAnalysisStandard %>% 
  group_by(ASIC2d) %>% 
  summarise( 
            MeanGrowthShare = mean(na.omit(GrowthShareOfAcquisition)) ,
            MedianGrowthShare = median(na.omit(GrowthShareOfAcquisition)),
            
            MeanRevenueShare_A = mean(na.omit(RevenueShare_A)),
            MedianRevenueShare_A = median(na.omit(RevenueShare_A)),
            
            MeanRevenueShare_V = mean(na.omit(RevenueShare_V)),
            MedianRevenueShare_V = median(na.omit(RevenueShare_V)),

           observed_firms = n_distinct(gvkey)) 

n_distinct(ResAnalysisAggStandard$ASIC2d)

sic2dtable <- read.csv("sic_2_digit_codes.csv", colClasses = "character")

ResAnalysisAggStandard <- left_join(ResAnalysisAggStandard, sic2dtable, by = c("ASIC2d" = "Code.Value"), na_matches = "never")


ResAnalysisAggStandard <- select(ResAnalysisAggStandard,ASIC2d, Description, observed_firms, 
                              MeanGrowthShare, MeanRevenueShare_V)#, 
                              #MeanRevenueShare_A, MedianRevenueShare_A,  
                              #MeanRevenueShare_V, MedianRevenueShare_V, 
                              
                              #everything())


ResAnalysisAggStandard[,c(4:5)] <- round(ResAnalysisAggStandard[,c(4:5)]*100,2)

ResAnalysisAggStandard <- arrange(ResAnalysisAggStandard, desc(MeanGrowthShare))


############################################################################################################################################################################################################################################################################################################################################################################################
## SAMPLE 1


ResAnalysisCompu <- data.frame(SCMatchesNetRevsPureCompu)

ResAnalysisCompu$ASIC2d <- substr(ResAnalysisCompu$AcquirorSIC, start = 1, stop = 2)


ResAnalysisAggCompu <- ResAnalysisCompu %>% 
  group_by(ASIC2d) %>% 
  summarise( 
            MeanGrowthShare = mean(na.omit(GrowthShareOfAcquisition)) ,
            MedianGrowthShare = median(na.omit(GrowthShareOfAcquisition)),
            
            MeanRevenueShare_A = mean(na.omit(RevenueShare_A)),
            MedianRevenueShare_A = median(na.omit(RevenueShare_A)),
            
            MeanRevenueShare_V = mean(na.omit(RevenueShare_V)),
            MedianRevenueShare_V = median(na.omit(RevenueShare_V)),

            observed_firms = n_distinct(gvkey) ) 

n_distinct(ResAnalysisAggCompu$ASIC2d)

sic2dtable <- read.csv("sic_2_digit_codes.csv", colClasses = "character")

ResAnalysisAggCompu <- left_join(ResAnalysisAggCompu, sic2dtable, by = c("ASIC2d" = "Code.Value"), na_matches = "never")

ResAnalysisAggCompu <- select(ResAnalysisAggCompu,ASIC2d, Description, observed_firms, 
                              MeanGrowthShare, MeanRevenueShare_V)#, 
                              #MeanRevenueShare_A, MedianRevenueShare_A,  
                              #MeanRevenueShare_V, MedianRevenueShare_V, 
                              
                              #everything())


ResAnalysisAggCompu[,c(4:5)] <- round(ResAnalysisAggCompu[,c(4:5)]*100,2)

ResAnalysisAggCompu <- arrange(ResAnalysisAggCompu, desc(MeanGrowthShare))


############################################################################################################################################################################################################################################################################################################################################################################################
## SAMPLE 5

ResAnalysisPred <- data.frame(SCMatchesNetRevsPredicted)

ResAnalysisPred$ASIC2d <- substr(ResAnalysisPred$AcquirorSIC, start = 1, stop = 2)


ResAnalysisAggPred <- ResAnalysisPred %>% 
  group_by(ASIC2d) %>% 
  summarise( 
            MeanGrowthShare = mean(na.omit(GrowthShareOfAcquisition)) ,
            MedianGrowthShare = median(na.omit(GrowthShareOfAcquisition)),
            
            MeanRevenueShare_A = mean(na.omit(RevenueShare_A)),
            MedianRevenueShare_A = median(na.omit(RevenueShare_A)),
            
            MeanRevenueShare_V = mean(na.omit(RevenueShare_V)),
            MedianRevenueShare_V = median(na.omit(RevenueShare_V)),

            observed_firms = n_distinct(gvkey) ) 

n_distinct(ResAnalysisAggPred$ASIC2d)

sic2dtable <- read.csv("sic_2_digit_codes.csv", colClasses = "character")

ResAnalysisAggPred <- left_join(ResAnalysisAggPred, sic2dtable, by = c("ASIC2d" = "Code.Value"), na_matches = "never")

ResAnalysisAggPred <- select(ResAnalysisAggPred,ASIC2d, Description, observed_firms, 
                              MeanGrowthShare, MeanRevenueShare_V)#, 
                              #MeanRevenueShare_A, MedianRevenueShare_A,  
                              #MeanRevenueShare_V, MedianRevenueShare_V, 
                              
                              #everything())


ResAnalysisAggPred[,c(4:5)] <- round(ResAnalysisAggPred[,c(4:5)]*100,2)

ResAnalysisAggPred <- arrange(ResAnalysisAggPred, desc(MeanGrowthShare))

############################################################################################################################################################################################################################################################################################################################################################################################
## SAMPLE 4


ResAnalysisCompuPred <- data.frame(SCMatchesNetRevsCompuPred)

ResAnalysisCompuPred$ASIC2d <- substr(ResAnalysisCompuPred$AcquirorSIC, start = 1, stop = 2)


ResAnalysisAggCompuPred <- ResAnalysisCompuPred %>% 
  group_by(ASIC2d) %>% 
  summarise( 
            MeanGrowthShare = mean(na.omit(GrowthShareOfAcquisition)) ,
            MedianGrowthShare = median(na.omit(GrowthShareOfAcquisition)),
            
            MeanRevenueShare_A = mean(na.omit(RevenueShare_A)),
            MedianRevenueShare_A = median(na.omit(RevenueShare_A)),
            
            MeanRevenueShare_V = mean(na.omit(RevenueShare_V)),
            MedianRevenueShare_V = median(na.omit(RevenueShare_V)),

            observed_firms = n_distinct(gvkey) ) 

n_distinct(ResAnalysisAggCompuPred$ASIC2d)

sic2dtable <- read.csv("sic_2_digit_codes.csv", colClasses = "character")

ResAnalysisAggCompuPred <- left_join(ResAnalysisAggCompuPred, sic2dtable, by = c("ASIC2d" = "Code.Value"), 
                                     na_matches = "never")

ResAnalysisAggCompuPred <- select(ResAnalysisAggCompuPred,ASIC2d, Description, observed_firms, 
                              MeanGrowthShare, MeanRevenueShare_V)#, 
                              #MeanRevenueShare_A, MedianRevenueShare_A,  
                              #MeanRevenueShare_V, MedianRevenueShare_V, 
                              
                              #everything())


ResAnalysisAggCompuPred[,c(4:5)] <- round(ResAnalysisAggCompuPred[,c(4:5)]*100,2)

ResAnalysisAggCompuPred <- arrange(ResAnalysisAggCompuPred, desc(MeanGrowthShare))


############################################################################################################################################################################################################################################################################################################################################################################################
############################################################################################################################################################################################################################################################################################################################################################################################
#FILTERING THE RESULTS

ResAnalysisAggCompuFiltered <- filter(ResAnalysisAggCompu, observed_firms > 49)

ResAnalysisAggStandardFiltered <- filter(ResAnalysisAggStandard, observed_firms > 49)

ResAnalysisAggCompuPredFiltered <- filter(ResAnalysisAggCompuPred, observed_firms > 49)

ResAnalysisAggPredFiltered <- filter(ResAnalysisAggPred, observed_firms > 49)


```


  COMPUTING RESULTS FOR INDUSRIES: SUMMARIZING ACROSS FIRMS

```{r RESULTS: FIRMS ACROSS INDUSTRIES }

## SAMPLE 2

ResAnalysisStandard <- data.frame(SCMatchesNetRevsStandard)

ResAnalysisStandard$ASIC2d <- substr(ResAnalysisStandard$AcquirorSIC, start = 1, stop = 2)


ResAnalysisStandardGvk <- ResAnalysisStandard %>% 
  group_by(gvkey) %>% 
  summarise(conml = first(conml), FinalGrowthShare = last(GrowthShareOfAcquisition), 
            MeanGrowthShare = mean(na.omit(GrowthShareOfAcquisition)), 
            MeanRevenueShare_A = mean(na.omit(RevenueShare_A)),
            MeanRevenueShare_V = mean(na.omit(RevenueShare_V)),
            FinalSales = last(saleAc), ASIC2d = first(ASIC2d)) %>%
            ungroup()


ResAnalysisAggStandardIND <- ResAnalysisStandardGvk %>% 
  group_by(ASIC2d) %>% 
  summarise( 
            MeanGrowthShare = mean(na.omit(MeanGrowthShare)) ,

            MeanRevenueShare_A = mean(na.omit(MeanRevenueShare_A)),

            MeanRevenueShare_V = mean(na.omit(MeanRevenueShare_V)),

            meanFGS = mean(na.omit(FinalGrowthShare)),
            WmeanFGS =  sum(na.omit(FinalGrowthShare*FinalSales) ) / sum(na.omit(FinalSales)) ,

           observed_firms = n_distinct(gvkey)) 

n_distinct(ResAnalysisAggStandardIND$ASIC2d)

sic2dtable <- read.csv("sic_2_digit_codes.csv", colClasses = "character")

ResAnalysisAggStandardIND <- left_join(ResAnalysisAggStandardIND, sic2dtable, by = c("ASIC2d" = "Code.Value"), na_matches = "never")


ResAnalysisAggStandardIND <- select(ResAnalysisAggStandardIND,ASIC2d, Description, observed_firms, 
                              WmeanFGS, meanFGS, MeanRevenueShare_V)


ResAnalysisAggStandardIND[,c(4:6)] <- round(ResAnalysisAggStandardIND[,c(4:6)]*100,2)

ResAnalysisAggStandardIND <- arrange(ResAnalysisAggStandardIND, desc(WmeanFGS))

ResAnalysisAggStandardINDfilter <- filter(ResAnalysisAggStandardIND, observed_firms > 49)


############################################################################################################################################################################################################################################################################################################################################################################################
## SAMPLE 1

ResAnalysisCompu <- data.frame(SCMatchesNetRevsPureCompu)

ResAnalysisCompu$ASIC2d <- substr(ResAnalysisCompu$AcquirorSIC, start = 1, stop = 2)


ResAnalysisCompuGvk <- ResAnalysisCompu %>% 
  group_by(gvkey) %>% 
  summarise(conml = first(conml), FinalGrowthShare = last(GrowthShareOfAcquisition), 
            MeanGrowthShare = mean(na.omit(GrowthShareOfAcquisition)), 
            MeanRevenueShare_A = mean(na.omit(RevenueShare_A)),
            MeanRevenueShare_V = mean(na.omit(RevenueShare_V)),
            FinalSales = last(saleAc), ASIC2d = first(ASIC2d)) %>%
            ungroup()


ResAnalysisAggCompuIND <- ResAnalysisCompuGvk %>% 
  group_by(ASIC2d) %>% 
  summarise( 
            MeanGrowthShare = mean(na.omit(MeanGrowthShare)) ,

            MeanRevenueShare_A = mean(na.omit(MeanRevenueShare_A)),

            MeanRevenueShare_V = mean(na.omit(MeanRevenueShare_V)),

            meanFGS = mean(na.omit(FinalGrowthShare)),
            WmeanFGS =  sum(na.omit(FinalGrowthShare*FinalSales) ) / sum(na.omit(FinalSales)) ,

           observed_firms = n_distinct(gvkey)) 

n_distinct(ResAnalysisAggCompuIND$ASIC2d)

sic2dtable <- read.csv("sic_2_digit_codes.csv", colClasses = "character")

ResAnalysisAggCompuIND <- left_join(ResAnalysisAggCompuIND, sic2dtable, by = c("ASIC2d" = "Code.Value"), na_matches = "never")


ResAnalysisAggCompuIND <- select(ResAnalysisAggCompuIND,ASIC2d, Description, observed_firms, 
                              WmeanFGS, meanFGS, MeanRevenueShare_V)


ResAnalysisAggCompuIND[,c(4:6)] <- round(ResAnalysisAggCompuIND[,c(4:6)]*100,2)

ResAnalysisAggCompuIND <- arrange(ResAnalysisAggCompuIND, desc(WmeanFGS))

ResAnalysisAggCompuINDfilter <- filter(ResAnalysisAggCompuIND, observed_firms > 49)

############################################################################################################################################################################################################################################################################################################################################################################################
## SAMPLE 4

ResAnalysisCompuPred <- data.frame(SCMatchesNetRevsCompuPred)

ResAnalysisCompuPred$ASIC2d <- substr(ResAnalysisCompuPred$AcquirorSIC, start = 1, stop = 2)


ResAnalysisCompuPredGvk <- ResAnalysisCompuPred %>% 
  group_by(gvkey) %>% 
  summarise(conml = first(conml), FinalGrowthShare = last(GrowthShareOfAcquisition), 
            MeanGrowthShare = mean(na.omit(GrowthShareOfAcquisition)), 
            MeanRevenueShare_A = mean(na.omit(RevenueShare_A)),
            MeanRevenueShare_V = mean(na.omit(RevenueShare_V)),
            FinalSales = last(saleAc), ASIC2d = first(ASIC2d)) %>%
            ungroup()


ResAnalysisAggCompuPredIND <- ResAnalysisCompuPredGvk %>% 
  group_by(ASIC2d) %>% 
  summarise( 
            MeanGrowthShare = mean(na.omit(MeanGrowthShare)) ,

            MeanRevenueShare_A = mean(na.omit(MeanRevenueShare_A)),

            MeanRevenueShare_V = mean(na.omit(MeanRevenueShare_V)),

            meanFGS = mean(na.omit(FinalGrowthShare)),
            WmeanFGS =  sum(na.omit(FinalGrowthShare*FinalSales) ) / sum(na.omit(FinalSales)) ,

           observed_firms = n_distinct(gvkey)) 

n_distinct(ResAnalysisAggCompuPredIND$ASIC2d)

sic2dtable <- read.csv("sic_2_digit_codes.csv", colClasses = "character")

ResAnalysisAggCompuPredIND <- left_join(ResAnalysisAggCompuPredIND, sic2dtable, by = c("ASIC2d" = "Code.Value"),
                                        na_matches = "never")


ResAnalysisAggCompuPredIND <- select(ResAnalysisAggCompuPredIND,ASIC2d, Description, observed_firms, 
                              WmeanFGS, meanFGS, MeanRevenueShare_V)


ResAnalysisAggCompuPredIND[,c(4:6)] <- round(ResAnalysisAggCompuPredIND[,c(4:6)]*100,2)

ResAnalysisAggCompuPredIND <- arrange(ResAnalysisAggCompuPredIND, desc(WmeanFGS))

ResAnalysisAggCompuPredINDfilter <- filter(ResAnalysisAggCompuPredIND, observed_firms > 49)


```


  COMPUTING RESULTS FOR FIRM SIZES

```{r RESULTS FOR SIZE}

## SAMPLE 2

ResSizeStandard <- data.frame(SCMatchesNetRevsStandard)


ResSizeStandard <- ResSizeStandard %>%
  group_by(gvkey) %>%
  mutate(avgsales = mean(na.omit(saleAc)))   %>%
  mutate(LOGavgsales = log10(avgsales) )  %>%
  mutate(ClassLOGsales = round(LOGavgsales,0) )  %>%
  summarise(conml = first(conml), FinalGrowthShare = last(GrowthShareOfAcquisition), 
            MeanGrowthShare = mean(na.omit(GrowthShareOfAcquisition)), 
            MeanRevenueShare_A = mean(na.omit(RevenueShare_A)),
            MeanRevenueShare_V = mean(na.omit(RevenueShare_V)),
            FinalSales = last(saleAc), SizeGroup = first(ClassLOGsales)) %>%
            
  ungroup()



ResSizeGroupsStandard<- ResSizeStandard %>% 
  group_by(SizeGroup) %>% 
  summarise( 
            MeanGrowthShare = mean(na.omit(MeanGrowthShare)) ,

            MeanRevenueShare_A = mean(na.omit(MeanRevenueShare_A)),

            MeanRevenueShare_V = mean(na.omit(MeanRevenueShare_V)),

            meanFGS = mean(na.omit(FinalGrowthShare)),
            WmeanFGS =  sum(na.omit(FinalGrowthShare*FinalSales) ) / sum(na.omit(FinalSales)) ,

           observed_firms = n_distinct(gvkey)) %>% 
    
            ungroup()

ResSizeGroupsStandard[,c(2:6)] <- round(ResSizeGroupsStandard[,c(2:6)]*100,2)

ResSizeGroupsStandard$SALEN <- 10^ResSizeGroupsStandard$SizeGroup

ResSizeGroupsStandard$SizeGroup <- ResSizeGroupsStandard$SizeGroup + 2

ResSizeGroupsStandard <- select(ResSizeGroupsStandard, SizeGroup, SALEN, observed_firms, WmeanFGS, meanFGS,
                               MeanRevenueShare_V,  MeanRevenueShare_A)


############################################################################################################################################################################################################################################################################################################################################################################################
## SAMPLE 1

ResSizeCompu <- data.frame(SCMatchesNetRevsPureCompu)


ResSizeCompu <- ResSizeCompu %>%
  group_by(gvkey) %>%
  mutate(avgsales = mean(na.omit(saleAc)))   %>%
  mutate(LOGavgsales = log10(avgsales) )  %>%
  mutate(ClassLOGsales = round(LOGavgsales,0) )  %>%
  summarise(conml = first(conml), FinalGrowthShare = last(GrowthShareOfAcquisition), 
            MeanGrowthShare = mean(na.omit(GrowthShareOfAcquisition)), 
            MeanRevenueShare_A = mean(na.omit(RevenueShare_A)),
            MeanRevenueShare_V = mean(na.omit(RevenueShare_V)),
            FinalSales = last(saleAc), SizeGroup = first(ClassLOGsales)) %>%
            
  ungroup()



ResSizeGroupsCompu <- ResSizeCompu %>% 
  group_by(SizeGroup) %>% 
  summarise( 
            MeanGrowthShare = mean(na.omit(MeanGrowthShare)) ,

            MeanRevenueShare_A = mean(na.omit(MeanRevenueShare_A)),

            MeanRevenueShare_V = mean(na.omit(MeanRevenueShare_V)),

            meanFGS = mean(na.omit(FinalGrowthShare)),
            WmeanFGS =  sum(na.omit(FinalGrowthShare*FinalSales) ) / sum(na.omit(FinalSales)) ,

           observed_firms = n_distinct(gvkey)) %>% 
    
            ungroup()

ResSizeGroupsCompu[,c(2:6)] <- round(ResSizeGroupsCompu[,c(2:6)]*100,2)

ResSizeGroupsCompu$SALEN <- 10^ResSizeGroupsCompu$SizeGroup

ResSizeGroupsCompu$SizeGroup <- ResSizeGroupsCompu$SizeGroup + 2

ResSizeGroupsCompu <- select(ResSizeGroupsCompu, SizeGroup, SALEN, observed_firms, WmeanFGS, meanFGS,
                               MeanRevenueShare_V,  MeanRevenueShare_A)

############################################################################################################################################################################################################################################################################################################################################################################################
## SAMPLE 4

ResSizeCompuPred <- data.frame(SCMatchesNetRevsCompuPred)


ResSizeCompuPred <- ResSizeCompuPred %>%
  group_by(gvkey) %>%
  mutate(avgsales = mean(na.omit(saleAc)))   %>%
  mutate(LOGavgsales = log10(avgsales) )  %>%
  mutate(ClassLOGsales = round(LOGavgsales,0) )  %>%
  summarise(conml = first(conml), FinalGrowthShare = last(GrowthShareOfAcquisition), 
            MeanGrowthShare = mean(na.omit(GrowthShareOfAcquisition)), 
            MeanRevenueShare_A = mean(na.omit(RevenueShare_A)),
            MeanRevenueShare_V = mean(na.omit(RevenueShare_V)),
            FinalSales = last(saleAc), SizeGroup = first(ClassLOGsales)) %>%
            
  ungroup()



ResSizeGroupsCompuPred <- ResSizeCompuPred %>% 
  group_by(SizeGroup) %>% 
  summarise( 
            MeanGrowthShare = mean(na.omit(MeanGrowthShare)) ,

            MeanRevenueShare_A = mean(na.omit(MeanRevenueShare_A)),

            MeanRevenueShare_V = mean(na.omit(MeanRevenueShare_V)),

            meanFGS = mean(na.omit(FinalGrowthShare)),
            WmeanFGS =  sum(na.omit(FinalGrowthShare*FinalSales) ) / sum(na.omit(FinalSales)) ,

           observed_firms = n_distinct(gvkey)) %>% 
    
            ungroup()

ResSizeGroupsCompuPred[,c(2:6)] <- round(ResSizeGroupsCompuPred[,c(2:6)]*100,2)

ResSizeGroupsCompuPred$SALEN <- 10^ResSizeGroupsCompuPred$SizeGroup

ResSizeGroupsCompuPred$SizeGroup <- ResSizeGroupsCompuPred$SizeGroup + 2

ResSizeGroupsCompuPred <- select(ResSizeGroupsCompuPred, SizeGroup, SALEN, observed_firms, WmeanFGS, meanFGS,
                               MeanRevenueShare_V,  MeanRevenueShare_A)


```


  COMPUTING RESULTS FOR GEOGRAPHY: NATIONS AND US STATES, PREPARING THE HEAT MAPS

```{r RESULTS FOR GEOGRAPHY}

##SAMPLE 2

#### By Acquiror Nation
ResGEOStandard <- data.frame(SCMatchesNetRevsStandard)


ResGEOStandard <- ResGEOStandard %>%
  group_by(gvkey) %>%
  mutate(avgsales = mean(na.omit(saleAc)))   %>%
  mutate(LOGavgsales = log10(avgsales) )  %>%
  mutate(ClassLOGsales = round(LOGavgsales,0) )  %>%
  summarise(conml = first(conml), FinalGrowthShare = last(GrowthShareOfAcquisition), 
            MeanGrowthShare = mean(na.omit(GrowthShareOfAcquisition)), 
            MeanRevenueShare_A = mean(na.omit(RevenueShare_A)),
            MeanRevenueShare_V = mean(na.omit(RevenueShare_V)),
            FinalSales = last(saleAc), SizeGroup = first(ClassLOGsales),
            Nation = first(AcquirorNation)) %>%
            
  ungroup()



ResLOCATIONSStandard<- ResGEOStandard %>% 
  group_by(Nation) %>% 
  summarise( 
            MeanGrowthShare = mean(na.omit(MeanGrowthShare)) ,

            MeanRevenueShare_A = mean(na.omit(MeanRevenueShare_A)),

            MeanRevenueShare_V = mean(na.omit(MeanRevenueShare_V)),

            meanFGS = mean(na.omit(FinalGrowthShare)),
            WmeanFGS =  sum(na.omit(FinalGrowthShare*FinalSales) ) / sum(na.omit(FinalSales)) ,

           observed_firms = n_distinct(gvkey)) %>% 
    
            ungroup()

ResLOCATIONSStandard[,c(2:6)] <- round(ResLOCATIONSStandard[,c(2:6)]*100,2)

ResLOCATIONSStandard <- arrange(ResLOCATIONSStandard, desc(WmeanFGS))

ResLOCATIONSStandard <- select(ResLOCATIONSStandard, Nation, observed_firms, WmeanFGS, meanFGS,
                               MeanRevenueShare_V,  MeanRevenueShare_A)



map.world <- map_data(map="world")
map.world$subregion <- ifelse( is.na(map.world$subregion), 0, map.world$subregion)
map.world$region <- ifelse(map.world$subregion == "Hong Kong", "Hong Kong", map.world$region)

ResLOCATIONSStandard$Nation <- ifelse(ResLOCATIONSStandard$Nation  == "British Virgin", "Virgin Islands", 
                                      ResLOCATIONSStandard$Nation )
ResLOCATIONSStandard$Nation <- ifelse(ResLOCATIONSStandard$Nation  == "Ireland-Rep", "Ireland", 
                                      ResLOCATIONSStandard$Nation )
ResLOCATIONSStandard$Nation <- ifelse(ResLOCATIONSStandard$Nation  == "Papua N Guinea", "Guinea", 
                                      ResLOCATIONSStandard$Nation )
ResLOCATIONSStandard$Nation <- ifelse(ResLOCATIONSStandard$Nation  == "Neth Antilles", "Aruba", 
                                      ResLOCATIONSStandard$Nation )
ResLOCATIONSStandard$Nation <- ifelse(ResLOCATIONSStandard$Nation  == "Russian Fed", "Russia", 
                                      ResLOCATIONSStandard$Nation )
ResLOCATIONSStandard$Nation <- ifelse(ResLOCATIONSStandard$Nation  == "Trinidad&Tob", "Trinidad", 
                                      ResLOCATIONSStandard$Nation )
ResLOCATIONSStandard$Nation <- ifelse(ResLOCATIONSStandard$Nation  == "United Kingdom", "UK", 
                                      ResLOCATIONSStandard$Nation )
ResLOCATIONSStandard$Nation <- ifelse(ResLOCATIONSStandard$Nation  == "United States", "USA", 
                                      ResLOCATIONSStandard$Nation )



map.world <- left_join(map.world, ResLOCATIONSStandard, by = c("region" = "Nation"), na_matches = "never")
map.world$WmeanFGS <- ifelse(is.na(map.world$WmeanFGS), NA, 
                                     map.world$WmeanFGS)

map.world <- map.world[-c(2325:6982),]

gg <- ggplot()
gg <- gg + theme(legend.position="none")
gg <- gg + geom_map(data=map.world, map=map.world, aes(map_id=region, x=long, y=lat, fill=WmeanFGS))

gg <- gg + scale_fill_gradient(low = "#bed4fa", high = "#061a3b", na.value = "#e3e3e3", guide = "colourbar")
gg <- gg + coord_equal()
gg <- gg + theme_void()
gg <- gg + theme(legend.position="none")
gg


########################################################################
#### By Acquiror State
ResGEOStateStandard <- data.frame(SCMatchesNetRevsStandard)


ResGEOStateStandard <- ResGEOStateStandard %>%
  group_by(gvkey) %>%
  mutate(avgsales = mean(na.omit(saleAc)))   %>%
  mutate(LOGavgsales = log10(avgsales) )  %>%
  mutate(ClassLOGsales = round(LOGavgsales,0) )  %>%
  summarise(conml = first(conml), FinalGrowthShare = last(GrowthShareOfAcquisition), 
            MeanGrowthShare = mean(na.omit(GrowthShareOfAcquisition)), 
            MeanRevenueShare_A = mean(na.omit(RevenueShare_A)),
            MeanRevenueShare_V = mean(na.omit(RevenueShare_V)),
            FinalSales = last(saleAc), SizeGroup = first(ClassLOGsales),
            State = first(AcquirorState)) %>%
            
  ungroup()



ResLOCATIONSStateStandard<- ResGEOStateStandard %>% 
  group_by(State) %>% 
  summarise( 
            MeanGrowthShare = mean(na.omit(MeanGrowthShare)) ,

            MeanRevenueShare_A = mean(na.omit(MeanRevenueShare_A)),

            MeanRevenueShare_V = mean(na.omit(MeanRevenueShare_V)),

            meanFGS = mean(na.omit(FinalGrowthShare)),
            WmeanFGS =  sum(na.omit(FinalGrowthShare*FinalSales) ) / sum(na.omit(FinalSales)) ,

           observed_firms = n_distinct(gvkey)) %>% 
    
            ungroup()

ResLOCATIONSStateStandard[,c(2:6)] <- round(ResLOCATIONSStateStandard[,c(2:6)]*100,2)

ResLOCATIONSStateStandard <- arrange(ResLOCATIONSStateStandard, desc(WmeanFGS))


ResLOCATIONSStateStandard <- select(ResLOCATIONSStateStandard, State, observed_firms, WmeanFGS, meanFGS,
                               MeanRevenueShare_V,  MeanRevenueShare_A)



ResLOCATIONSStateStandard$State <- tolower(ResLOCATIONSStateStandard$State )

ResLOCATIONSStateStandard <- filter(ResLOCATIONSStateStandard, State != "foreign" & State != "unknown")

ResLOCATIONSStateStandard$State <- ifelse(ResLOCATIONSStateStandard$State  == "d. of columbia", "district of columbia", 
                                      ResLOCATIONSStateStandard$State )

states <- map_data("state")
states <- left_join(states, ResLOCATIONSStateStandard, by = c("region" = "State"), na_matches = "never")
states$WmeanFGS <- ifelse(is.na(states$WmeanFGS), NA, 
                                     states$WmeanFGS)


us2 <- ggplot()
us2 <- us2 + geom_map(data=states, map=states, aes(map_id=region, x=long, y=lat, fill=WmeanFGS))

us2 <- us2 + scale_fill_gradient(low = "#bed4fa", high = "#061a3b", na.value = "#e3e3e3", guide = "colourbar")
us2 <- us2 + coord_map()
us2 <- us2 + theme_void()
us2 <- us2 + theme(legend.position="none")
us2 <- us2 + ggtitle("SAMPLE 2") + theme(plot.title = element_text(vjust = - 90, hjust =  0.1))
us2


######################################################################################################################################################################################################################################################################################################################################################################################################## SAMPLE 1

#### By Acquiror Nation

ResGEOCompu <- data.frame(SCMatchesNetRevsPureCompu)


ResGEOCompu <- ResGEOCompu %>%
  group_by(gvkey) %>%
  mutate(avgsales = mean(na.omit(saleAc)))   %>%
  mutate(LOGavgsales = log10(avgsales) )  %>%
  mutate(ClassLOGsales = round(LOGavgsales,0) )  %>%
  summarise(conml = first(conml), FinalGrowthShare = last(GrowthShareOfAcquisition), 
            MeanGrowthShare = mean(na.omit(GrowthShareOfAcquisition)), 
            MeanRevenueShare_A = mean(na.omit(RevenueShare_A)),
            MeanRevenueShare_V = mean(na.omit(RevenueShare_V)),
            FinalSales = last(saleAc), SizeGroup = first(ClassLOGsales),
            Nation = first(AcquirorNation)) %>%
            
  ungroup()



ResLOCATIONSCompu <- ResGEOCompu %>% 
  group_by(Nation) %>% 
  summarise( 
            MeanGrowthShare = mean(na.omit(MeanGrowthShare)) ,

            MeanRevenueShare_A = mean(na.omit(MeanRevenueShare_A)),

            MeanRevenueShare_V = mean(na.omit(MeanRevenueShare_V)),

            meanFGS = mean(na.omit(FinalGrowthShare)),
            WmeanFGS =  sum(na.omit(FinalGrowthShare*FinalSales) ) / sum(na.omit(FinalSales)) ,

           observed_firms = n_distinct(gvkey)) %>% 
    
            ungroup()

ResLOCATIONSCompu[,c(2:6)] <- round(ResLOCATIONSCompu[,c(2:6)]*100,2)

ResLOCATIONSCompu <- arrange(ResLOCATIONSCompu, desc(WmeanFGS))

ResLOCATIONSCompu <- select(ResLOCATIONSCompu, Nation, observed_firms, WmeanFGS, meanFGS,
                               MeanRevenueShare_V,  MeanRevenueShare_A)


ResLOCATIONSCompu$Nation <- ifelse(ResLOCATIONSCompu$Nation  == "British Virgin", "Virgin Islands", 
                                      ResLOCATIONSCompu$Nation )

ResLOCATIONSCompu$Nation <- ifelse(ResLOCATIONSCompu$Nation  == "Ireland-Rep", "Ireland", 
                                      ResLOCATIONSCompu$Nation )

ResLOCATIONSCompu$Nation <- ifelse(ResLOCATIONSCompu$Nation  == "Papua N Guinea", "Guinea", 
                                      ResLOCATIONSCompu$Nation )

ResLOCATIONSCompu$Nation <- ifelse(ResLOCATIONSCompu$Nation  == "Neth Antilles", "Aruba", 
                                      ResLOCATIONSCompu$Nation )

ResLOCATIONSCompu$Nation <- ifelse(ResLOCATIONSCompu$Nation  == "Russian Fed", "Russia", 
                                      ResLOCATIONSCompu$Nation )

ResLOCATIONSCompu$Nation <- ifelse(ResLOCATIONSCompu$Nation  == "Trinidad&Tob", "Trinidad", 
                                      ResLOCATIONSCompu$Nation )

ResLOCATIONSCompu$Nation <- ifelse(ResLOCATIONSCompu$Nation  == "United Kingdom", "UK", 
                                      ResLOCATIONSCompu$Nation )

ResLOCATIONSCompu$Nation <- ifelse(ResLOCATIONSCompu$Nation  == "United States", "USA", 
                                      ResLOCATIONSCompu$Nation )

###########################################################
#### By Acquiror State
ResGEOStateCompu <- data.frame(SCMatchesNetRevsPureCompu)


ResGEOStateCompu <- ResGEOStateCompu %>%
  group_by(gvkey) %>%
  mutate(avgsales = mean(na.omit(saleAc)))   %>%
  mutate(LOGavgsales = log10(avgsales) )  %>%
  mutate(ClassLOGsales = round(LOGavgsales,0) )  %>%
  summarise(conml = first(conml), FinalGrowthShare = last(GrowthShareOfAcquisition), 
            MeanGrowthShare = mean(na.omit(GrowthShareOfAcquisition)), 
            MeanRevenueShare_A = mean(na.omit(RevenueShare_A)),
            MeanRevenueShare_V = mean(na.omit(RevenueShare_V)),
            FinalSales = last(saleAc), SizeGroup = first(ClassLOGsales),
            State = first(AcquirorState)) %>%
            
  ungroup()



ResLOCATIONSStateCompu <- ResGEOStateCompu %>% 
  group_by(State) %>% 
  summarise( 
            MeanGrowthShare = mean(na.omit(MeanGrowthShare)) ,

            MeanRevenueShare_A = mean(na.omit(MeanRevenueShare_A)),

            MeanRevenueShare_V = mean(na.omit(MeanRevenueShare_V)),

            meanFGS = mean(na.omit(FinalGrowthShare)),
            WmeanFGS =  sum(na.omit(FinalGrowthShare*FinalSales) ) / sum(na.omit(FinalSales)) ,

           observed_firms = n_distinct(gvkey)) %>% 
    
            ungroup()

ResLOCATIONSStateCompu[,c(2:6)] <- round(ResLOCATIONSStateCompu[,c(2:6)]*100,2)

ResLOCATIONSStateCompu <- arrange(ResLOCATIONSStateCompu, desc(WmeanFGS))


ResLOCATIONSStateCompu <- select(ResLOCATIONSStateCompu, State, observed_firms, WmeanFGS, meanFGS,
                               MeanRevenueShare_V,  MeanRevenueShare_A)


ResLOCATIONSStateCompu$State <- tolower(ResLOCATIONSStateCompu$State )

ResLOCATIONSStateCompu$State <- ifelse(ResLOCATIONSStateCompu$State  == "d. of columbia", "district of columbia", 
                                      ResLOCATIONSStateCompu$State )

ResLOCATIONSStateCompu <- filter(ResLOCATIONSStateCompu, State != "foreign" & State != "unknown" & State != "west virginia")

## REMOVE WEST VIRGINIA: ONLY ONE OBSERVATION WHICH CAN BE TRACKED TO THE COMPANY, WHICH HAS TWO DIFFERENT ACQUIROR NAMES ATTRIBUTED TO A CONML (ONE ACQUIROR HAS HOMESTATE PENNSYLVAINA, THE OTHER WEST VIRGINIA -> A SUBSIDARY OF CONML). THE CONML'S REAL STATE IS PENNSYLVANIA. ONLY IN SAMPLE 1 WEST VIRGINIA IS (RIGHTFULLY) PICKED BECAUSE ONLY THE ACQUIROR WITH WEST VIRGINIA HAS AN OBSERVED SALES VALUE FROM COMPUSTAT. VERY RARE CASE.

states <- map_data("state")

states <- left_join(states, ResLOCATIONSStateCompu, by = c("region" = "State"), na_matches = "never")
states$WmeanFGS <- ifelse(is.na(states$WmeanFGS), NA, 
                                     states$WmeanFGS)



us1 <- ggplot()
us1 <- us1 + geom_map(data=states, map=states, aes(map_id=region, x=long, y=lat, fill=WmeanFGS))

us1 <- us1 + scale_fill_gradient(low = "#bed4fa", high = "#061a3b", na.value = "#e3e3e3", guide = "colourbar")
us1 <- us1 + coord_map()
us1 <- us1 + theme_void()
us1 <- us1 + theme(legend.position="none")
us1 <- us1 + ggtitle("SAMPLE 1") + theme(plot.title = element_text(vjust = - 90, hjust =  0.1))
us1

############################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################
######### SAMPLE 4

#####  BY Acquiror Nation

ResGEOCompuPred <- data.frame(SCMatchesNetRevsCompuPred)


ResGEOCompuPred <- ResGEOCompuPred %>%
  group_by(gvkey) %>%
  mutate(avgsales = mean(na.omit(saleAc)))   %>%
  mutate(LOGavgsales = log10(avgsales) )  %>%
  mutate(ClassLOGsales = round(LOGavgsales,0) )  %>%
  summarise(conml = first(conml), FinalGrowthShare = last(GrowthShareOfAcquisition), 
            MeanGrowthShare = mean(na.omit(GrowthShareOfAcquisition)), 
            MeanRevenueShare_A = mean(na.omit(RevenueShare_A)),
            MeanRevenueShare_V = mean(na.omit(RevenueShare_V)),
            FinalSales = last(saleAc), SizeGroup = first(ClassLOGsales),
            Nation = first(AcquirorNation)) %>%
            
  ungroup()



ResLOCATIONSCompuPred <- ResGEOCompuPred %>% 
  group_by(Nation) %>% 
  summarise( 
            MeanGrowthShare = mean(na.omit(MeanGrowthShare)) ,

            MeanRevenueShare_A = mean(na.omit(MeanRevenueShare_A)),

            MeanRevenueShare_V = mean(na.omit(MeanRevenueShare_V)),

            meanFGS = mean(na.omit(FinalGrowthShare)),
            WmeanFGS =  sum(na.omit(FinalGrowthShare*FinalSales) ) / sum(na.omit(FinalSales)) ,

           observed_firms = n_distinct(gvkey)) %>% 
    
            ungroup()

ResLOCATIONSCompuPred[,c(2:6)] <- round(ResLOCATIONSCompuPred[,c(2:6)]*100,2)

ResLOCATIONSCompuPred <- arrange(ResLOCATIONSCompuPred, desc(WmeanFGS))

ResLOCATIONSCompuPred <- select(ResLOCATIONSCompuPred, Nation, observed_firms, WmeanFGS, meanFGS,
                               MeanRevenueShare_V,  MeanRevenueShare_A)


ResLOCATIONSCompuPred$Nation <- ifelse(ResLOCATIONSCompuPred$Nation  == "British Virgin", "Virgin Islands", 
                                      ResLOCATIONSCompuPred$Nation )

ResLOCATIONSCompuPred$Nation <- ifelse(ResLOCATIONSCompuPred$Nation  == "Ireland-Rep", "Ireland", 
                                      ResLOCATIONSCompuPred$Nation )

ResLOCATIONSCompuPred$Nation <- ifelse(ResLOCATIONSCompuPred$Nation  == "Papua N Guinea", "Guinea", 
                                      ResLOCATIONSCompuPred$Nation )

ResLOCATIONSCompuPred$Nation <- ifelse(ResLOCATIONSCompuPred$Nation  == "Neth Antilles", "Aruba", 
                                      ResLOCATIONSCompuPred$Nation )

ResLOCATIONSCompuPred$Nation <- ifelse(ResLOCATIONSCompuPred$Nation  == "Russian Fed", "Russia", 
                                      ResLOCATIONSCompuPred$Nation )

ResLOCATIONSCompuPred$Nation <- ifelse(ResLOCATIONSCompuPred$Nation  == "Trinidad&Tob", "Trinidad", 
                                      ResLOCATIONSCompuPred$Nation )

ResLOCATIONSCompuPred$Nation <- ifelse(ResLOCATIONSCompuPred$Nation  == "United Kingdom", "UK", 
                                      ResLOCATIONSCompuPred$Nation )

ResLOCATIONSCompuPred$Nation <- ifelse(ResLOCATIONSCompuPred$Nation  == "United States", "USA", 
                                      ResLOCATIONSCompuPred$Nation )



######################################################################
#### By Acquiror State
ResGEOStateCompuPred <- data.frame(SCMatchesNetRevsCompuPred)


ResGEOStateCompuPred <- ResGEOStateCompuPred %>%
  group_by(gvkey) %>%
  mutate(avgsales = mean(na.omit(saleAc)))   %>%
  mutate(LOGavgsales = log10(avgsales) )  %>%
  mutate(ClassLOGsales = round(LOGavgsales,0) )  %>%
  summarise(conml = first(conml), FinalGrowthShare = last(GrowthShareOfAcquisition), 
            MeanGrowthShare = mean(na.omit(GrowthShareOfAcquisition)), 
            MeanRevenueShare_A = mean(na.omit(RevenueShare_A)),
            MeanRevenueShare_V = mean(na.omit(RevenueShare_V)),
            FinalSales = last(saleAc), SizeGroup = first(ClassLOGsales),
            State = first(AcquirorState)) %>%
            
  ungroup()


ResLOCATIONSStateCompuPred <- ResGEOStateCompuPred %>% 
  group_by(State) %>% 
  summarise( 
            MeanGrowthShare = mean(na.omit(MeanGrowthShare)) ,

            MeanRevenueShare_A = mean(na.omit(MeanRevenueShare_A)),

            MeanRevenueShare_V = mean(na.omit(MeanRevenueShare_V)),

            meanFGS = mean(na.omit(FinalGrowthShare)),
            WmeanFGS =  sum(na.omit(FinalGrowthShare*FinalSales) ) / sum(na.omit(FinalSales)) ,

           observed_firms = n_distinct(gvkey)) %>% 
    
            ungroup()

ResLOCATIONSStateCompuPred[,c(2:6)] <- round(ResLOCATIONSStateCompuPred[,c(2:6)]*100,2)

ResLOCATIONSStateCompuPred <- arrange(ResLOCATIONSStateCompuPred, desc(WmeanFGS))


ResLOCATIONSStateCompuPred <- select(ResLOCATIONSStateCompuPred, State, observed_firms, WmeanFGS, meanFGS,
                               MeanRevenueShare_V,  MeanRevenueShare_A)


ResLOCATIONSStateCompuPred$State <- tolower(ResLOCATIONSStateCompuPred$State )

ResLOCATIONSStateCompuPred$State <- ifelse(ResLOCATIONSStateCompuPred$State  == "d. of columbia", "district of columbia", 
                                      ResLOCATIONSStateCompuPred$State )

ResLOCATIONSStateCompuPred <- filter(ResLOCATIONSStateCompuPred, State != "foreign" & State != "unknown")


states <- map_data("state")

states <- left_join(states, ResLOCATIONSStateCompuPred, by = c("region" = "State"), na_matches = "never")
states$WmeanFGS <- ifelse(is.na(states$WmeanFGS), NA, 
                                     states$WmeanFGS)



us4 <- ggplot()
us4 <- us4 + geom_map(data=states, map=states, aes(map_id=region, x=long, y=lat, fill=WmeanFGS))

us4 <- us4 + scale_fill_gradient(low = "#bed4fa", high = "#061a3b", na.value = "#e3e3e3", guide = "colourbar")
us4 <- us4 + coord_map()
us4 <- us4 + theme_void()
us4 <- us4 + theme(legend.position="none")
us4 <- us4 + ggtitle("SAMPLE 4") + theme(plot.title = element_text(vjust = - 90, hjust =  0.1))
us4


############################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################
############ SAMPLE 5

#### By Acquiror Nation

ResGEOPred <- data.frame(SCMatchesNetRevsPredicted)


ResGEOPred <- ResGEOPred %>%
  group_by(gvkey) %>%
  mutate(avgsales = mean(na.omit(saleAc)))   %>%
  mutate(LOGavgsales = log10(avgsales) )  %>%
  mutate(ClassLOGsales = round(LOGavgsales,0) )  %>%
  summarise(conml = first(conml), FinalGrowthShare = last(GrowthShareOfAcquisition), 
            MeanGrowthShare = mean(na.omit(GrowthShareOfAcquisition)), 
            MeanRevenueShare_A = mean(na.omit(RevenueShare_A)),
            MeanRevenueShare_V = mean(na.omit(RevenueShare_V)),
            FinalSales = last(saleAc), SizeGroup = first(ClassLOGsales),
            Nation = first(AcquirorNation)) %>%
            
  ungroup()

n_distinct(SDC$ROWINDEX.sdc)

ResLOCATIONSPred<- ResGEOPred %>% 
  group_by(Nation) %>% 
  summarise( 
            MeanGrowthShare = mean(na.omit(MeanGrowthShare)) ,

            MeanRevenueShare_A = mean(na.omit(MeanRevenueShare_A)),

            MeanRevenueShare_V = mean(na.omit(MeanRevenueShare_V)),

            meanFGS = mean(na.omit(FinalGrowthShare)),
            WmeanFGS =  sum(na.omit(FinalGrowthShare*FinalSales) ) / sum(na.omit(FinalSales)) ,

           observed_firms = n_distinct(gvkey)) %>% 
    
            ungroup()

ResLOCATIONSPred[,c(2:6)] <- round(ResLOCATIONSPred[,c(2:6)]*100,2)

ResLOCATIONSPred <- arrange(ResLOCATIONSPred, desc(WmeanFGS))

ResLOCATIONSPred <- select(ResLOCATIONSPred, Nation, observed_firms, WmeanFGS, meanFGS,
                               MeanRevenueShare_V,  MeanRevenueShare_A)


ResLOCATIONSPred$Nation <- ifelse(ResLOCATIONSPred$Nation  == "British Virgin", "Virgin Islands", 
                                      ResLOCATIONSPred$Nation )

ResLOCATIONSPred$Nation <- ifelse(ResLOCATIONSPred$Nation  == "Ireland-Rep", "Ireland", 
                                      ResLOCATIONSPred$Nation )

ResLOCATIONSPred$Nation <- ifelse(ResLOCATIONSPred$Nation  == "Papua N Guinea", "Guinea", 
                                      ResLOCATIONSPred$Nation )

ResLOCATIONSPred$Nation <- ifelse(ResLOCATIONSPred$Nation  == "Neth Antilles", "Aruba", 
                                      ResLOCATIONSPred$Nation )

ResLOCATIONSPred$Nation <- ifelse(ResLOCATIONSPred$Nation  == "Russian Fed", "Russia", 
                                      ResLOCATIONSPred$Nation )

ResLOCATIONSPred$Nation <- ifelse(ResLOCATIONSPred$Nation  == "Trinidad&Tob", "Trinidad", 
                                      ResLOCATIONSPred$Nation )

ResLOCATIONSPred$Nation <- ifelse(ResLOCATIONSPred$Nation  == "United Kingdom", "UK", 
                                      ResLOCATIONSPred$Nation )

ResLOCATIONSPred$Nation <- ifelse(ResLOCATIONSPred$Nation  == "United States", "USA", 
                                      ResLOCATIONSPred$Nation )




########################################################################
#### By Acquiror State

ResGEOStatePred <- data.frame(SCMatchesNetRevsPredicted)


ResGEOStatePred <- ResGEOStatePred %>%
  group_by(gvkey) %>%
  mutate(avgsales = mean(na.omit(saleAc)))   %>%
  mutate(LOGavgsales = log10(avgsales) )  %>%
  mutate(ClassLOGsales = round(LOGavgsales,0) )  %>%
  summarise(conml = first(conml), FinalGrowthShare = last(GrowthShareOfAcquisition), 
            MeanGrowthShare = mean(na.omit(GrowthShareOfAcquisition)), 
            MeanRevenueShare_A = mean(na.omit(RevenueShare_A)),
            MeanRevenueShare_V = mean(na.omit(RevenueShare_V)),
            FinalSales = last(saleAc), SizeGroup = first(ClassLOGsales),
            State = first(AcquirorState)) %>%
            
  ungroup()



ResLOCATIONSStatePred <- ResGEOStatePred %>% 
  group_by(State) %>% 
  summarise( 
            MeanGrowthShare = mean(na.omit(MeanGrowthShare)) ,

            MeanRevenueShare_A = mean(na.omit(MeanRevenueShare_A)),

            MeanRevenueShare_V = mean(na.omit(MeanRevenueShare_V)),

            meanFGS = mean(na.omit(FinalGrowthShare)),
            WmeanFGS =  sum(na.omit(FinalGrowthShare*FinalSales) ) / sum(na.omit(FinalSales)) ,

           observed_firms = n_distinct(gvkey)) %>% 
    
            ungroup()

ResLOCATIONSStatePred[,c(2:6)] <- round(ResLOCATIONSStatePred[,c(2:6)]*100,2)

ResLOCATIONSStatePred <- arrange(ResLOCATIONSStatePred, desc(WmeanFGS))


ResLOCATIONSStatePred <- select(ResLOCATIONSStatePred, State, observed_firms, WmeanFGS, meanFGS,
                               MeanRevenueShare_V,  MeanRevenueShare_A)


ResLOCATIONSStatePred$State <- tolower(ResLOCATIONSStatePred$State )

ResLOCATIONSStatePred$State <- ifelse(ResLOCATIONSStatePred$State  == "d. of columbia", "district of columbia", 
                                      ResLOCATIONSStatePred$State )


ResLOCATIONSStatePred <- filter(ResLOCATIONSStatePred, State != "foreign" & State != "unknown")



states <- map_data("state")

states <- left_join(states, ResLOCATIONSStatePred, by = c("region" = "State"), na_matches = "never")
states$WmeanFGS <- ifelse(is.na(states$WmeanFGS), NA, 
                                     states$WmeanFGS)



us5 <- ggplot()
us5 <- us5 + geom_map(data=states, map=states, aes(map_id=region, x=long, y=lat, fill=WmeanFGS))

us5 <- us5 + scale_fill_gradient(low = "#bed4fa", high = "#061a3b", na.value = "#e3e3e3", guide = "colourbar")
us5 <- us5 + coord_map()
us5 <- us5 + theme_void()
us5 <- us5 + theme(legend.position="none")
us5 <- us5 + ggtitle("SAMPLE 4") + theme(plot.title = element_text(vjust = - 90, hjust =  0.1))
us5

```


  CREATING THE HEAT MAPS FOR US STATES
  
```{r STATE PLOTS}

states1 <- map_data("state")

states1 <- left_join(states1, ResLOCATIONSStateCompu, by = c("region" = "State"), na_matches = "never")
states1$WmeanFGS <- ifelse(is.na(states1$WmeanFGS), NA, 
                                     states1$WmeanFGS)



us1 <- ggplot()
us1 <- us1 + geom_map(data=states1, map=states1, aes(map_id=region, x=long, y=lat, fill=WmeanFGS))

us1 <- us1 + scale_fill_gradient(low = "#bed4fa", high = "#061a3b", na.value = "#e3e3e3", guide = "colourbar")
us1 <- us1 + coord_map()
us1 <- us1 + theme_void()
us1 <- us1 + theme(legend.position="none")


#############################################################################################################################################################################################################################################################################################################################################################################################

states2 <- map_data("state")
states2 <- left_join(states2, ResLOCATIONSStateStandard, by = c("region" = "State"), na_matches = "never")
states2$WmeanFGS <- ifelse(is.na(states2$WmeanFGS), NA, 
                                     states2$WmeanFGS)


us2 <- ggplot()
us2 <- us2 + geom_map(data=states2, map=states2, aes(map_id=region, x=long, y=lat, fill=WmeanFGS))

us2 <- us2 + scale_fill_gradient(low = "#bed4fa", high = "#061a3b", na.value = "#e3e3e3", guide = "colourbar")
us2 <- us2 + coord_map()
us2 <- us2 + theme_void()
us2 <- us2 + theme(legend.position="none")

#############################################################################################################################################################################################################################################################################################################################################################################################


states4 <- map_data("state")

states4 <- left_join(states4, ResLOCATIONSStateCompuPred, by = c("region" = "State"), na_matches = "never")
states4$WmeanFGS <- ifelse(is.na(states4$WmeanFGS), NA, 
                                     states4$WmeanFGS)



us4 <- ggplot()
us4 <- us4 + geom_map(data=states4, map=states4, aes(map_id=region, x=long, y=lat, fill=WmeanFGS))

us4 <- us4 + scale_fill_gradient(low = "#bed4fa", high = "#061a3b", na.value = "#e3e3e3", guide = "colourbar")
us4 <- us4 + coord_map()
us4 <- us4 + theme_void()
us4 <- us4 + theme(legend.position="none")


#############################################################################################################################################################################################################################################################################################################################################################################################

states5 <- map_data("state")

states5 <- left_join(states5, ResLOCATIONSStatePred, by = c("region" = "State"), na_matches = "never")
states5$WmeanFGS <- ifelse(is.na(states5$WmeanFGS), NA, 
                                     states5$WmeanFGS)



us5 <- ggplot()
us5 <- us5 + geom_map(data=states5, map=states5, aes(map_id=region, x=long, y=lat, fill=WmeanFGS))

us5 <- us5 + scale_fill_gradient(low = "#bed4fa", high = "#061a3b", na.value = "#e3e3e3", guide = "colourbar")
us5 <- us5 + coord_map()
us5 <- us5 + theme_void()
us5 <- us5 + theme(legend.position="none")



#######################################
# FINAL PLOT

plot_grid(us1, us2, us4, us5, align = "v", nrow = 2, labels=c('SAMPLE 1', 'SAMPLE 2', 'SAMPLE 4', 'SAMPLE 5'))

```


-> END OF MAIN CODE

----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------


## CREATING TABLES FOR THE TEXT PART

  SECTION 4 TABLES (RESULTS)

```{r SECETION 4 TABLES}

## MAIN RESULTS BY FIRM
print(xtable(RESULTS_FIRM, type = "latex"), file = "MainResultsByFirm.tex")

## MAIN RESULTS BY OBSERVATION
print(xtable(RESULTS_OBSERVATIONS, type = "latex"), file = "MainResultsByObservation.tex")

############################################################################################################################################################################################################################################################################################################################################################################################### INDUSTRIES

## ACROSS OBSERVATIONS

print(xtable(ResAnalysisAggCompuFiltered, type = "latex"), file = "INDUSTRYResultsByOBSERVATIONS_1.tex")

print(xtable(ResAnalysisAggStandardFiltered, type = "latex"), file = "INDUSTRYResultsByOBSERVATIONS_2.tex")

print(xtable(ResAnalysisAggCompuPredFiltered, type = "latex"), file = "INDUSTRYResultsByOBSERVATIONS_4.tex")

print(xtable(ResAnalysisAggPredFiltered, type = "latex"), file = "INDUSTRYResultsByOBSERVATIONS_5.tex")


## ACROSS FIRMS

print(xtable(ResAnalysisAggCompuINDfilter, type = "latex"), file = "INDUSTRYResultsByFIRMS_1.tex")

print(xtable(ResAnalysisAggStandardINDfilter, type = "latex"), file = "INDUSTRYResultsByFIRMS_2.tex")

print(xtable(ResAnalysisAggCompuPredINDfilter, type = "latex"), file = "INDUSTRYResultsByFIRMS_4.tex")

############################################################################################################################################################################################################################################################################################################################################################################################### SIZE

print(xtable(ResSizeGroupsCompu, type = "latex"), file = "SIZEResults_1.tex")

print(xtable(ResSizeGroupsStandard, type = "latex"), file = "SIZEResults_2.tex")

print(xtable(ResSizeGroupsCompuPred, type = "latex"), file = "SIZEResults_4.tex")


#############################################################################################################################################################################################################################################################################################################################################################################################
#############################################################################################################################
#  By Location World

# SAMPLE 1

ResLOCATIONSCompufilter <- filter(ResLOCATIONSCompu, observed_firms > 4)
print(xtable(ResLOCATIONSCompufilter, type = "latex"), file = "NATIONResults_1.tex")

# SAMPLE 2

ResLOCATIONSStandardfilter <- filter(ResLOCATIONSStandard, observed_firms > 4)
print(xtable(ResLOCATIONSStandardfilter, type = "latex"), file = "NATIONResults_2.tex")


 # SAMPLE 4

ResLOCATIONSCompuPredfilter <- filter(ResLOCATIONSCompuPred, observed_firms > 4)
print(xtable(ResLOCATIONSCompuPredfilter, type = "latex"), file = "NATIONResults_4.tex")

## SAMPLE 5

ResLOCATIONSPredfilter <- filter(ResLOCATIONSPred, observed_firms > 4)
print(xtable(ResLOCATIONSPredfilter, type = "latex"), file = "NATIONResults_5.tex")

###############################################################################################################################
###############################################################################################################################
#  By Location STATE


# SAMPLE 1
ResLOCATIONSStateCompufilter <- filter(ResLOCATIONSStateCompu, observed_firms > 4)
ResLOCATIONSStateCompufilter$State <- str_to_title(ResLOCATIONSStateCompufilter$State)
print(xtable(ResLOCATIONSStateCompufilter, type = "latex"), file = "STATEResults_1.tex")

# SAMPLE 2
ResLOCATIONSStateStandardfilter <- filter(ResLOCATIONSStateStandard, observed_firms > 4)
ResLOCATIONSStateStandardfilter$State <- str_to_title(ResLOCATIONSStateStandardfilter$State)
print(xtable(ResLOCATIONSStateStandardfilter, type = "latex"), file = "STATEResults_2.tex")

# SAMPLE 4
ResLOCATIONSStateCompuPredfilter <- filter(ResLOCATIONSStateCompuPred, observed_firms > 4)
ResLOCATIONSStateCompuPredfilter$State <- str_to_title(ResLOCATIONSStateCompuPredfilter$State)
print(xtable(ResLOCATIONSStateCompuPredfilter, type = "latex"), file = "STATEResults_4.tex")

# SAMPLE 5
ResLOCATIONSStatePredfilter <- filter(ResLOCATIONSStatePred, observed_firms > 4)
ResLOCATIONSStatePredfilter$State <- str_to_title(ResLOCATIONSStatePredfilter$State)
print(xtable(ResLOCATIONSStatePredfilter, type = "latex"), file = "STATEResults_5.tex")




```


## CREATING THE PLOTS

```{r GRAPH GENERATOR}

##################################################################################
# SALES DIFF PLOT: BASED ON YEAR ANNOUNCED -1

require(plyr)

saleDiffDF <- filter(SCMatchesFinMATCHES, !is.na(saleDiff))

saleDiffDF <- select(saleDiffDF, TargetNetSales, sale, yearDiff)

saleDiffDF$saleDi <- saleDiffDF$sale - saleDiffDF$TargetNetSales

saleDiffDF$RelsaleDi <- (saleDiffDF$saleDi / saleDiffDF$sale) * 100

saleDiffDF$DevBrackets <- round_any(saleDiffDF$RelsaleDi, 10) 

saleDiffDF$logsale <- log10(saleDiffDF$sale)

saleDiffDF$SaleBrackets <- round_any(saleDiffDF$logsale, 1) 

saleDiffDF$absrelsale <- abs(saleDiffDF$RelsaleDi)

mean(saleDiffDF$RelsaleDi)
median(saleDiffDF$RelsaleDi)


verylowdiff <- filter(saleDiffDF, absrelsale < 5)

sal0 <- filter(saleDiffDF, yearDiff == 0)
sal1 <- filter(saleDiffDF, yearDiff == 1)
sal2 <- filter(saleDiffDF, yearDiff == 2)

sal0Ag <- ddply(sal0, .(sal0$SaleBrackets, sal0$DevBrackets), nrow)
names(sal0Ag) <- c("SaleBrackets", "DevBrackets", "Freq")
sal0Ag$year <- 0

sal1Ag <- ddply(sal1, .(sal1$SaleBrackets, sal1$DevBrackets), nrow)
names(sal1Ag) <- c("SaleBrackets", "DevBrackets", "Freq")
sal1Ag$year <- 1

sal2Ag <- ddply(sal2, .(sal2$SaleBrackets, sal2$DevBrackets), nrow)
names(sal2Ag) <- c("SaleBrackets", "DevBrackets", "Freq")
sal2Ag$year <- 2

salDF <- rbind(sal0Ag,sal1Ag,sal2Ag)

detach(package:plyr)

labstext <- c(10^(-2),10^(0),10^(2),10^(4))


saleplot_NLIM <- ggplot(salDF, aes(x=SaleBrackets, y=DevBrackets)) + geom_point(aes(size = Freq, colour = year), alpha = 0.15) +
  scale_size_continuous(range = c(1, 75)) + #scale_y_continuous(limits = c(-100, 100)) +
  scale_x_continuous(breaks=c(-2,0,2,4),labels = labstext) +
  labs(x ="Sales Value in Compustat (Mil.  $)", y = "% Deviation of Corresponding SDC Value") +
  theme(legend.position="none")

#print(saleplot_NLIM)


saleplot_20k <- ggplot(salDF, aes(x=SaleBrackets, y=DevBrackets)) + geom_point(aes(size = Freq, colour = year), alpha = 0.1) +
  scale_size_continuous(range = c(1, 75)) + scale_y_continuous(limits = c(-20000, 1000)) +
  scale_x_continuous(breaks=c(-2,0,2,4),labels = labstext) +
  labs(x ="Sales Value in Compustat (Mil.  $)", y = "% Deviation of Corresponding SDC Value") +
  theme(legend.position="none")
#removes 1 point
#print(saleplot_20k)


saleplot_2k <- ggplot(salDF, aes(x=SaleBrackets, y=DevBrackets)) + geom_point(aes(size = Freq, colour = year), alpha = 0.1) +
  scale_size_continuous(range = c(1, 75)) + scale_y_continuous(limits = c(-2000, 500)) +
  scale_x_continuous(breaks=c(-2,0,2,4),labels = labstext) +
  labs(x ="Sales Value in Compustat (Mil.  $)", y = "% Deviation of Corresponding SDC Value") +
  theme(legend.position="none")
#removes 5 points
#print(saleplot_2k)


saleplot_0.5k <- ggplot(salDF, aes(x=SaleBrackets, y=DevBrackets)) + geom_point(aes(size = Freq, colour = year), alpha = 0.1) +
  scale_size_continuous(range = c(1, 75)) + scale_y_continuous(limits = c(-500, 250)) +
  scale_x_continuous(breaks=c(-2,0,2,4),labels = labstext) +
  labs(x ="Sales Value in Compustat (Mil.  $)", y = "% Deviation of Corresponding SDC Value") +
  theme(legend.position="none")
#removes 19 points
#print(saleplot_0.5k)

saleplot_0.1k <- ggplot(salDF, aes(x=SaleBrackets, y=DevBrackets)) + geom_point(aes(size = Freq, colour = year), alpha = 0.15) +
  scale_size_continuous(range = c(1, 75)) + scale_y_continuous(limits = c(-100, 100)) +
  scale_x_continuous(breaks=c(-2,0,2,4),labels = labstext) +
  labs(x ="Sales Value in Compustat (Mil. $)", y = "") +
  theme(legend.position="none")

#print(saleplot_NLIM) #
#print(saleplot_20k) #1
#print(saleplot_2k)  #5
#print(saleplot_0.5k) #19
#print(saleplot_0.1k) #86


plot_grid(saleplot_NLIM, saleplot_0.1k, align = "h", nrow = 1, rel_heights = c(1, 1))

## darkest color is zero years difference

###########################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################
## COMPUTING PLOT FOR SIZE RESULTS

plotsharesizeDF <- data.frame(ResSizeGroupsStandard)

plotsharesizeDF <- rename(plotsharesizeDF, wmFCASSG = WmeanFGS, mFCASSG =  meanFGS, 
                          mYASSG = MeanRevenueShare_V, mCASS = MeanRevenueShare_A)

plotsharesize <- ggplot(plotsharesizeDF, aes(x = SizeGroup)) + geom_line(aes(y = wmFCASSG, colour = "wmFCASSG")) + 
  geom_line(aes(y = mFCASSG, colour = "mFCASSG")) + geom_line(aes(y = mYASSG, colour = "mYASSG"))  + 
  geom_line(aes(y = mCASS, colour = "mCASS")) + 
  scale_color_manual(
    values = c("wmFCASSG" = "#648ed1", "mFCASSG" = "#060608", "mYASSG" = "#808bab" , 
               "mCASS" = "#b8c3e3"))  +
  labs(y= "Share Measure in %", x = "Firm Size Groups") +
  theme(legend.title=element_blank(), legend.justification = c(1, 1),  legend.position = c(1, 1))

  print(plotsharesize)


############################################################################################################################################################################################################################################################################################################################################################################################
############################################################################################################################################################################################################################################################################################################################################################################################

### DIAGNOSTIC PLOT COMPUSTAT PREDICTIONS

CompSalesFOLSnoFix <- with(FINTraining,
                     lm(LOGSales ~ LOGValueOfTr + LOGACSales + XofSharesAcq,
                     data = FINTraining)    )

par(mfrow = c(2,2))
plot(CompSalesFOLSnoFix, pch = 10, cex = 0.2)

###########################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################
## DISTRIBUTION OF SHARES ACQUIRED AND VALUE OF TRANSACTIONS

SDC_100Share<- filter(SDC, !is.na(X.ofSharesAcq.))

labletext <- c(10^-2,10^0,10^2,10^4,10^6)

shareplot <- ggplot(SDC_100Share, aes(x=X.ofSharesAcq.)) + geom_histogram() +
  labs(y= "Frequency", x = "% of Shares Acquired in Transaction")
print(shareplot)


valueplot <- ggplot(SDC, aes(x=log10(ValueofTransaction..mil.))) + geom_histogram() +
  labs(y= "", x = "Value of Transaction in Million $") +
  scale_x_continuous(breaks=c(-2,0,2,4,6),labels = labletext) 
print(valueplot)


plot_grid(shareplot, valueplot, align = "v", nrow = 1, rel_heights = c(1, 1))


###########################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################
## DISTRIBUTION YEARLY VOLUME AND NUMBER OF TRANSACTIONS

SDC_PLOTTING <- data.frame(SDC)
SDC_PLOTTING$number <- 1

SDC_PLOTTING$YEAR <- substr(SDC_PLOTTING$DateEffective, start = 1, stop = 4)

PLOT_YEAR_VALUE <- select(SDC_PLOTTING, YEAR, ValueofTransaction..mil., number)

PLOT_YEAR_VALUE <- PLOT_YEAR_VALUE %>% 
  group_by(YEAR) %>%                            
  summarise(SumTransactions = sum(ValueofTransaction..mil.), NumberOfDeals = sum(number))


PLOT_YEAR_VALUE <- PLOT_YEAR_VALUE[c(1:42),]

maactivity <- ggplot(PLOT_YEAR_VALUE, aes(x = YEAR, y = SumTransactions )) + 
  geom_line(linetype = 3, group = 1) +   
  scale_x_discrete(guide = guide_axis(n.dodge=3))  + 
  labs(y= "Yearly Transaction Volume in Million $", x = "") + 
  geom_point(shape = 13)

plot(maactivity)


numberyear <- ggplot(PLOT_YEAR_VALUE, aes(x = YEAR, y = NumberOfDeals )) + 
  geom_line(linetype = 3, group = 1) +   
  scale_x_discrete(guide = guide_axis(n.dodge=3))  + 
  labs(y= "Yearly Transaction Volume in Million $", x = "") + 
  geom_point(shape = 13)


plot(numberyear)

###########################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################
## PLOTTING COMPUSTAT OBSERVATIONS AND MAXIMUM SALES VALUE DISTRIBUTION

SALES_PLOTTING <- data.frame(SALES)

SALES_PLOTTING$summer <- 1

PLOT_OBSERAVTION_YEAR <- select(SALES_PLOTTING, year, summer)

PLOT_OBSERAVTION_YEAR <- PLOT_OBSERAVTION_YEAR %>% 
  group_by(year) %>%                            
  summarise(NumberObservations = sum(summer))


observationplot <- ggplot(PLOT_OBSERAVTION_YEAR, aes(x = year, y = NumberObservations)) + geom_line(linetype = 3, group = 1)  + labs(y= "Yearly Observations", x = "Year") +  geom_point(shape = 13)
print(observationplot)


scale_x_discrete(guide = guide_axis(n.dodge=1)) 

##########################

SALES_PLOTTINGDist <- data.frame(SALES)

SALES_PLOTTINGDist <- select(SALES_PLOTTINGDist, gvkey, sale, year)

SALES_PLOTTINGDist <- SALES_PLOTTINGDist %>% 
  group_by(gvkey) %>% 
  slice(which.max(sale))

SALES_PLOTTINGDist$sale <- SALES_PLOTTINGDist$sale/1000


xsteps <- c(10^-2, 10^0, 10^2, 10^4, 10^6)


saledistplot <- ggplot(SALES_PLOTTINGDist, aes(x = log10(sale))) + geom_histogram() +
  scale_x_continuous(breaks=c(-2, 0, 2, 4, 6),labels = xsteps) +
  labs(y= "Frequency", x = "Maximum Sales Value per Firm (in Mil.$)")
print(saledistplot)


plot_grid(observationplot, saledistplot, align = "h", nrow = 1, rel_heights = c(1, 1))


############################################################################################################################################################################################################################################################################################################################################################################################
## DISTRIBTUTION OF DELISTIN YEARS

leftfirmleaves <- data.frame(LEFT)
leftfirmleaves <- select(leftfirmleaves, gvkey, year)

leftleaveplot <- ggplot(leftfirmleaves, aes(x = year)) + geom_histogram(binwidth=1) +
  labs(y= "Frequency", x = "Last Year Observed")
print(leftleaveplot)

###########################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################
## COMPUTING PLOT FOR SALES DIFFERENCES BASED ON YEAR EFFECTIVE

require(plyr)

saleDiffDF <- filter(SCMatchesFinMATCHES, !is.na(saleDiff))

saleDiffDF <- select(saleDiffDF, TargetNetSales, sale, yearDiff)

saleDiffDF$saleDi <- saleDiffDF$sale - saleDiffDF$TargetNetSales

saleDiffDF$RelsaleDi <- (saleDiffDF$saleDi / saleDiffDF$sale) * 100

saleDiffDF$DevBrackets <- round_any(saleDiffDF$RelsaleDi, 5) 

saleDiffDF$logsale <- log10(saleDiffDF$sale)

saleDiffDF$SaleBrackets <- round_any(saleDiffDF$logsale, 1) 

write.csv(saleDiffDF, "saleDiffDF.csv", na = "")


sal0 <- filter(saleDiffDF, yearDiff == 0)
sal1 <- filter(saleDiffDF, yearDiff == 1)
sal2 <- filter(saleDiffDF, yearDiff == 2)

sal0Ag <- ddply(sal0, .(sal0$SaleBrackets, sal0$DevBrackets), nrow)
names(sal0Ag) <- c("SaleBrackets", "DevBrackets", "Freq")
sal0Ag$year <- 0

sal1Ag <- ddply(sal1, .(sal1$SaleBrackets, sal1$DevBrackets), nrow)
names(sal1Ag) <- c("SaleBrackets", "DevBrackets", "Freq")
sal1Ag$year <- 1

sal2Ag <- ddply(sal2, .(sal2$SaleBrackets, sal2$DevBrackets), nrow)
names(sal2Ag) <- c("SaleBrackets", "DevBrackets", "Freq")
sal2Ag$year <- 2

salDF <- rbind(sal0Ag,sal1Ag,sal2Ag)

detach(package:plyr)

labstext <- c(10^(2),10^(4),10^(6),10^(8))


saleplot_NLIM <- ggplot(salDF, aes(x=SaleBrackets, y=DevBrackets)) + geom_point(aes(size = Freq, colour = year), alpha = 0.15) +
  scale_size_continuous(range = c(1, 56)) + #scale_y_continuous(limits = c(-100, 100)) +
  scale_x_continuous(breaks=c(2,4,6,8),labels = labstext) +
  labs(x ="Sales Value in Compustat (Thousand $)", y = "% Deviation of Corresponding SDC Value") +
  theme(legend.position="none")

print(saleplot_NLIM)


saleplot_20k <- ggplot(salDF, aes(x=SaleBrackets, y=DevBrackets)) + geom_point(aes(size = Freq, colour = year), alpha = 0.1) +
  scale_size_continuous(range = c(1, 56)) + scale_y_continuous(limits = c(-20000, 1000)) +
  scale_x_continuous(breaks=c(2,4,6,8),labels = labstext) +
  labs(x ="Sales Value in Compustat (Thousand $)", y = "% Deviation of Corresponding SDC Value") +
  theme(legend.position="none")
#removes 1 point
print(saleplot_20k)


saleplot_2k <- ggplot(salDF, aes(x=SaleBrackets, y=DevBrackets)) + geom_point(aes(size = Freq, colour = year), alpha = 0.1) +
  scale_size_continuous(range = c(1, 56)) + scale_y_continuous(limits = c(-2000, 500)) +
  scale_x_continuous(breaks=c(2,4,6,8),labels = labstext) +
  labs(x ="Sales Value in Compustat (Thousand $)", y = "% Deviation of Corresponding SDC Value") +
  theme(legend.position="none")
#removes 5 points
print(saleplot_2k)


saleplot_0.5k <- ggplot(salDF, aes(x=SaleBrackets, y=DevBrackets)) + geom_point(aes(size = Freq, colour = year), alpha = 0.1) +
  scale_size_continuous(range = c(1, 56)) + scale_y_continuous(limits = c(-500, 250)) +
  scale_x_continuous(breaks=c(2,4,6,8),labels = labstext) +
  labs(x ="Sales Value in Compustat (Thousand $)", y = "% Deviation of Corresponding SDC Value") +
  theme(legend.position="none")
#removes 19 points
print(saleplot_0.5k)

saleplot_0.1k <- ggplot(salDF, aes(x=SaleBrackets, y=DevBrackets)) + geom_point(aes(size = Freq, colour = year), alpha = 0.15) +
  scale_size_continuous(range = c(1, 56)) + scale_y_continuous(limits = c(-100, 100)) +
  scale_x_continuous(breaks=c(2,4,6,8),labels = labstext) +
  labs(x ="Sales Value in Compustat (Thousand $)", y = "") +
  theme(legend.position="none")
#removes 86 points
print(saleplot_0.1k)

#print(saleplot_NLIM) #
#print(saleplot_20k) #1
#print(saleplot_2k)  #5
#print(saleplot_0.5k) #19
#print(saleplot_0.1k) #86

plot_grid(saleplot_NLIM, saleplot_0.1k, align = "h", nrow = 1, rel_heights = c(1, 1))


```


## COMPUTING OTHER CONTENT NEEDED FOR THE TEXT

  COMPUTING THE KEDNALL DISTANCE
  
```{r COMPUTING RANKING SIMILARITY KENDALL DISTANCE}

ResTestStandard <- data.frame(ResLOCATIONSStandard)
ResTestStandard <- arrange(ResTestStandard, Nation)

ResTestCompu <- data.frame(ResLOCATIONSCompu)
ResTestCompu <- ResTestCompu[-40,]
ResTestCompu <- filter(ResTestCompu, observed_firms > 4)


ResTestCompu <- arrange(ResTestCompu, Nation)

ResTestCompuPred <- data.frame(ResLOCATIONSCompuPred)
ResTestCompuPred <- arrange(ResTestCompuPred, Nation)


COMPUcountries <- ResTestCompu$Nation

ResTestStandard <- filter(ResTestStandard, Nation %in% COMPUcountries)
ResTestCompuPred <- filter(ResTestCompuPred, Nation %in% COMPUcountries)


ResTestStandard$rank <- seq(1:length(ResTestStandard$Nation))
ResTestStandard <- arrange(ResTestStandard, desc(WmeanFGS))

ResTestCompu$rank <- seq(1:length(ResTestCompu$Nation))
ResTestCompu <- arrange(ResTestCompu, desc(WmeanFGS))

ResTestCompuPred$rank <- seq(1:length(ResTestCompuPred$Nation))
ResTestCompuPred <- arrange(ResTestCompuPred, desc(WmeanFGS))



RankStandard <- ResTestStandard$rank
RankCompu <- ResTestCompu$rank
RankCompuPred <- ResTestCompuPred$rank


DistancePair(RankStandard, RankCompu)
DistancePair(RankStandard, RankCompuPred)
DistancePair(RankCompu, RankCompuPred)
DistancePair(RankStandard, RankStandard)


```


  COMPUTING SOME VALUES, STATISTCS AND TABLES NEEDED FOR THE TEXT (UNORDERED)

```{r COMPUTING STATISTICS AND  SUBSETS (NOTEPAD)}

min(SDC$ValueofTransaction..mil.)*1000000
max(SDC$ValueofTransaction..mil.)*1000000
mean((SDC$ValueofTransaction..mil.))
median((SDC$ValueofTransaction..mil.))
mean(log(SDC$ValueofTransaction..mil.))
median(log(SDC$ValueofTransaction..mil.))


mean(SDC_100Share$X.ofSharesAcq.)
median(SDC_100Share$X.ofSharesAcq.)


n_distinct(SDC$AcquirorName)

n_distinct(SDC$AcquirorPrimarySICCode )
n_distinct(SDC$TargetPrimarySICCode )

US_AC_SDC <- filter(SDC, AcquirorNation == "United States")
US_TA_SDC <- filter(SDC, TargetNation == "United States")

n_distinct(US_TA_SDC$TargetName)

SDClargeval <- filter(SDC, ValueofTransaction..mil. >= 1000)
SDCsmallval <- filter(SDC, ValueofTransaction..mil. <= 1)


############################################################################################################################################################################################################################################################################################################################################################################################### Compustat

n_distinct(SALES$gvkey)
n_distinct(SALES$year)

LeftCountYears <- data.frame(LEFT)
LeftCountYears <- select(LeftCountYears, gvkey, year)
LeftCountYears$su <- 1

LeftCountYears <- LeftCountYears %>%
  group_by(year)  %>%
  summarise(countyear = sum(su))

n_distinct(LEFT$naics)

LEFT <- arrange(LEFT, year)

median(SALES$sale)


############################################################################################################################################################################################################################################################################################################################################################################################### Compustat


ImplausibleSales <- select(SDC,TargetName , YEARef, TargetNetSalesLTM..mil., 
                           PredictedSales, ValueofTransaction..mil.)

ImplausibleSales <- arrange(ImplausibleSales, desc(TargetNetSalesLTM..mil.))

ImplausibleSales$TargetNetSalesLTM..mil. <- round(ImplausibleSales$TargetNetSalesLTM..mil., 0)

ImplausibleSales$ImpliedSalesBillions <- round(ImplausibleSales$TargetNetSalesLTM..mil./1000, 0)

ImplausibleSales <- ImplausibleSales %>%
  group_by(TargetName) %>%
  slice(which.max(ImpliedSalesBillions))

ImplausibleSales <- select(ImplausibleSales, TargetName, YEARef, TargetNetSalesLTM..mil., ImpliedSalesBillions)

ImplausibleSales <- arrange(ImplausibleSales, desc(ImpliedSalesBillions))



###############################################################################################################################


ImplausibleSalesMatches <- select(SCMatches, TargetName , YEARef, TargetNetSalesLTMmil, 
                           PredictedSales, ValueofTransactionmil)

ImplausibleSalesMatches <- arrange(ImplausibleSalesMatches, desc(TargetNetSalesLTMmil))

ImplausibleSalesMatches$TargetNetSalesLTMmil <- round(ImplausibleSalesMatches$TargetNetSalesLTMmil, 0)

ImplausibleSalesMatches$ImpliedSalesBillions <- round(ImplausibleSalesMatches$TargetNetSalesLTMmil/1000, 0)

ImplausibleSalesMatches <- ImplausibleSalesMatches %>%
  group_by(TargetName) %>%
  slice(which.max(ImpliedSalesBillions))

ImplausibleSalesMatches <- select(ImplausibleSalesMatches, TargetName, YEARef, TargetNetSalesLTMmil, ImpliedSalesBillions)

ImplausibleSalesMatches <- arrange(ImplausibleSalesMatches, desc(ImpliedSalesBillions))

###############################################################################################################################

SDC_UNIQUE <- distinct(SDC, ROWINDEX.sdc, .keep_all = TRUE)

SDC_UNIQUE <- filter(SDC_UNIQUE, !is.na(ValueofTransaction..mil.) & !is.na(X.ofSharesAcq.) 
                     & !is.na(AcquirorIndustrySector)& !is.na(AcquirorNation)& !is.na(AcquirorState)
                      & !is.na(TargetIndustrySector)& !is.na(TargetNation) & !is.na(TargetState) & !is.na(YEARef) &
                       is.na(TargetNetSalesLTM..mil.))

SDC_UNIQUE2 <- filter(SDC_UNIQUE, !is.na(TargetNetSalesLTM..mil.))

###########################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################

F1 <- select(SCMatches, conml, cusip, AcquirorName, TargetName, METHOD, AcquirorCUSIP, 
             AcqNewCUSIP, AcquirorImmediateParentCUSIP,
                    AcquirorUltimateParentCUSIP, AcquirorPrimaryTickerSymbol, AcqNewTICKER, AcquirorUltimateParentTickerSymbol,
                    AcquirorTickerSymbol, TargetNetSalesLTMmil, ValueofTransactionmil)

F1 <- filter(F1, METHOD == "Name")
F1 <- arrange(F1, desc(ValueofTransactionmil))

F2 <- filter(SCMatches, METHOD == "URLs" & AcquirorName != conml)




F3 <- filter(SCMatchesFin, TargetName == "3Com Corp")

F3 <- select(F3, gvkey, conml, METHOD, AcquirorName, TargetName, gvkeyT, yearS, sale, YEARan, yearDiff, 
             ValueofTransactionmil, ROWINDEXsdc)

print(xtable(F3, type = "latex"), file = "new_example_targetyeardiff.tex")


F3 <- filter(SCMatchesAllSaleSources, AcquirorState == "Montana")


F3 <- select(F3, AcquirorName, AcquirorState, AcquirorNation, AcquirorPrimarySICCode,
                       TargetName, TargetState, TargetNation, TargetPrimarySICCode,
                       sale, saleAc, TargetNetSales, PredictedCompu, ValueofTransactionmil, XofSharesAcq, YEARef, AcquirorPrimarySICCode2D,
             TargetPrimarySICCode2D, everything())


n_distinct(SCMatchesNetRevsStandard$gvkey)

##### MATCH OVERVIEW TABLE

distinct(SALES_FIRM_MATCHES, METHOD)

CUSIP.R <- filter(SALES_FIRM_MATCHES, METHOD == "CUSIP" )
CUSIP.R.D <- distinct(CUSIP.R,gvkey)
length(CUSIP.R$gvkey)
length(CUSIP.R.D$gvkey)

NewCUSIP.R <- filter(SALES_FIRM_MATCHES, METHOD == "NewCUSIP")
NewCUSIP.R.D <- distinct(NewCUSIP.R,gvkey)
length(NewCUSIP.R$gvkey)
length(NewCUSIP.R.D$gvkey)

ImmCUSIP.R <- filter(SALES_FIRM_MATCHES, METHOD == "ImmediateParentCUSIP")
ImmCUSIP.R.D <- distinct(ImmCUSIP.R,gvkey)
length(ImmCUSIP.R$gvkey)
length(ImmCUSIP.R.D$gvkey)

UltCUSIP.R <- filter(SALES_FIRM_MATCHES, METHOD == "UltimateParentCUSIP")
UltCUSIP.R.D <- distinct(UltCUSIP.R,gvkey)
length(UltCUSIP.R$gvkey)
length(UltCUSIP.R.D$gvkey)

NAME.R <- filter(SALES_FIRM_MATCHES, METHOD == "Name")
NAME.R.D <- distinct(NAME.R,gvkey)
length(NAME.R$gvkey)
length(NAME.R.D$gvkey)

TICKER.R <- filter(SALES_FIRM_MATCHES, METHOD == "Ticker")
TICKER.R.D <- distinct(TICKER.R,gvkey)
length(TICKER.R$gvkey)
length(TICKER.R.D$gvkey)

ParTICKER.R <- filter(SALES_FIRM_MATCHES, METHOD == "ParentTicker")
ParTICKER.R.D <- distinct(ParTICKER.R,gvkey)
length(ParTICKER.R$gvkey)
length(ParTICKER.R.D$gvkey)

NewTICKER.R <- filter(SALES_FIRM_MATCHES, METHOD == "NewTicker")
NewTICKER.R.D <- distinct(NewTICKER.R,gvkey)
length(NewTICKER.R$gvkey)
length(NewTICKER.R.D$gvkey)

URL.R <- filter(SALES_FIRM_MATCHES, METHOD == "URLs")
URL.R.D <- distinct(URL.R,gvkey)
length(URL.R$gvkey)
length(URL.R.D$gvkey)

SumCheck <- n_distinct(CUSIP.R.D$gvkey) +
                n_distinct(NewCUSIP.R.D$gvkey) +
                n_distinct(ImmCUSIP.R.D$gvkey) +
                n_distinct(UltCUSIP.R.D$gvkey) +
                n_distinct(NAME.R.D$gvkey) +
                n_distinct(TICKER.R.D$gvkey) +
                n_distinct(ParTICKER.R.D$gvkey) +
                n_distinct(NewTICKER.R.D$gvkey) +
                n_distinct(URL.R.D$gvkey)

SumCheck
n_distinct(SALES_FIRM_MATCHES$gvkey)


##### MATCH OVERVIEW TABLE : UNFILTERED MATCHES

M_CUSIP.R.D <- select(M_CUSIP, ROWINDEX.sdc, gvkey)
M_CUSIP.R.D <- distinct(M_CUSIP.R.D,ROWINDEX.sdc, .keep_all = T)
#length(M_CUSIP.R.D$ROWINDEX.sdc)
n_distinct(M_CUSIP.R.D$gvkey)

M_NEWCUSIP.R.D <- select(M_NEWCUSIP, ROWINDEX.sdc, gvkey)
M_NEWCUSIP.R.D <- distinct(M_NEWCUSIP.R.D,ROWINDEX.sdc, .keep_all = T)
#length(M_NEWCUSIP.R.D$ROWINDEX.sdc)
n_distinct(M_NEWCUSIP.R.D$gvkey)

M_IMMED_CUSIP.R.D <- select(M_IMMED_CUSIP, ROWINDEX.sdc, gvkey)
M_IMMED_CUSIP.R.D <- distinct(M_IMMED_CUSIP.R.D,ROWINDEX.sdc, .keep_all = T)
#length(M_IMMED_CUSIP.R.D$ROWINDEX.sdc)
n_distinct(M_IMMED_CUSIP.R.D$gvkey)

M_ULTIMATE_CUSIP.R.D <- select(M_ULTIMATE_CUSIP, ROWINDEX.sdc, gvkey)
M_ULTIMATE_CUSIP.R.D <- distinct(M_ULTIMATE_CUSIP.R.D,ROWINDEX.sdc, .keep_all = T)
#length(M_ULTIMATE_CUSIP.R.D$ROWINDEX.sdc)
n_distinct(M_ULTIMATE_CUSIP.R.D$gvkey)

M_NAME.R.D <- select(M_NAME, ROWINDEX.sdc, gvkey)
M_NAME.R.D <- distinct(M_NAME.R.D,ROWINDEX.sdc, .keep_all = T)
#length(M_NAME.R.D$ROWINDEX.sdc)
n_distinct(M_NAME.R.D$gvkey)

M_TIC.R.D <- select(M_TIC, ROWINDEX.sdc, gvkey)
M_TIC.R.D <- distinct(M_TIC.R.D,ROWINDEX.sdc, .keep_all = T)
#length(M_TIC.R.D$ROWINDEX.sdc)
n_distinct(M_TIC.R.D$gvkey)

M_PARENTIC.R.D <- select(M_PARENTIC, ROWINDEX.sdc, gvkey)
M_PARENTIC.R.D <- distinct(M_PARENTIC.R.D,ROWINDEX.sdc, .keep_all = T)
#length(M_PARENTIC.R.D$ROWINDEX.sdc)
n_distinct(M_PARENTIC.R.D$gvkey)

M_NEWTIC.R.D <- select(M_NEWTIC, ROWINDEX.sdc, gvkey)
M_NEWTIC.R.D <- distinct(M_NEWTIC.R.D,ROWINDEX.sdc, .keep_all = T)
#length(M_NEWTIC.R.D$ROWINDEX.sdc)
n_distinct(M_NEWTIC.R.D$gvkey)

M_URL.R.D <- select(M_URL, ROWINDEX.sdc, gvkey)
M_URL.R.D <- distinct(M_URL.R.D,ROWINDEX.sdc, .keep_all = T)
#length(M_URL.R.D$ROWINDEX.sdc)
n_distinct(M_URL.R.D$gvkey)


#### Results for Cleaned Matches (SC Matches)

CUSIP.R <- filter(SCMatches, METHOD == "CUSIP" )
CUSIP.R.D <- distinct(CUSIP.R,gvkey)
length(CUSIP.R$gvkey)
length(CUSIP.R.D$gvkey)

NewCUSIP.R <- filter(SCMatches, METHOD == "NewCUSIP")
NewCUSIP.R.D <- distinct(NewCUSIP.R,gvkey)
length(NewCUSIP.R$gvkey)
length(NewCUSIP.R.D$gvkey)

ImmCUSIP.R <- filter(SCMatches, METHOD == "ImmediateParentCUSIP")
ImmCUSIP.R.D <- distinct(ImmCUSIP.R,gvkey)
length(ImmCUSIP.R$gvkey)
length(ImmCUSIP.R.D$gvkey)

UltCUSIP.R <- filter(SCMatches, METHOD == "UltimateParentCUSIP")
UltCUSIP.R.D <- distinct(UltCUSIP.R,gvkey)
length(UltCUSIP.R$gvkey)
length(UltCUSIP.R.D$gvkey)

NAME.R <- filter(SCMatches, METHOD == "Name")
NAME.R.D <- distinct(NAME.R,gvkey)
length(NAME.R$gvkey)
length(NAME.R.D$gvkey)

TICKER.R <- filter(SCMatches, METHOD == "Ticker")
TICKER.R.D <- distinct(TICKER.R,gvkey)
length(TICKER.R$gvkey)
length(TICKER.R.D$gvkey)

ParTICKER.R <- filter(SCMatches, METHOD == "ParentTicker")
ParTICKER.R.D <- distinct(ParTICKER.R,gvkey)
length(ParTICKER.R$gvkey)
length(ParTICKER.R.D$gvkey)

NewTICKER.R <- filter(SCMatches, METHOD == "NewTicker")
NewTICKER.R.D <- distinct(NewTICKER.R,gvkey)
length(NewTICKER.R$gvkey)
length(NewTICKER.R.D$gvkey)

URL.R <- filter(SCMatches, METHOD == "URLs")
URL.R.D <- distinct(URL.R,gvkey)
length(URL.R$gvkey)
length(URL.R.D$gvkey)

n_distinct(SCMatches$TargetName)
n_distinct(SDC$TargetName)

n_distinct(LTargets$gvkey)

n_distinct(LTargets$conml)


###########################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################

actable <- select(SCMatches, gvkey, conml, METHOD, AcquirorName, TargetName, DateEffective, 
                  ValueofTransactionmil, XofSharesAcq)


actable <- filter(actable, conml == "Advanced Micro Devices Inc")

actable <- arrange(actable, DateEffective)


###########################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################

tartable <- select(LTargets, gvkey, conml, METHOD, TargetName, AcquirorName, DateEffective, 
                  ValueofTransactionmil, XofSharesAcq)


tartable <- filter(tartable, conml == "3Com Corp")

tartable <- arrange(tartable, DateEffective)

n_distinct(LTargets$conml)
n_distinct(LTargets$ROWINDEXsdc)

#############################################################################################################################################################################################################################################################################################################################################################################################

netrevtable <- data.frame(SCMatchesNetRevsStandard)

netrevtable <- filter(netrevtable, conml == "Advanced Micro Devices Inc")

yearstotake <- c(1972, 1973, 1985, 1986, 1987, 1988, 1995, 1996, 1997,2005, 2006, 2007, 2015, 2016)


netrevtable <- filter(netrevtable, AcYear %in% yearstotake)

netrevtable <- netrevtable[, c(1:20)]

netrevtable <- netrevtable[, -c(1,14)]

netrevtable <- netrevtable[, -c(16,17)]

netrevtable$conml <- "AMD Inc"

print(xtable(netrevtable, type = "latex"), file = "netrevtableFORTEXT.tex")
print(xtable(netrevtable, type = "latex"), file = "netrevtableAPPENDIX.tex")


```


## TRIALS / EXAMPLES


  ILLUSTRATING AN EXAMPLE FOR THE SUMMARY STATISTICS (BASED ON MEETING)
  
```{r TRIAL COMPUTING REVENUE SHARES}

exampleDF <- data.frame(Revenue = c(1,3,10), "RevenueFromAcquisitions" = c(0,1,2) )

exampleDF <- exampleDF %>% 
  
  mutate(Observations =  row_number() )  %>%
  
  mutate(CumuRevenueFromAcquisitions = cumsum(RevenueFromAcquisitions)) %>% 
  
  mutate(RevenueGrowth = Revenue - lag(Revenue)) %>% 
  
  mutate(CumuRevenueGrowth = cumsum(  replace(RevenueGrowth,is.na(RevenueGrowth), 0) )  ) %>% 
  
  mutate(CumuRevenueShare = round(CumuRevenueFromAcquisitions / CumuRevenueGrowth,3) ) %>% 
  
  mutate(CumuRevenueShare = replace(CumuRevenueShare , is.na(CumuRevenueShare ), NA)) %>% 
  
  mutate(RevenueShare_A =  round(CumuRevenueFromAcquisitions / Revenue,3) )  %>% 
  
  mutate(RevenueShare_V = round( (RevenueFromAcquisitions / RevenueGrowth ) , 3) ) %>% rationalize()

exampleDF <- select(exampleDF, Revenue, RevenueGrowth, CumuRevenueGrowth, RevenueFromAcquisitions, CumuRevenueFromAcquisitions,
                    CumuRevenueShare, RevenueShare_A, RevenueShare_V)


means <- c(NA,NA,NA,NA,NA,mean(exampleDF$CumuRevenueShare, na.rm = T), mean(exampleDF$RevenueShare_A, na.rm = T),
           mean(exampleDF$RevenueShare_V, na.rm = T))

exampleDF <- rbind(exampleDF, means)

rownames(exampleDF)[length(exampleDF$Revenue)] <- "Mean"

```


  T-TEST FOR SALES GROWTH DIFFERENCES

```{r T_TEST}

GrowthTest <- data.frame(SCMatchesNetRevsStandard)

GrowthTest$SaleGrowthPercent <- round(GrowthTest$SaleGrowth / lag(GrowthTest$saleAc),3)

GrowthTest$PreAcquistion <- with(GrowthTest, ifelse(CumuRevAcquired == 0, 0, 1)   )

GrowthTest <- select(GrowthTest, gvkey, conml, AcYear, saleAc, SaleGrowth, SaleGrowthPercent, everything())

GrowthTestMeans <- GrowthTest %>%
  group_by(gvkey, PreAcquistion) %>%
  summarise(AcquirorName = first(AcquirorName), MeanGrowth = mean(na.omit(SaleGrowthPercent)) ) %>%
  filter(!any( n() < 2 )) %>%
  filter(!any(is.na(MeanGrowth)))
  
GrowthTestMeans$MeanGrowth <- ifelse(GrowthTestMeans$PreAcquistion == 0, GrowthTestMeans$MeanGrowth * -1,
                                     GrowthTestMeans$MeanGrowth)

GrowthTestMeans$MeanGrowth <- round(GrowthTestMeans$MeanGrowth,3)

n_distinct(GrowthTestMeans$gvkey)
sum(GrowthTestMeans$PreAcquistion)

GrowthTestMeans <- filter(GrowthTestMeans, !is.na(MeanGrowth))

qqnorm(MeanDiffs)

with(GrowthTestMeans,
     boxplot(MeanGrowth ~ PreAcquistion, data = GrowthTestMeans) ) 

with(GrowthTestMeans,
  t.test(MeanGrowth ~ PreAcquistion, data = GrowthTestMeans, paired = TRUE, var.equal = TRUE) ) 


```






